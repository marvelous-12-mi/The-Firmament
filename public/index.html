<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synq - Social Media</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        dark: '#0f172a',
                        light: '#f8fafc'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
        }
        .post-card {
            transition: all 0.3s ease;
        }
        .post-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .nav-link.active {
            border-bottom: 3px solid #6366f1;
            color: #6366f1;
        }
        .avatar-placeholder {
            background: linear-gradient(45deg, #6366f1, #8b5cf6);
        }
        .loading-spinner {
            border-top-color: #6366f1;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Supabase Client Initialization -->
    <script>
        const supabaseUrl = 'https://qpfjchiucjhfvyohqhih.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZmpjaGl1Y2poZnZ5b2hxaGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDczMjksImV4cCI6MjA3NTQ4MzMyOX0.kcx9Sr7qGbWudJdf155tXg0gWWX6P1RYavo-lKCoQkU';
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    </script>

    <!-- Navigation Bar -->
    <nav class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-6xl mx-auto px-4">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <div class="h-8 w-8 rounded-full bg-indigo-500 flex items-center justify-center">
                            <span class="text-white font-bold">S</span>
                        </div>
                        <span class="ml-2 text-xl font-bold text-gray-900">Synq</span>
                    </div>
                    <div class="hidden md:ml-10 md:flex md:space-x-8">
                        <a href="#" class="nav-link active inline-flex items-center px-1 pt-1 text-sm font-medium">Home</a>
                        <a href="#" class="nav-link inline-flex items-center px-1 pt-1 text-sm font-medium">Explore</a>
                        <a href="#" class="nav-link inline-flex items-center px-1 pt-1 text-sm font-medium">Notifications</a>
                    </div>
                </div>
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <button id="createPostBtn" class="relative inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 shadow-sm hover:bg-indigo-700 focus:outline-none">
                            <i class="fas fa-plus mr-2"></i>
                            <span>Create</span>
                        </button>
                    </div>
                    <div class="ml-4 flex items-center md:ml-6">
                        <div class="ml-3 relative">
                            <div>
                                <button id="userMenuBtn" class="max-w-xs flex items-center text-sm rounded-full focus:outline-none">
                                    <div id="userAvatar" class="h-8 w-8 rounded-full avatar-placeholder flex items-center justify-center">
                                        <span class="text-white text-sm font-medium">U</span>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            <!-- Left Sidebar -->
            <div class="w-full md:w-1/4">
                <div id="profileCard" class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex items-center">
                        <div id="profileAvatar" class="h-16 w-16 rounded-full avatar-placeholder flex items-center justify-center">
                            <span class="text-white text-xl font-bold">U</span>
                        </div>
                        <div class="ml-4">
                            <h2 id="profileName" class="text-lg font-bold text-gray-900">User Name</h2>
                            <p id="profileUsername" class="text-gray-500 text-sm">@username</p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-between text-center">
                        <div>
                            <p id="postsCount" class="text-lg font-bold text-gray-900">0</p>
                            <p class="text-gray-500 text-sm">Posts</p>
                        </div>
                        <div>
                            <p id="followersCount" class="text-lg font-bold text-gray-900">0</p>
                            <p class="text-gray-500 text-sm">Followers</p>
                        </div>
                        <div>
                            <p id="followingCount" class="text-lg font-bold text-gray-900">0</p>
                            <p class="text-gray-500 text-sm">Following</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold text-gray-900 mb-4">Suggested Connections</h3>
                    <div id="suggestedUsers" class="space-y-4">
                        <!-- Suggested users will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Main Feed -->
            <div class="w-full md:w-2/4">
                <!-- Create Post -->
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0 mr-3">
                            <div id="postCreatorAvatar" class="h-10 w-10 rounded-full avatar-placeholder flex items-center justify-center">
                                <span class="text-white font-bold">U</span>
                            </div>
                        </div>
                        <div class="w-full">
                            <textarea id="postContent" class="w-full border border-gray-200 rounded-lg p-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-transparent" placeholder="What's happening?" rows="3"></textarea>
                            <div class="flex justify-between items-center mt-3">
                                <div class="flex space-x-2">
                                    <button class="text-gray-500 hover:text-indigo-600">
                                        <i class="fas fa-image"></i>
                                    </button>
                                    <button class="text-gray-500 hover:text-indigo-600">
                                        <i class="fas fa-smile"></i>
                                    </button>
                                </div>
                                <button id="submitPost" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">Post</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Posts Feed -->
                <div id="postsContainer">
                    <!-- Posts will be loaded here -->
                    <div id="loadingPosts" class="text-center py-10">
                        <div class="loading-spinner w-10 h-10 border-4 border-gray-200 rounded-full mx-auto"></div>
                        <p class="mt-4 text-gray-500">Loading posts...</p>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar -->
            <div class="w-full md:w-1/4">
                <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                    <h3 class="font-bold text-gray-900 mb-4">Trending Topics</h3>
                    <div class="space-y-3">
                        <div>
                            <p class="font-medium text-gray-900">#TravelTuesday</p>
                            <p class="text-xs text-gray-500">12.5K posts</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">#TechNews</p>
                            <p class="text-xs text-gray-500">8.3K posts</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">#FoodieLife</p>
                            <p class="text-xs text-gray-500">6.7K posts</p>
                        </div>
                        <div>
                            <p class="font-medium text-gray-900">#Wellness</p>
                            <p class="text-xs text-gray-500">5.2K posts</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm p-6">
                    <h3 class="font-bold text-gray-900 mb-4">Recent Activity</h3>
                    <div class="space-y-4">
                        <div class="flex items-start">
                            <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
                                <span class="text-white text-xs font-bold">A</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm"><span class="font-medium">Alex</span> liked your post</p>
                                <p class="text-xs text-gray-500">10 min ago</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
                                <span class="text-white text-xs font-bold">M</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm"><span class="font-medium">Maria</span> commented on your post</p>
                                <p class="text-xs text-gray-500">1 hour ago</p>
                            </div>
                        </div>
                        <div class="flex items-start">
                            <div class="h-8 w-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0">
                                <span class="text-white text-xs font-bold">D</span>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm"><span class="font-medium">David</span> started following you</p>
                                <p class="text-xs text-gray-500">3 hours ago</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Welcome to Synq</h3>
                <button id="closeAuthModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="authEmail" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="your@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="authPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="••••••••">
                </div>
                <button id="authSubmit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700">Sign In</button>
                <div class="text-center text-sm text-gray-500">or</div>
                <button id="googleAuth" class="w-full border border-gray-300 py-2 rounded-lg font-medium flex items-center justify-center hover:bg-gray-50">
                    <i class="fab fa-google mr-2 text-red-500"></i>
                    Continue with Google
                </button>
            </div>
            
            <div class="mt-6 text-center text-sm">
                <p>Don't have an account? <a href="#" id="showSignup" class="text-indigo-600 font-medium">Sign up</a></p>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900">Create Account</h3>
                <button id="closeSignupModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                    <input type="text" id="signupName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="Your full name">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                    <input type="text" id="signupUsername" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="Choose a username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="signupEmail" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="your@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                    <input type="password" id="signupPassword" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="••••••••">
                </div>
                <button id="signupSubmit" class="w-full bg-indigo-600 text-white py-2 rounded-lg font-medium hover:bg-indigo-700">Sign Up</button>
            </div>
            
            <div class="mt-6 text-center text-sm">
                <p>Already have an account? <a href="#" id="showLogin" class="text-indigo-600 font-medium">Sign in</a></p>
            </div>
        </div>
    </div>

    <!-- Create Post Modal -->
    <div id="createPostModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg w-full max-w-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-900">Create Post</h3>
                <button id="closePostModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="flex mb-4">
                <div id="modalUserAvatar" class="h-10 w-10 rounded-full avatar-placeholder flex items-center justify-center flex-shrink-0">
                    <span class="text-white font-bold">U</span>
                </div>
                <div class="ml-3">
                    <p id="modalUserName" class="font-medium text-gray-900">User Name</p>
                    <p id="modalUserUsername" class="text-xs text-gray-500">@username</p>
                </div>
            </div>
            
            <textarea id="postModalContent" class="w-full border border-gray-200 rounded-lg p-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-300 focus:border-transparent" placeholder="What's happening?" rows="4"></textarea>
            
            <div class="flex justify-between items-center mt-4">
                <div class="flex space-x-2">
                    <button class="text-gray-500 hover:text-indigo-600">
                        <i class="fas fa-image"></i>
                    </button>
                    <button class="text-gray-500 hover:text-indigo-600">
                        <i class="fas fa-smile"></i>
                    </button>
                </div>
                <button id="submitPostModal" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700">Post</button>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const authModal = document.getElementById('authModal');
        const signupModal = document.getElementById('signupModal');
        const createPostModal = document.getElementById('createPostModal');
        const createPostBtn = document.getElementById('createPostBtn');
        const closeAuthModal = document.getElementById('closeAuthModal');
        const closeSignupModal = document.getElementById('closeSignupModal');
        const closePostModal = document.getElementById('closePostModal');
        const userMenuBtn = document.getElementById('userMenuBtn');
        const submitPost = document.getElementById('submitPost');
        const submitPostModal = document.getElementById('submitPostModal');
        const authSubmit = document.getElementById('authSubmit');
        const signupSubmit = document.getElementById('signupSubmit');
        const googleAuth = document.getElementById('googleAuth');
        const showSignup = document.getElementById('showSignup');
        const showLogin = document.getElementById('showLogin');
        const postsContainer = document.getElementById('postsContainer');
        const loadingPosts = document.getElementById('loadingPosts');
        const suggestedUsers = document.getElementById('suggestedUsers');

        // State
        let currentUser = null;

        // Event Listeners
        createPostBtn.addEventListener('click', () => {
            if (currentUser) {
                createPostModal.classList.remove('hidden');
            } else {
                authModal.classList.remove('hidden');
            }
        });

        closeAuthModal.addEventListener('click', () => {
            authModal.classList.add('hidden');
        });

        closeSignupModal.addEventListener('click', () => {
            signupModal.classList.add('hidden');
        });

        closePostModal.addEventListener('click', () => {
            createPostModal.classList.add('hidden');
        });

        submitPost.addEventListener('click', createPost);
        submitPostModal.addEventListener('click', createPostFromModal);

        authSubmit.addEventListener('click', signIn);
        signupSubmit.addEventListener('click', signUp);
        googleAuth.addEventListener('click', signInWithGoogle);

        showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            authModal.classList.add('hidden');
            signupModal.classList.remove('hidden');
        });

        showLogin.addEventListener('click', (e) => {
            e.preventDefault();
            signupModal.classList.add('hidden');
            authModal.classList.remove('hidden');
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === authModal) {
                authModal.classList.add('hidden');
            }
            if (e.target === signupModal) {
                signupModal.classList.add('hidden');
            }
            if (e.target === createPostModal) {
                createPostModal.classList.add('hidden');
            }
        });

        // Supabase Functions
        async function checkUser() {
            const { data: { user } } = await supabase.auth.getUser();
            if (user) {
                currentUser = user;
                await loadUserProfile();
                await loadPosts();
                await loadSuggestedUsers();
                authModal.classList.add('hidden');
            } else {
                authModal.classList.remove('hidden');
            }
        }

        async function signIn() {
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            
            if (!email || !password) {
                alert('Please fill in all fields');
                return;
            }
            
            const { data, error } = await supabase.auth.signInWithPassword({
                email,
                password
            });
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                currentUser = data.user;
                await loadUserProfile();
                await loadPosts();
                await loadSuggestedUsers();
                authModal.classList.add('hidden');
            }
        }

        async function signUp() {
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const name = document.getElementById('signupName').value;
            const username = document.getElementById('signupUsername').value;
            
            if (!email || !password || !name || !username) {
                alert('Please fill in all fields');
                return;
            }
            
            const { data, error } = await supabase.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: name,
                        username: username
                    }
                }
            });
            
            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Account created! Please check your email for confirmation.');
                signupModal.classList.add('hidden');
            }
        }

        async function signInWithGoogle() {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: window.location.origin
                }
            });
            
            if (error) {
                alert('Error: ' + error.message);
            }
        }

        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                alert('Error: ' + error.message);
            } else {
                currentUser = null;
                window.location.reload();
            }
        }

        async function loadUserProfile() {
            if (!currentUser) return;
            
            const { data, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', currentUser.id)
                .single();
            
            if (error) {
                console.error('Error loading profile:', error);
                return;
            }
            
            // Update UI with profile data
            document.getElementById('profileName').textContent = data.full_name || 'User';
            document.getElementById('profileUsername').textContent = '@' + (data.username || 'username');
            document.getElementById('postsCount').textContent = data.posts_count || 0;
            document.getElementById('followersCount').textContent = data.followers_count || 0;
            document.getElementById('followingCount').textContent = data.following_count || 0;
            
            // Update all avatar placeholders
            const avatars = document.querySelectorAll('.avatar-placeholder span');
            avatars.forEach(avatar => {
                avatar.textContent = (data.full_name || data.username || 'U')[0].toUpperCase();
            });
        }

        async function loadPosts() {
            loadingPosts.classList.remove('hidden');
            
            const { data, error } = await supabase
                .from('posts')
                .select(`
                    id, 
                    content, 
                    created_at,
                    likes_count,
                    comments_count,
                    profiles (full_name, username)
                `)
                .order('created_at', { ascending: false })
                .limit(10);
            
            loadingPosts.classList.add('hidden');
            
            if (error) {
                console.error('Error loading posts:', error);
                postsContainer.innerHTML = '<p class="text-center text-red-500 py-10">Error loading posts</p>';
                return;
            }
            
            if (!data || data.length === 0) {
                postsContainer.innerHTML = '<p class="text-center text-gray-500 py-10">No posts yet. Be the first to post!</p>';
                return;
            }
            
            // Render posts
            postsContainer.innerHTML = data.map(post => `
                <div class="post-card bg-white rounded-xl shadow-sm mb-6">
                    <div class="p-6">
                        <div class="flex items-center">
                            <div class="h-10 w-10 rounded-full avatar-placeholder flex items-center justify-center">
                                <span class="text-white font-bold">${(post.profiles?.full_name || post.profiles?.username || 'U')[0].toUpperCase()}</span>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-bold text-gray-900">${post.profiles?.full_name || 'User'}</h4>
                                <p class="text-xs text-gray-500">@${post.profiles?.username || 'username'} · ${timeAgo(new Date(post.created_at))}</p>
                            </div>
                        </div>
                        <p class="mt-4 text-gray-700">${post.content || ''}</p>
                        <div class="mt-4 flex justify-between text-gray-500">
                            <button class="flex items-center hover:text-indigo-600 like-btn" data-post-id="${post.id}">
                                <i class="far fa-heart mr-1"></i>
                                <span>${post.likes_count || 0}</span>
                            </button>
                            <button class="flex items-center hover:text-indigo-600">
                                <i class="far fa-comment mr-1"></i>
                                <span>${post.comments_count || 0}</span>
                            </button>
                            <button class="flex items-center hover:text-indigo-600">
                                <i class="far fa-share-square mr-1"></i>
                                <span>Share</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add event listeners to like buttons
            document.querySelectorAll('.like-btn').forEach(button => {
                button.addEventListener('click', function() {
                    likePost(this.dataset.postId, this);
                });
            });
        }

        async function loadSuggestedUsers() {
            const { data, error } = await supabase
                .from('profiles')
                .select('id, full_name, username')
                .limit(5);
            
            if (error) {
                console.error('Error loading suggested users:', error);
                return;
            }
            
            suggestedUsers.innerHTML = data.map(user => `
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="h-10 w-10 rounded-full bg-gray-300 flex items-center justify-center">
                            <span class="text-white font-bold">${(user.full_name || user.username || 'U')[0].toUpperCase()}</span>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-gray-900">${user.full_name || 'User'}</p>
                            <p class="text-xs text-gray-500">@${user.username || 'username'}</p>
                        </div>
                    </div>
                    <button class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 follow-btn" data-user-id="${user.id}">
                        Follow
                    </button>
                </div>
            `).join('');
            
            // Add event listeners to follow buttons
            document.querySelectorAll('.follow-btn').forEach(button => {
                button.addEventListener('click', function() {
                    followUser(this.dataset.userId, this);
                });
            });
        }

        async function createPost() {
            const content = document.getElementById('postContent').value;
            if (!content.trim()) return;
            
            const { error } = await supabase
                .from('posts')
                .insert({
                    user_id: currentUser.id,
                    content: content
                });
            
            if (error) {
                alert('Error creating post: ' + error.message);
            } else {
                document.getElementById('postContent').value = '';
                await loadPosts();
                await loadUserProfile();
            }
        }

        async function createPostFromModal() {
            const content = document.getElementById('postModalContent').value;
            if (!content.trim()) return;
            
            const { error } = await supabase
                .from('posts')
                .insert({
                    user_id: currentUser.id,
                    content: content
                });
            
            if (error) {
                alert('Error creating post: ' + error.message);
            } else {
                document.getElementById('postModalContent').value = '';
                createPostModal.classList.add('hidden');
                await loadPosts();
                await loadUserProfile();
            }
        }

        async function likePost(postId, button) {
            // Check if already liked
            const { data: existingLike } = await supabase
                .from('likes')
                .select('id')
                .eq('user_id', currentUser.id)
                .eq('post_id', postId)
                .maybeSingle();
            
            if (existingLike) {
                // Unlike
                const { error } = await supabase
                    .from('likes')
                    .delete()
                    .eq('id', existingLike.id);
                
                if (!error) {
                    const countEl = button.querySelector('span');
                    countEl.textContent = parseInt(countEl.textContent) - 1;
                    button.querySelector('i').className = 'far fa-heart mr-1';
                }
            } else {
                // Like
                const { error } = await supabase
                    .from('likes')
                    .insert({
                        user_id: currentUser.id,
                        post_id: postId
                    });
                
                if (!error) {
                    const countEl = button.querySelector('span');
                    countEl.textContent = parseInt(countEl.textContent) + 1;
                    button.querySelector('i').className = 'fas fa-heart mr-1 text-red-500';
                }
            }
        }

        async function followUser(userId, button) {
            // Check if already following
            const { data: existingFollow } = await supabase
                .from('follows')
                .select('id')
                .eq('follower_id', currentUser.id)
                .eq('following_id', userId)
                .maybeSingle();
            
            if (existingFollow) {
                // Unfollow
                const { error } = await supabase
                    .from('follows')
                    .delete()
                    .eq('id', existingFollow.id);
                
                if (!error) {
                    button.textContent = 'Follow';
                    button.className = 'text-xs bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full hover:bg-indigo-200 follow-btn';
                }
            } else {
                // Follow
                const { error } = await supabase
                    .from('follows')
                    .insert({
                        follower_id: currentUser.id,
                        following_id: userId
                    });
                
                if (!error) {
                    button.textContent = 'Following';
                    button.className = 'text-xs bg-gray-100 text-gray-700 px-3 py-1 rounded-full hover:bg-gray-200 follow-btn';
                }
            }
        }

        // Utility function
        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + "y";
            
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + "mo";
            
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + "d";
            
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + "h";
            
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + "m";
            
            return Math.floor(seconds) + "s";
        }

        // Auth state change listener
        supabase.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                loadUserProfile();
                loadPosts();
                loadSuggestedUsers();
                authModal.classList.add('hidden');
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                window.location.reload();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            checkUser();
        });
    </script>
</body>
</html>
