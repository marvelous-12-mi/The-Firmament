<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synq - Social Media App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6'
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .post-card { transition: all 0.3s ease; }
        .post-card:hover { transform: translateY(-2px); }
        .nav-link.active { color: #6366f1; font-weight: 600; }
        .btn-primary { background: linear-gradient(to right, #6366f1, #8b5cf6); }
        .btn-primary:hover { opacity: 0.9; }
        .like-button.liked { color: #ef4444; }
        .comment-form { transition: max-height 0.3s ease; max-height: 0; overflow: hidden; }
        .comment-form.active { max-height: 200px; }
    </style>
</head>

<body class="min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav class="bg-white shadow-sm py-4 px-6 flex justify-between items-center sticky top-0 z-10">
        <div class="flex items-center space-x-2">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-600 flex items-center justify-center">
                <span class="text-white font-bold text-xl">S</span>
            </div>
            <h1 class="text-2xl font-bold text-slate-800">Synq</h1>
        </div>
        <div class="hidden md:flex space-x-6">
            <button id="nav-feed" class="flex items-center text-indigo-600 font-semibold nav-link">
                <i class="fas fa-home mr-2"></i> Home
            </button>
            <button id="nav-create" class="flex items-center text-slate-600 hover:text-indigo-500 nav-link">
                <i class="fas fa-plus mr-2"></i> Create
            </button>
            <button id="nav-profile" class="flex items-center text-slate-600 hover:text-indigo-500 nav-link">
                <i class="fas fa-user mr-2"></i> Profile
            </button>
        </div>

        <div class="flex items-center space-x-4">
            <div class="flex items-center space-x-2">
                <div class="bg-gray-200 border-2 border-dashed rounded-xl w-8 h-8"></div>
                <span class="hidden md:inline text-slate-800" id="user-email">Not logged in</span>
                <button id="logout-btn" class="text-slate-600 hover:text-slate-900 hidden">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- MOBILE NAV -->
    <div class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 py-3 px-6 flex justify-around z-10">
        <button id="mobile-feed" class="flex flex-col items-center text-indigo-600">
            <i class="fas fa-home"></i><span class="text-xs mt-1">Home</span>
        </button>
        <button id="mobile-create" class="flex flex-col items-center text-slate-600">
            <i class="fas fa-plus"></i><span class="text-xs mt-1">Create</span>
        </button>
        <button id="mobile-profile" class="flex flex-col items-center text-slate-600">
            <i class="fas fa-user"></i><span class="text-xs mt-1">Profile</span>
        </button>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-grow container mx-auto px-4 py-8 pb-20 md:pb-8">

        <!-- AUTH VIEW -->
        <div id="auth-view" class="max-w-md mx-auto">
            <div class="bg-white rounded-xl shadow-md p-8">
                <h2 class="text-2xl font-bold text-center text-slate-800 mb-6" id="auth-title">Join Synq</h2>
                <div id="error-message" class="bg-red-50 text-red-700 p-3 rounded-lg mb-4 hidden"></div>

                <form id="auth-form" class="space-y-4">
                    <div>
                        <label class="block text-gray-700 mb-2">Email</label>
                        <input type="email" id="email-input" class="w-full border p-3 rounded-lg" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-2">Password</label>
                        <input type="password" id="password-input" class="w-full border p-3 rounded-lg" required>
                    </div>

                    <button type="submit" id="auth-submit" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">Sign Up</button>
                </form>

                <div class="text-center mt-4">
                    <p class="text-gray-600">
                        Already have an account?
                        <button id="toggle-auth" class="text-indigo-600 font-semibold">Sign In</button>
                    </p>
                </div>
            </div>
        </div>

        <!-- FEED VIEW -->
        <div id="feed-view" class="max-w-2xl mx-auto hidden">
            <h2 class="text-2xl font-bold mb-6 text-slate-800">Latest Posts</h2>

            <!-- CREATE POST -->
            <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
                <textarea id="post-content" placeholder="What's on your mind?" class="w-full border p-4 rounded-lg" rows="3"></textarea>
                <button id="submit-post" class="btn-primary text-white px-6 py-2 rounded-lg mt-4 float-right">Post</button>
            </div>

            <!-- POSTS -->
            <div id="posts-container">
                <div class="flex justify-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-indigo-500"></div>
                </div>
            </div>
        </div>

        <!-- CREATE VIEW -->
        <div id="create-view" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h2 class="text-2xl font-bold mb-6 text-slate-800">Create New Post</h2>
                <textarea id="create-post-content" class="w-full border p-4 rounded-lg" rows="5"></textarea>
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-create" class="border px-6 py-3 rounded-lg">Cancel</button>
                    <button id="publish-post" class="btn-primary text-white px-6 py-3 rounded-lg">Publish Post</button>
                </div>
            </div>
        </div>

        <!-- PROFILE VIEW -->
        <div id="profile-view" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-32"></div>

                <div class="px-6 pb-6">
                    <div class="flex items-end -mt-16 mb-6">
                        <div class="bg-gray-200 border-4 border-white rounded-xl w-32 h-32"></div>

                        <div class="ml-6 pb-2">
                            <h2 id="profile-username" class="text-2xl font-bold">Loading…</h2>
                            <p id="profile-bio" class="text-gray-600">Loading profile…</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-bold mb-4">Your Posts</h3>
                    <div id="user-posts">
                        <div class="flex justify-center py-8">
                            <div class="animate-spin h-8 w-8 border-t-2 border-indigo-500"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- EDIT PROFILE MODAL -->
        <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
            <div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-md">
                <h3 class="text-xl font-bold mb-4">Edit Profile</h3>
                <input id="edit-username" class="w-full border p-3 mb-3 rounded-lg" placeholder="Username">
                <textarea id="edit-bio" class="w-full border p-3 rounded-lg" rows="3" placeholder="Bio"></textarea>

                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancel-edit" class="border px-4 py-2 rounded-lg">Cancel</button>
                    <button id="save-profile" class="btn-primary text-white px-4 py-2 rounded-lg">Save Changes</button>
                </div>
            </div>
        </div>

    </main>

    <!-- SCRIPT -->
    <script>
        const SUPABASE_URL = "https://qpfjchiucjhfvyohqhih.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9…"; 

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let posts = [];
        let userLikes = new Set();

        const views = {
            auth: document.getElementById('auth-view'),
            feed: document.getElementById('feed-view'),
            create: document.getElementById('create-view'),
            profile: document.getElementById('profile-view')
        };

        /* --------------------------
           NAVIGATION
        ---------------------------*/
        function showView(view) {
            Object.keys(views).forEach(v => views[v].classList.toggle('hidden', v !== view));
        }

        /* --------------------------
           AUTH
        ---------------------------*/
        document.getElementById("auth-form").addEventListener("submit", async (e) => {
            e.preventDefault();

            const email = document.getElementById("email-input").value;
            const password = document.getElementById("password-input").value;

            const { data, error } = await supabase.auth.signUp({ email, password });

            if (error) {
                document.getElementById("error-message").textContent = error.message;
                document.getElementById("error-message").classList.remove("hidden");
                return;
            }

            // auto-create profile
            await supabase.from("profiles").insert({
                id: data.user.id,
                username: email.split("@")[0]
            });

            showView("feed");
        });

        document.getElementById("logout-btn").addEventListener("click", async () => {
            await supabase.auth.signOut();
            showView("auth");
        });

        /* --------------------------
           FETCH POSTS WITH USERNAME
        ---------------------------*/
        async function fetchPosts() {
            const { data, error } = await supabase
                .from("posts")
                .select("id, content, created_at, user_id, profiles(username)")
                .order("created_at", { ascending: false });

            if (!error) posts = data;

            renderPosts();
        }

        /* --------------------------
           RENDER POSTS
        ---------------------------*/
        function renderPosts() {
            const container = document.getElementById("posts-container");
            container.innerHTML = "";

            posts.forEach(post => {
                const el = document.createElement("div");
                el.className = "bg-white rounded-xl shadow-sm p-6 mb-6 post-card";

                el.innerHTML = `
                    <h3 class="font-semibold text-indigo-600 mb-1">
                        ${post.profiles?.username || "Unknown User"}
                    </h3>

                    <p class="text-gray-800 mb-4">${post.content}</p>

                    <div class="flex items-center justify-between text-gray-500">
                        <span>${new Date(post.created_at).toLocaleString()}</span>
                        <button class="like-button" data-post-id="${post.id}">
                            <i class="fas fa-heart mr-1"></i> Like
                        </button>
                    </div>
                `;

                container.appendChild(el);
            });
        }

        /* --------------------------
           CREATE POST
        ---------------------------*/
        document.getElementById("submit-post").addEventListener("click", async () => {
            const content = document.getElementById("post-content").value;
            if (!content.trim()) return;

            await supabase.from("posts").insert({
                content,
                user_id: currentUser.id
            });

            document.getElementById("post-content").value = "";
            fetchPosts();
        });

        /* --------------------------
           SESSION CHECK
        ---------------------------*/
        document.addEventListener("DOMContentLoaded", async () => {
            const { data: { session }} = await supabase.auth.getSession();

            if (session) {
                currentUser = session.user;
                document.getElementById("user-email").textContent = currentUser.email;
                document.getElementById("logout-btn").classList.remove("hidden");
                showView("feed");
                fetchPosts();
            } else {
                showView("auth");
            }
        });
    </script>
</body>
</html>
