<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Synq - Social Media App</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
.post-card { transition: all 0.3s ease; }
.post-card:hover { transform: translateY(-2px); }
.nav-link.active { color: #6366f1; font-weight: 600; }
.btn-primary { background: linear-gradient(to right, #6366f1, #8b5cf6); }
.btn-primary:hover { opacity: 0.9; }
</style>
</head>
<body class="min-h-screen flex flex-col">

<nav class="bg-white shadow-sm py-4 px-6 flex justify-between items-center sticky top-0">
    <h1 class="text-2xl font-bold">Synq</h1>
    <div>
        <span id="user-email">Not logged in</span>
        <button id="logout-btn" class="hidden">Logout</button>
    </div>
</nav>

<main class="flex-grow container mx-auto px-4 py-8">

<!-- Auth -->
<div id="auth-view">
    <h2>Sign Up / Sign In</h2>
    <input type="email" id="email-input" placeholder="Email">
    <input type="password" id="password-input" placeholder="Password">
    <button id="auth-submit">Sign Up / Sign In</button>
</div>

<!-- Feed -->
<div id="feed-view" class="hidden">
    <h2>Feed</h2>
    <div>
        <textarea id="create-post-content" placeholder="What's on your mind?"></textarea>
        <input type="file" id="post-image">
        <button id="publish-post" class="btn-primary">Post</button>
    </div>
    <div id="posts-container"></div>
</div>

<!-- Profile -->
<div id="profile-view" class="hidden">
    <div>
        <img id="profile-avatar" class="w-24 h-24 rounded-full bg-gray-200">
        <h2 id="profile-username"></h2>
        <p id="profile-bio"></p>
        <input type="file" id="profile-image">
        <button id="save-profile" class="btn-primary">Save Profile</button>
    </div>
</div>

</main>

<script>
const SUPABASE_URL = 'https://qpfjchiucjhfvyohqhih.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZmpjaGl1Y2poZnZ5b2hxaGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDczMjksImV4cCI6MjA3NTQ4MzMyOX0.kcx9Sr7qGbWudJdf155tXg0gWWX6P1RYavo-lKCoQkU';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;

// Show/hide views
function showView(view) {
    ['auth', 'feed', 'profile'].forEach(v => {
        document.getElementById(v + '-view').classList.toggle('hidden', v !== view);
    });
}

// Upload files to Supabase
async function uploadFile(file, bucket) {
    if (!file) return null;
    const path = `${currentUser.id}/${Date.now()}_${file.name}`;
    const { error } = await supabase.storage.from(bucket).upload(path, file, { upsert: true });
    if (error) { console.error(error); return null; }
    return supabase.storage.from(bucket).getPublicUrl(path).data.publicUrl;
}

// Auth
document.getElementById('auth-submit').addEventListener('click', async () => {
    const email = document.getElementById('email-input').value;
    const password = document.getElementById('password-input').value;
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) {
        const { data: signUpData, error: signUpError } = await supabase.auth.signUp({ email, password });
        if (signUpError) return alert(signUpError.message);
        currentUser = signUpData.user;
    } else {
        currentUser = data.user;
    }
    document.getElementById('user-email').textContent = currentUser.email;
    showView('feed');
    fetchProfile();
    fetchPosts();
});

// Logout
document.getElementById('logout-btn').addEventListener('click', async () => {
    await supabase.auth.signOut();
    currentUser = null;
    document.getElementById('user-email').textContent = 'Not logged in';
    showView('auth');
});

// Create post
document.getElementById('publish-post').addEventListener('click', async () => {
    const content = document.getElementById('create-post-content').value;
    const fileInput = document.getElementById('post-image');
    let image_url = null;
    if (fileInput.files.length > 0) {
        image_url = await uploadFile(fileInput.files[0], 'synq-media');
    }
    if (!content && !image_url) return;
    await supabase.from('posts').insert({ content, image_url, user_id: currentUser.id });
    document.getElementById('create-post-content').value = '';
    fileInput.value = '';
    fetchPosts();
});

// Save profile
document.getElementById('save-profile').addEventListener('click', async () => {
    const fileInput = document.getElementById('profile-image');
    let avatar_url = null;
    if (fileInput.files.length > 0) {
        avatar_url = await uploadFile(fileInput.files[0], 'synq-profile');
    }
    await supabase.from('profiles').upsert({ id: currentUser.id, avatar_url });
    fetchProfile();
});

// Fetch profile
async function fetchProfile() {
    const { data } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if (!data) return;
    document.getElementById('profile-username').textContent = data.username || 'User';
    document.getElementById('profile-bio').textContent = data.bio || '';
    if (data.avatar_url) document.getElementById('profile-avatar').src = data.avatar_url;
}

// Fetch posts
async function fetchPosts() {
    const { data } = await supabase.from('posts').select('*').order('created_at', { ascending: false });
    const container = document.getElementById('posts-container');
    container.innerHTML = '';
    data.forEach(post => {
        const div = document.createElement('div');
        div.className = 'post-card bg-white p-4 mb-4 rounded shadow';
        div.innerHTML = `<p>${post.content || ''}</p>
                         ${post.image_url ? `<img src="${post.image_url}" class="mt-2 max-w-full rounded">` : ''}`;
        container.appendChild(div);
    });
}
</script>

</body>
</html>
