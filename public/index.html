<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Synq - Diagnostic Mode</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    .logo {
      text-align: center;
      margin-bottom: 30px;
    }
    .logo h1 {
      font-size: 48px;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }
    .input-group input {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }
    .input-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
    }
    .btn {
      width: 100%;
      padding: 16px;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 15px;
    }
    .btn-primary {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
    }
    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }
    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }
    .message {
      padding: 14px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: none;
    }
    .message.error {
      background: #fee;
      color: #c33;
      border: 2px solid #fcc;
    }
    .message.success {
      background: #efe;
      color: #3c3;
      border: 2px solid #cfc;
    }
    .message.info {
      background: #eef;
      color: #33c;
      border: 2px solid #ccf;
    }
    .debug-log {
      background: #f5f5f5;
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 12px;
    }
    .debug-log .log-entry {
      padding: 5px;
      border-bottom: 1px solid #ddd;
    }
    .debug-log .log-entry.error {
      color: #c33;
    }
    .debug-log .log-entry.success {
      color: #3c3;
    }
    .debug-log .log-entry.info {
      color: #33c;
    }
    .hidden {
      display: none;
    }
    .switch-page {
      text-align: center;
      margin-top: 20px;
      color: #666;
    }
    .switch-page a {
      color: #667eea;
      text-decoration: none;
      font-weight: 700;
      cursor: pointer;
    }
    .app-view {
      background: #fafafa;
      min-height: 100vh;
      padding: 20px;
    }
    .post-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .nav-bar {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .create-post {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .create-post textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      resize: vertical;
      min-height: 80px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <!-- Login Page -->
  <div id="loginPage" class="container">
    <div class="logo">
      <h1>Synq</h1>
      <p style="color: #666;">Share Your Moments</p>
    </div>

    <div id="loginMessage" class="message"></div>

    <form id="loginForm">
      <div class="input-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="your@email.com" required>
      </div>
      <div class="input-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="••••••••" required>
      </div>
      <button type="submit" class="btn btn-primary" id="loginBtn">Login</button>
    </form>

    <div class="switch-page">
      Don't have an account? <a id="goToSignup">Sign up</a>
    </div>

    <div class="debug-log" id="loginDebug">
      <strong>Debug Log:</strong>
      <div id="loginDebugEntries"></div>
    </div>
  </div>

  <!-- Signup Page -->
  <div id="signupPage" class="container hidden">
    <div class="logo">
      <h1>Synq</h1>
      <p style="color: #666;">Create Your Account</p>
    </div>

    <div id="signupMessage" class="message"></div>

    <form id="signupForm">
      <div class="input-group">
        <label>Username</label>
        <input type="text" id="signupUsername" placeholder="username" required minlength="3">
      </div>
      <div class="input-group">
        <label>Email</label>
        <input type="email" id="signupEmail" placeholder="your@email.com" required>
      </div>
      <div class="input-group">
        <label>Password</label>
        <input type="password" id="signupPassword" placeholder="••••••••" required minlength="6">
      </div>
      <button type="submit" class="btn btn-primary" id="signupBtn">Create Account</button>
    </form>

    <div class="switch-page">
      Already have an account? <a id="goToLogin">Login</a>
    </div>

    <div class="debug-log" id="signupDebug">
      <strong>Debug Log:</strong>
      <div id="signupDebugEntries"></div>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="app-view hidden">
    <div class="nav-bar">
      <h2 style="margin: 0; color: #667eea; font-weight: 900;">Synq</h2>
      <div>
        <span id="welcomeText" style="margin-right: 20px; font-weight: 600;"></span>
        <button id="logoutBtn" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">Logout</button>
      </div>
    </div>

    <div class="create-post">
      <h3 style="margin-bottom: 15px;">Create Post</h3>
      <textarea id="postContent" placeholder="What's on your mind?"></textarea>
      <button id="createPostBtn" class="btn btn-primary">Share</button>
    </div>

    <div id="postsContainer"></div>
  </div>

  <script>
    // Initialize Supabase
    const supabase = window.supabase.createClient(
      'https://qpfjchiucjhfvyohqhih.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZmpjaGl1Y2poZnZ5b2hxaGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDczMjksImV4cCI6MjA3NTQ4MzMyOX0.kcx9Sr7qGbWudJdf155tXg0gWWX6P1RYavo-lKCoQkU'
    );

    let currentUser = null;

    // Debug logging
    function addDebugLog(page, message, type = 'info') {
      const debugEntries = document.getElementById(page + 'DebugEntries');
      const entry = document.createElement('div');
      entry.className = 'log-entry ' + type;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      debugEntries.appendChild(entry);
      debugEntries.scrollTop = debugEntries.scrollHeight;
      console.log(`[${page}]`, message);
    }

    // Show message
    function showMessage(elementId, message, type) {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'message ' + type;
      el.style.display = 'block';
      setTimeout(() => {
        el.style.display = 'none';
      }, 5000);
    }

    // Check initial auth state
    addDebugLog('login', 'App initialized', 'info');
    addDebugLog('login', 'Checking authentication status...', 'info');

    supabase.auth.getSession().then(({ data: { session }, error }) => {
      if (error) {
        addDebugLog('login', 'Session check error: ' + error.message, 'error');
      }
      if (session) {
        addDebugLog('login', 'Active session found for: ' + session.user.email, 'success');
        currentUser = session.user;
        loadApp();
      } else {
        addDebugLog('login', 'No active session', 'info');
      }
    });

    // Auth state listener
    supabase.auth.onAuthStateChange((event, session) => {
      addDebugLog('login', `Auth event: ${event}`, 'info');
      if (event === 'SIGNED_IN' && session) {
        addDebugLog('login', 'User signed in: ' + session.user.email, 'success');
        currentUser = session.user;
        loadApp();
      } else if (event === 'SIGNED_OUT') {
        addDebugLog('login', 'User signed out', 'info');
        currentUser = null;
        document.getElementById('loginPage').classList.remove('hidden');
        document.getElementById('signupPage').classList.add('hidden');
        document.getElementById('mainApp').classList.add('hidden');
      }
    });

    // Login form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('loginBtn');
      btn.textContent = 'Logging in...';
      btn.disabled = true;
      
      const email = document.getElementById('loginEmail').value.trim();
      const password = document.getElementById('loginPassword').value;
      
      addDebugLog('login', `Attempting login for: ${email}`, 'info');

      try {
        const { data, error } = await supabase.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          addDebugLog('login', 'Login failed: ' + error.message, 'error');
          showMessage('loginMessage', error.message, 'error');
          btn.textContent = 'Login';
          btn.disabled = false;
        } else {
          addDebugLog('login', 'Login successful!', 'success');
          showMessage('loginMessage', 'Login successful!', 'success');
          // Auth state change will handle the rest
        }
      } catch (err) {
        addDebugLog('login', 'Unexpected error: ' + err.message, 'error');
        showMessage('loginMessage', 'An error occurred. Please try again.', 'error');
        btn.textContent = 'Login';
        btn.disabled = false;
      }
    });

    // Signup form
    document.getElementById('signupForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('signupBtn');
      btn.textContent = 'Creating account...';
      btn.disabled = true;
      
      const username = document.getElementById('signupUsername').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const password = document.getElementById('signupPassword').value;
      
      addDebugLog('signup', `Attempting signup for: ${email}`, 'info');

      try {
        // Check username
        addDebugLog('signup', 'Checking if username is available...', 'info');
        const { data: existingUser, error: checkError } = await supabase
          .from('profiles')
          .select('username')
          .eq('username', username)
          .maybeSingle();

        if (checkError && checkError.code !== 'PGRST116') {
          addDebugLog('signup', 'Database error: ' + checkError.message, 'error');
        }

        if (existingUser) {
          addDebugLog('signup', 'Username already taken', 'error');
          showMessage('signupMessage', 'Username already taken', 'error');
          btn.textContent = 'Create Account';
          btn.disabled = false;
          return;
        }

        addDebugLog('signup', 'Username available, creating account...', 'info');

        const { data, error } = await supabase.auth.signUp({
          email: email,
          password: password,
          options: {
            data: { username: username }
          }
        });

        if (error) {
          addDebugLog('signup', 'Signup failed: ' + error.message, 'error');
          showMessage('signupMessage', error.message, 'error');
          btn.textContent = 'Create Account';
          btn.disabled = false;
        } else {
          addDebugLog('signup', 'Account created successfully!', 'success');
          
          if (data.session) {
            addDebugLog('signup', 'Automatically logged in', 'success');
            showMessage('signupMessage', 'Account created! Redirecting...', 'success');
          } else {
            addDebugLog('signup', 'Email confirmation required', 'info');
            showMessage('signupMessage', 'Account created! Check your email to verify.', 'success');
            setTimeout(() => {
              document.getElementById('signupPage').classList.add('hidden');
              document.getElementById('loginPage').classList.remove('hidden');
            }, 3000);
          }
        }
      } catch (err) {
        addDebugLog('signup', 'Unexpected error: ' + err.message, 'error');
        showMessage('signupMessage', 'An error occurred. Please try again.', 'error');
        btn.textContent = 'Create Account';
        btn.disabled = false;
      }
    });

    // Page switching
    document.getElementById('goToSignup').addEventListener('click', () => {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.remove('hidden');
    });

    document.getElementById('goToLogin').addEventListener('click', () => {
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('loginPage').classList.remove('hidden');
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await supabase.auth.signOut();
    });

    // Load app
    async function loadApp() {
      document.getElementById('loginPage').classList.add('hidden');
      document.getElementById('signupPage').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');

      // Get or create profile
      const { data: profile } = await supabase
        .from('profiles')
        .select('username')
        .eq('id', currentUser.id)
        .single();

      const username = profile?.username || currentUser.user_metadata?.username || 'User';
      
      document.getElementById('welcomeText').textContent = `Welcome, ${username}!`;
      
      loadPosts();
    }

    // Create post
    document.getElementById('createPostBtn').addEventListener('click', async () => {
      const content = document.getElementById('postContent').value.trim();
      if (!content) return;

      await supabase.from('posts').insert([{
        user_id: currentUser.id,
        content: content
      }]);

      document.getElementById('postContent').value = '';
      loadPosts();
    });

    // Load posts
    async function loadPosts() {
      const { data: posts } = await supabase
        .from('posts')
        .select(`
          *,
          profiles(username)
        `)
        .order('created_at', { ascending: false });

      const container = document.getElementById('postsContainer');
      
      if (!posts || posts.length === 0) {
        container.innerHTML = '<div class="post-card"><p style="text-align:center;color:#999;">No posts yet. Be the first to share!</p></div>';
        return;
      }

      container.innerHTML = posts.map(post => `
        <div class="post-card">
          <strong>${post.profiles?.username || 'User'}</strong>
          <p style="margin-top: 10px;">${escapeHtml(post.content)}</p>
          <small style="color:#999;">${new Date(post.created_at).toLocaleString()}</small>
        </div>
      `).join('');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
