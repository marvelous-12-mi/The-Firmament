<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Synq — Supabase Instagram Clone (A)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Supabase JS -->
  <script src="https://unpkg.com/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');
    :root {
      --bg:#fafafa;
      --card:#ffffff;
      --muted:#889;
      --text:#111827;
      --primary:#405DE6;
      --accent:#833AB4;
    }
    body { font-family: 'Roboto', sans-serif; background:var(--bg); color:var(--text); }
    .avatar-placeholder { background: linear-gradient(45deg, #405DE6, #5851DB, #833AB4, #C13584); }
    .story-ring { background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888); }
    .post-card{ transition: all .18s ease; }
    .post-card:hover{ transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.06); }
    .notification-badge{ position:absolute; top:-5px; right:-5px; background:#ED4956; color:#fff; border-radius:50%; width:18px; height:18px; font-size:10px; display:flex; align-items:center; justify-content:center; }
  </style>
</head>
<body class="bg-gray-50">

<!-- 
  IMPORTANT SQL (run in Supabase SQL editor before using the app)
  -----------------------------------------------------------------
  -- Drop old tables (optional)
  drop table if exists likes cascade;
  drop table if exists comments cascade;
  drop table if exists posts cascade;
  drop table if exists profiles cascade;
  drop table if exists follows cascade;

  -- Profiles
  create table profiles (
    id uuid primary key references auth.users(id) on delete cascade,
    username text,
    avatar_url text,
    created_at timestamp with time zone default now()
  );

  -- Posts
  create table posts (
    id bigint generated always as identity primary key,
    user_id uuid references auth.users(id) on delete cascade,
    image_url text,
    caption text,
    created_at timestamp with time zone default now()
  );

  -- Likes
  create table likes (
    id bigint generated always as identity primary key,
    post_id bigint references posts(id) on delete cascade,
    user_id uuid references auth.users(id) on delete cascade,
    created_at timestamp with time zone default now(),
    unique(post_id, user_id)
  );

  -- Comments
  create table comments (
    id bigint generated always as identity primary key,
    post_id bigint references posts(id) on delete cascade,
    user_id uuid references auth.users(id) on delete cascade,
    comment text,
    created_at timestamp with time zone default now()
  );

  -- Follows (optional)
  create table follows (
    id bigint generated always as identity primary key,
    follower uuid references auth.users(id) on delete cascade,
    following uuid references auth.users(id) on delete cascade,
    created_at timestamp with time zone default now(),
    unique(follower, following)
  );

  -- Enable RLS and add safe policies (example)
  alter table profiles enable row level security;
  alter table posts enable row level security;
  alter table likes enable row level security;
  alter table comments enable row level security;
  alter table follows enable row level security;

  -- Simple policies (adjust to your needs):
  create policy "Profiles: read all" on profiles for select using (true);
  create policy "Profiles: insert own" on profiles for insert with check (auth.uid() = id);
  create policy "Profiles: update own" on profiles for update using (auth.uid() = id);

  create policy "Posts: read all" on posts for select using (true);
  create policy "Posts: insert own" on posts for insert with check (auth.uid() = user_id);
  create policy "Posts: delete own" on posts for delete using (auth.uid() = user_id);
  create policy "Posts: update own" on posts for update using (auth.uid() = user_id);

  create policy "Likes: read" on likes for select using (true);
  create policy "Likes: insert own" on likes for insert with check (auth.uid() = user_id);
  create policy "Likes: delete own" on likes for delete using (auth.uid() = user_id);

  create policy "Comments: read" on comments for select using (true);
  create policy "Comments: insert own" on comments for insert with check (auth.uid() = user_id);

  create policy "Follows: read" on follows for select using (true);
  create policy "Follows: insert own" on follows for insert with check (auth.uid() = follower);
  create policy "Follows: delete own" on follows for delete using (auth.uid() = follower);

  -- Create a public storage bucket named `post-images` and set it to public
  -----------------------------------------------------------------
-->

<!-- NAV -->
<nav class="bg-white border-b border-gray-300 fixed top-0 w-full z-50">
  <div class="max-w-5xl mx-auto px-4">
    <div class="flex justify-between h-16 items-center">
      <!-- Logo -->
      <div class="flex items-center">
        <div class="flex-shrink-0 flex items-center">
          <div class="h-8 w-8 rounded-lg bg-gradient-to-r from-primary to-accent flex items-center justify-center">
            <span class="text-white font-bold text-xl">S</span>
          </div>
          <span class="ml-2 text-xl font-bold bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">Synq</span>
        </div>
      </div>

      <!-- Search (not hooked) -->
      <div class="hidden md:flex items-center">
        <div class="relative">
          <input id="searchBox" type="text" placeholder="Search username" class="bg-gray-100 rounded-md px-4 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary w-64">
          <i class="fas fa-search absolute right-3 top-2.5 text-gray-400"></i>
        </div>
      </div>

      <!-- Nav Icons -->
      <div class="flex items-center space-x-5">
        <a href="#" class="text-2xl text-gray-800 nav-link active">
          <i class="fas fa-home"></i>
        </a>
        <button id="openUploadBtn" class="text-2xl text-gray-500 nav-link">
          <i class="far fa-plus-square"></i>
        </button>

        <div id="authArea" class="flex items-center space-x-3">
          <!-- shown when logged out -->
          <button id="openAuthBtn" class="px-3 py-1 rounded bg-blue-500 text-white text-sm">Log in</button>

          <!-- shown when logged in -->
          <div id="userMenu" class="hidden items-center gap-3">
            <div id="navNotifications" class="relative text-2xl text-gray-500">
              <i class="far fa-paper-plane"></i>
              <span class="notification-badge" style="display:none" id="notifCount">0</span>
            </div>

            <div id="navAvatar" class="h-8 w-8 rounded-full avatar-placeholder flex items-center justify-center text-white text-sm cursor-pointer">U</div>
            <button id="logoutBtn" class="text-sm text-gray-700 hidden">Logout</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<!-- AUTH MODAL -->
<div id="authModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white p-6 rounded-xl w-80">
    <h2 class="text-xl font-bold mb-3">Login or Sign up</h2>
    <input id="authEmail" type="email" placeholder="Email" class="w-full mb-2 p-2 border rounded">
    <input id="authPassword" type="password" placeholder="Password" class="w-full mb-3 p-2 border rounded">
    <div class="flex gap-2">
      <button id="loginBtn" class="w-1/2 bg-blue-600 text-white p-2 rounded">Login</button>
      <button id="signupBtn" class="w-1/2 bg-green-600 text-white p-2 rounded">Sign Up</button>
    </div>
    <p class="text-xs text-gray-500 mt-3">Or click "Send magic link" to sign in with email only.</p>
    <button id="magicBtn" class="mt-2 w-full p-2 rounded border">Send magic link</button>
    <div class="text-right mt-2">
      <button id="closeAuth" class="text-sm text-gray-500">Close</button>
    </div>
  </div>
</div>

<!-- UPLOAD MODAL -->
<div id="uploadModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-40">
  <div class="bg-white w-96 p-4 rounded-xl">
    <h3 class="font-bold text-lg mb-2">Create Post</h3>
    <input id="postFile" type="file" accept="image/*" class="mb-3" />
    <textarea id="postCaption" placeholder="Write a caption..." class="w-full p-2 border rounded h-24 mb-2"></textarea>
    <div class="flex gap-2">
      <button id="createPostBtn" class="flex-1 bg-blue-600 text-white p-2 rounded">Upload</button>
      <button id="closeUpload" class="flex-1 p-2 rounded border">Cancel</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="max-w-5xl mx-auto pt-20 pb-10">
  <div class="flex flex-col md:flex-row gap-6">
    <!-- Left/Main -->
    <div class="w-full md:w-2/3">
      <!-- Stories -->
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6 overflow-x-auto">
        <div class="flex space-x-4">
          <div class="flex flex-col items-center">
            <div class="story-ring p-0.5 rounded-full">
              <div class="bg-white p-0.5 rounded-full">
                <div class="h-16 w-16 rounded-full bg-gray-200 flex items-center justify-center">
                  <i class="fas fa-plus text-gray-500"></i>
                </div>
              </div>
            </div>
            <span class="text-xs mt-1 text-gray-500">Your story</span>
          </div>
          <!-- placeholder story icons (we will keep them static) -->
          <div class="flex flex-col items-center">
            <div class="story-ring p-0.5 rounded-full">
              <div class="bg-white p-0.5 rounded-full">
                <div class="h-16 w-16 rounded-full bg-gray-200 flex items-center justify-center">
                  <span class="text-white font-bold">A</span>
                </div>
              </div>
            </div>
            <span class="text-xs mt-1 text-gray-800">Alex</span>
          </div>
          <div class="flex flex-col items-center">
            <div class="story-ring p-0.5 rounded-full">
              <div class="bg-white p-0.5 rounded-full">
                <div class="h-16 w-16 rounded-full bg-gray-200 flex items-center justify-center">
                  <span class="text-white font-bold">M</span>
                </div>
              </div>
            </div>
            <span class="text-xs mt-1 text-gray-800">Maria</span>
          </div>
        </div>
      </div>

      <!-- Posts -->
      <div id="postsContainer">
        <!-- existing static posts will be replaced by JS -->
      </div>
    </div>

    <!-- Right Sidebar -->
    <div class="w-full md:w-1/3">
      <div class="bg-white rounded-lg shadow-sm p-4 mb-6">
        <div class="flex items-center">
          <div id="profileAvatar" class="h-16 w-16 rounded-full avatar-placeholder flex items-center justify-center">
            <span class="text-white text-xl font-bold">U</span>
          </div>
          <div class="ml-4">
            <h2 id="profileUsername" class="font-bold text-gray-900">username</h2>
            <p id="profileFull" class="text-gray-500 text-sm">User Name</p>
          </div>
          <div class="ml-auto">
            <button id="editProfileBtn" class="text-blue-500 text-sm font-medium hidden">Edit</button>
          </div>
        </div>
        <div class="flex justify-between mt-6">
          <div class="text-center">
            <p id="statPosts" class="font-bold">0</p>
            <p class="text-gray-500 text-sm">Posts</p>
          </div>
          <div class="text-center">
            <p id="statFollowers" class="font-bold">0</p>
            <p class="text-gray-500 text-sm">Followers</p>
          </div>
          <div class="text-center">
            <p id="statFollowing" class="font-bold">0</p>
            <p class="text-gray-500 text-sm">Following</p>
          </div>
        </div>
      </div>

      <div class="bg-white rounded-lg shadow-sm p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-bold text-gray-500">Suggestions For You</h3>
          <a href="#" class="text-xs font-medium">See All</a>
        </div>
        <div id="suggestionsList" class="space-y-4">
          <!-- suggestions will be loaded -->
        </div>
      </div>

      <div class="mt-6 text-xs text-gray-400">
        <div class="flex flex-wrap">
          <a href="#" class="mr-2 mb-1">About</a>
          <a href="#" class="mr-2 mb-1">Help</a>
          <a href="#" class="mr-2 mb-1">Press</a>
        </div>
        <p class="mt-2">© 2025 SYNQ</p>
      </div>
    </div>
  </div>
</div>

<!-- Comment / Caption templates and tiny helper -->
<template id="postTemplate">
  <div class="post-card bg-white rounded-lg shadow-sm mb-6">
    <div class="p-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="h-10 w-10 rounded-full avatar-placeholder flex items-center justify-center">
            <span class="text-white font-bold">U</span>
          </div>
          <div class="ml-3">
            <h4 class="text-sm font-bold text-gray-900 username">username</h4>
            <div class="text-xs text-gray-500 time">just now</div>
          </div>
        </div>
        <button class="text-gray-500 postMenuBtn">
          <i class="fas fa-ellipsis-h"></i>
        </button>
      </div>
    </div>

    <div class="bg-gray-200 border-2 border-dashed w-full h-96 imageWrap"></div>

    <div class="p-4">
      <div class="flex justify-between mb-2">
        <div class="flex space-x-4">
          <button class="likeBtn text-2xl text-gray-800">
            <i class="far fa-heart"></i>
          </button>
          <button class="commentOpenBtn text-2xl text-gray-800">
            <i class="far fa-comment"></i>
          </button>
          <button class="shareBtn text-2xl text-gray-800">
            <i class="far fa-paper-plane"></i>
          </button>
        </div>
        <button class="bookmarkBtn text-2xl text-gray-800">
          <i class="far fa-bookmark"></i>
        </button>
      </div>

      <div class="mb-2">
        <p class="font-bold text-sm likesCount">0 likes</p>
      </div>

      <div class="mb-2 caption"><p class="text-sm"><span class="font-bold mr-2">username</span>Caption</p></div>

      <div class="text-gray-500 text-sm mb-2 commentsPreview">View comments</div>

      <div class="commentArea flex items-center hidden">
        <div class="h-8 w-8 rounded-full avatar-placeholder flex items-center justify-center flex-shrink-0">
          <span class="text-white text-xs font-bold">U</span>
        </div>
        <input type="text" class="ml-2 w-full text-sm focus:outline-none commentInput" placeholder="Add a comment...">
        <button class="text-blue-500 font-medium text-sm ml-2 postCommentBtn">Post</button>
      </div>
    </div>
  </div>
</template>

<script>
  // ---------------------------
  //  ADD YOUR SUPABASE KEYS HERE
  // ---------------------------
  const SUPABASE_URL = "https://qpfjchiucjhfvyohqhih.supabase.co";
  const SUPABASE_ANON = eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZmpjaGl1Y2poZnZ5b2hxaGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDczMjksImV4cCI6MjA3NTQ4MzMyOX0.kcx9Sr7qGbWudJdf155tXg0gWWX6P1RYavo-lKCoQkU";
  if (SUPABASE_URL.includes("YOUR") || SUPABASE_ANON.includes("YOUR")) {
    console.warn("Please set SUPABASE_URL and SUPABASE_ANON at the top of the HTML file.");
  }
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // DOM refs
  const postsContainer = document.getElementById('postsContainer');
  const authModal = document.getElementById('authModal');
  const openAuthBtn = document.getElementById('openAuthBtn');
  const closeAuth = document.getElementById('closeAuth');
  const loginBtn = document.getElementById('loginBtn');
  const signupBtn = document.getElementById('signupBtn');
  const magicBtn = document.getElementById('magicBtn');
  const authEmail = document.getElementById('authEmail');
  const authPassword = document.getElementById('authPassword');

  const openUploadBtn = document.getElementById('openUploadBtn');
  const uploadModal = document.getElementById('uploadModal');
  const closeUpload = document.getElementById('closeUpload');
  const createPostBtn = document.getElementById('createPostBtn');
  const postFile = document.getElementById('postFile');
  const postCaption = document.getElementById('postCaption');

  const navAvatar = document.getElementById('navAvatar');
  const userMenu = document.getElementById('userMenu');
  const authArea = document.getElementById('authArea');
  const logoutBtn = document.getElementById('logoutBtn');

  const profileAvatar = document.getElementById('profileAvatar');
  const profileUsername = document.getElementById('profileUsername');
  const profileFull = document.getElementById('profileFull');
  const editProfileBtn = document.getElementById('editProfileBtn');
  const statPosts = document.getElementById('statPosts');

  const suggestionsList = document.getElementById('suggestionsList');

  const postTemplate = document.getElementById('postTemplate');

  let currentUser = null;
  let userProfile = null;

  // Utility: human-readable times
  function humanTime(ts) {
    if(!ts) return '';
    const d = new Date(ts);
    const diff = Math.floor((Date.now() - d.getTime())/1000);
    if(diff < 60) return `${diff}s`;
    if(diff < 3600) return `${Math.floor(diff/60)}m`;
    if(diff < 86400) return `${Math.floor(diff/3600)}h`;
    return d.toLocaleDateString();
  }

  // Hook UI
  openAuthBtn.addEventListener('click', ()=> authModal.classList.remove('hidden'));
  closeAuth.addEventListener('click', ()=> authModal.classList.add('hidden'));
  openUploadBtn.addEventListener('click', async ()=> {
    if(!currentUser) { authModal.classList.remove('hidden'); return; }
    uploadModal.classList.remove('hidden');
  });
  closeUpload.addEventListener('click', ()=> uploadModal.classList.add('hidden'));
  logoutBtn.addEventListener('click', async ()=> {
    await supabase.auth.signOut();
    location.reload();
  });

  // Auth: login / signup / magic link
  loginBtn.addEventListener('click', async ()=> {
    const email = authEmail.value;
    const password = authPassword.value;
    if(!email || !password) return alert('enter email + password');
    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error) return alert(error.message);
    authModal.classList.add('hidden');
    await onAuthChange();
  });

  signupBtn.addEventListener('click', async ()=> {
    const email = authEmail.value;
    const password = authPassword.value;
    if(!email || !password) return alert('enter email + password');
    const { data, error } = await supabase.auth.signUp({ email, password });
    if(error) return alert(error.message);
    alert('Account created — check email for confirmation (if required). Now login.');
  });

  magicBtn.addEventListener('click', async ()=> {
    const email = authEmail.value;
    if(!email) return alert('enter email');
    const { data, error } = await supabase.auth.signInWithOtp({ email });
    if(error) return alert(error.message);
    alert('Magic link sent to ' + email);
    authModal.classList.add('hidden');
  });

  // On page load: check auth
  (async function init() {
    const { data } = await supabase.auth.getUser();
    if(data && data.user) {
      currentUser = data.user;
      await ensureProfile();
      showLoggedInUI();
    } else {
      showLoggedOutUI();
    }
    await loadSuggestions();
    await loadPosts();
    // subscribe to auth changes
    supabase.auth.onAuthStateChange(async (event, session) => {
      if(session && session.user) {
        currentUser = session.user;
        await ensureProfile();
        showLoggedInUI();
        await loadPosts(true);
      } else {
        currentUser = null;
        userProfile = null;
        showLoggedOutUI();
        await loadPosts(true);
      }
    });
  })();

  // Create profile row if missing
  async function ensureProfile() {
    if(!currentUser) return;
    const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if(data) {
      userProfile = data;
    } else {
      // create minimal profile
      const username = currentUser.email.split('@')[0];
      const { data: p } = await supabase.from('profiles').insert([{ id: currentUser.id, username }]).select().single();
      userProfile = p;
    }
    updateProfileUI();
  }

  function showLoggedInUI(){
    authArea.querySelector('#openAuthBtn').style.display = 'none';
    userMenu.classList.remove('hidden');
    logoutBtn.classList.remove('hidden');
    navAvatar.textContent = (userProfile?.username?.[0] || currentUser?.email?.[0] || 'U').toUpperCase();
  }

  function showLoggedOutUI(){
    authArea.querySelector('#openAuthBtn').style.display = 'inline-block';
    userMenu.classList.add('hidden');
    logoutBtn.classList.add('hidden');
    navAvatar.textContent = 'U';
    profileAvatar.querySelector('span') && (profileAvatar.querySelector('span').textContent = 'U');
    profileUsername.textContent = 'username';
  }

  function updateProfileUI(){
    profileUsername.textContent = userProfile?.username || currentUser?.email.split('@')[0];
    profileFull.textContent = currentUser?.email || '';
    profileAvatar.querySelector('span') && (profileAvatar.querySelector('span').textContent = (userProfile?.username?.[0] || currentUser?.email?.[0] || 'U').toUpperCase());
    navAvatar.textContent = (userProfile?.username?.[0] || currentUser?.email?.[0] || 'U').toUpperCase();
  }

  // Upload post
  createPostBtn.addEventListener('click', async ()=> {
    if(!currentUser) { authModal.classList.remove('hidden'); return; }
    const file = postFile.files[0];
    const caption = postCaption.value || '';
    if(!file) return alert('Choose an image.');
    const fileExt = file.name.split('.').pop();
    const fileName = `${Date.now()}_${Math.random().toString(36).slice(2)}.${fileExt}`;
    // upload to storage
    const { error: upErr } = await supabase.storage.from('post-images').upload(fileName, file, { cacheControl: '3600', upsert: false });
    if(upErr) return alert('Upload failed: ' + upErr.message);
    // get public url
    const { data: urlData } = await supabase.storage.from('post-images').getPublicUrl(fileName);
    const imageUrl = urlData.publicUrl;
    // insert post row
    const { error: postErr } = await supabase.from('posts').insert([{ user_id: currentUser.id, image_url: imageUrl, caption }]);
    if(postErr) return alert('Create post failed: ' + postErr.message);
    postFile.value = '';
    postCaption.value = '';
    uploadModal.classList.add('hidden');
    await loadPosts(true);
  });

  // Load suggestions (small sample of profiles)
  async function loadSuggestions() {
    const { data } = await supabase.from('profiles').select('id,username').limit(6);
    suggestionsList.innerHTML = '';
    if(!data) return;
    data.forEach(u => {
      const div = document.createElement('div');
      div.className = 'flex items-center justify-between';
      div.innerHTML = `
        <div class="flex items-center">
          <div class="h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center mr-3">${(u.username||'U')[0].toUpperCase()}</div>
          <div>
            <p class="text-sm font-medium">${u.username}</p>
            <p class="text-xs text-gray-400">Suggested</p>
          </div>
        </div>
        <button class="text-blue-500 text-xs followBtn" data-user="${u.id}">Follow</button>
      `;
      suggestionsList.appendChild(div);
      div.querySelector('.followBtn').addEventListener('click', async (e) => {
        if(!currentUser) { authModal.classList.remove('hidden'); return; }
        const targetId = e.target.dataset.user;
        // upsert into follows
        await supabase.from('follows').insert([{ follower: currentUser.id, following: targetId }]).catch(()=>{});
        alert('Following!');
      });
    });
  }

  // Load posts (reset = true will flush container)
  async function loadPosts(reset=false) {
    if(reset) postsContainer.innerHTML = '';
    // read posts with profiles join
    const { data, error } = await supabase.from('posts').select('id, user_id, image_url, caption, created_at, profiles(username)').order('created_at', { ascending: false });
    if(error) return console.error(error);
    postsContainer.innerHTML = '';
    if(!data || data.length===0) {
      postsContainer.innerHTML = '<div class="p-6 bg-white rounded-lg">No posts yet</div>';
      return;
    }
    data.forEach(p => renderPost(p));
  }

  // Render a single post using the template
  function renderPost(p) {
    const temp = postTemplate.content.cloneNode(true);
    const card = temp.querySelector('.post-card');
    // header username & time
    card.querySelector('.username').textContent = p.profiles?.username || (p.user_id ? p.user_id.slice(0,6) : 'User');
    card.querySelector('.time').textContent = humanTime(p.created_at);
    // image
    const imgWrap = card.querySelector('.imageWrap');
    imgWrap.innerHTML = `<img src="${p.image_url}" alt="post image" class="w-full h-96 object-cover">`;
    // likes count element
    const likesCount = card.querySelector('.likesCount');
    likesCount.textContent = '...';
    // caption
    const captionNode = card.querySelector('.caption p');
    captionNode.innerHTML = `<span class="font-bold mr-2">${p.profiles?.username || 'User'}</span>${escapeHtml(p.caption || '')}`;

    // comments preview (will show first 2)
    const commentsPreview = card.querySelector('.commentsPreview');
    commentsPreview.textContent = 'Loading comments...';

    // buttons
    const likeBtn = card.querySelector('.likeBtn i');
    const bookmarkBtn = card.querySelector('.bookmarkBtn i');
    const commentOpenBtn = card.querySelector('.commentOpenBtn');
    const commentArea = card.querySelector('.commentArea');
    const postCommentBtn = card.querySelector('.postCommentBtn');

    // bind comment toggle
    commentOpenBtn.addEventListener('click', ()=> {
      commentArea.classList.toggle('hidden');
      if(!commentArea.classList.contains('hidden')) loadCommentsFor(p.id, card);
    });

    // post comment
    postCommentBtn.addEventListener('click', async ()=> {
      if(!currentUser) { authModal.classList.remove('hidden'); return; }
      const input = card.querySelector('.commentInput');
      if(!input.value.trim()) return;
      await supabase.from('comments').insert([{ post_id: p.id, user_id: currentUser.id, comment: input.value.trim() }]);
      input.value = '';
      await loadCommentsFor(p.id, card);
      await loadLikesCount(p.id, likesCount); // not necessary but keeps UI fresh
    });

    // like action
    card.querySelector('.likeBtn').addEventListener('click', async ()=> {
      if(!currentUser) { authModal.classList.remove('hidden'); return; }
      // check existing
      const { data: existing } = await supabase.from('likes').select('*').eq('post_id', p.id).eq('user_id', currentUser.id);
      if(existing && existing.length > 0) {
        await supabase.from('likes').delete().eq('id', existing[0].id);
      } else {
        await supabase.from('likes').insert([{ post_id: p.id, user_id: currentUser.id }]);
      }
      await loadLikesCount(p.id, likesCount);
    });

    // menu (edit/delete) for owner - basic
    const postMenuBtn = card.querySelector('.postMenuBtn');
    postMenuBtn.addEventListener('click', async ()=> {
      if(!currentUser) { authModal.classList.remove('hidden'); return; }
      if(currentUser.id === p.user_id) {
        if(confirm('Delete post?')) {
          await supabase.from('posts').delete().eq('id', p.id);
          card.remove();
        }
      } else {
        alert('Post options (report etc).');
      }
    });

    // insert card into DOM
    postsContainer.appendChild(card);

    // load likes count & whether this user liked
    loadLikesCount(p.id, likesCount);

    // load comments preview
    loadCommentsPreview(p.id, commentsPreview);

    // update stats (we can update counts for profile)
    updateProfileStats();
  }

  // load comments preview (first 2)
  async function loadCommentsPreview(postId, previewNode) {
    const { data } = await supabase.from('comments').select('id, comment, created_at, profiles(username)').eq('post_id', postId).order('created_at', { ascending: false }).limit(2);
    if(!data || data.length===0) {
      previewNode.textContent = 'Be the first to comment';
      return;
    }
    previewNode.innerHTML = data.slice().reverse().map(c => `<span class="font-semibold">${c.profiles?.username || 'User'}</span> ${escapeHtml(c.comment)}`).join('<br>');
  }

  // load all comments into the comment area of a post card
  async function loadCommentsFor(postId, card) {
    const { data } = await supabase.from('comments').select('id, comment, created_at, profiles(username)').eq('post_id', postId).order('created_at', { ascending: true });
    const list = card.querySelector('.commentArea');
    const commentsList = card.querySelector('#commentsList');
    // we will place comments inside the comment area above input
    let container = card.querySelector('.commentAreaList');
    if(!container) {
      container = document.createElement('div');
      container.className = 'mb-2 commentAreaList';
      card.querySelector('.commentArea').insertBefore(container, card.querySelector('.commentArea').firstChild);
    }
    container.innerHTML = '';
    if(!data || data.length===0) {
      container.innerHTML = '<div class="text-sm text-gray-500">No comments yet</div>';
      return;
    }
    data.forEach(c => {
      const d = document.createElement('div');
      d.className = 'text-sm mb-1';
      d.innerHTML = `<span class="font-semibold">${c.profiles?.username || 'User'}</span> ${escapeHtml(c.comment)} <span class="text-gray-400 text-xs"> · ${humanTime(c.created_at)}</span>`;
      container.appendChild(d);
    });
  }

  // load likes count
  async function loadLikesCount(postId, node) {
    const { data } = await supabase.from('likes').select('id, user_id').eq('post_id', postId);
    const count = data ? data.length : 0;
    node.textContent = `${count} likes`;
  }

  // update profile counts (simple)
  async function updateProfileStats() {
    if(!userProfile) return;
    const { data } = await supabase.from('posts').select('id', { count: 'exact', head: false }).eq('user_id', userProfile.id);
    statPosts.textContent = data?.length || 0;
  }

  // utility: escape HTML
  function escapeHtml(text) {
    if(!text) return '';
    return text.replace(/[&<>"']/g, (m)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[m]));
  }

  // load comments for a post id (helper)
  async function loadComments(postId) {
    const cards = Array.from(postsContainer.querySelectorAll('.post-card'));
    for(const c of cards) {
      // find if it's the right post by comparing inner image src
    }
  }

  // small helper: refresh feed (call after actions)
  async function refreshFeed() {
    await loadPosts(true);
  }

  // helper: humanTime helper is defined above

  // Escape-friendly console
  function safeLog(...args) { try { console.log(...args); } catch(e) {} }

</script>

</body>
</html>
