<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Synq - Social Media App</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    primary: '#6366f1',
                    secondary: '#8b5cf6'
                }
            }
        }
    }
</script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
.post-card { transition: all 0.3s ease; }
.post-card:hover { transform: translateY(-2px); }
.nav-link.active { color: #6366f1; font-weight: 600; }
.btn-primary { background: linear-gradient(to right, #6366f1, #8b5cf6); }
.btn-primary:hover { opacity: 0.9; }
.like-button.liked { color: #ef4444; }
.comment-form { transition: max-height 0.3s ease; max-height: 0; overflow: hidden; }
.comment-form.active { max-height: 200px; }
</style>
</head>
<body class="min-h-screen flex flex-col">

<!-- Navigation omitted for brevity; same as your original code -->

<main class="flex-grow container mx-auto px-4 py-8 pb-20 md:pb-8">
    <!-- Auth View omitted (same) -->

    <!-- Feed View omitted (same) -->

    <!-- Create Post View -->
    <div id="create-view" class="max-w-2xl mx-auto hidden">
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h2 class="text-2xl font-bold text-slate-800 mb-6">Create New Post</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-gray-700 mb-2">Post Content</label>
                    <textarea id="create-post-content" placeholder="Share your thoughts..." class="w-full border border-gray-300 rounded-lg p-4 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" rows="5"></textarea>
                </div>
                
                <div>
                    <label class="block text-gray-700 mb-2">Add Image</label>
                    <input type="file" id="post-image" class="w-full" />
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button id="cancel-create" class="border border-gray-300 text-gray-700 px-6 py-3 rounded-lg font-semibold hover:bg-gray-50 transition">Cancel</button>
                    <button id="publish-post" class="btn-primary text-white px-6 py-3 rounded-lg font-semibold hover:opacity-90 transition">Publish Post</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Profile View omitted (same) -->

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-md">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Edit Profile</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 mb-2">Username</label>
                    <input type="text" id="edit-username" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Your username" />
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">Bio</label>
                    <textarea id="edit-bio" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-transparent" placeholder="Tell us about yourself" rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-gray-700 mb-2">Profile Picture</label>
                    <input type="file" id="profile-image" class="w-full" />
                </div>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button id="cancel-edit" class="border border-gray-300 text-gray-700 px-4 py-2 rounded-lg font-semibold hover:bg-gray-50 transition">Cancel</button>
                <button id="save-profile" class="btn-primary text-white px-4 py-2 rounded-lg font-semibold hover:opacity-90 transition">Save Changes</button>
            </div>
        </div>
    </div>
</main>

<script>
const SUPABASE_URL = 'https://qpfjchiucjhfvyohqhih.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFwZmpjaGl1Y2poZnZ5b2hxaGloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk5MDczMjksImV4cCI6MjA3NTQ4MzMyOX0.kcx9Sr7qGbWudJdf155tXg0gWWX6P1RYavo-lKCoQkU';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;
let currentView = 'auth';
let posts = [];
let profile = null;
let userLikes = new Set();

// DOM elements omitted for brevity; same as before

document.addEventListener('DOMContentLoaded', async function() {
    const { data: { session } } = await supabase.auth.getSession();
    if (session) {
        currentUser = session.user;
        document.getElementById('user-email').textContent = currentUser.email;
        document.getElementById('logout-btn').classList.remove('hidden');
        showView('feed');
        await fetchPosts();
        await fetchProfile();
        await fetchUserLikes();
    } else {
        showView('auth');
    }
    supabase.auth.onAuthStateChange((_event, session) => {
        if (session) {
            currentUser = session.user;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('logout-btn').classList.remove('hidden');
            showView('feed');
            fetchPosts();
            fetchProfile();
            fetchUserLikes();
        } else {
            currentUser = null;
            document.getElementById('user-email').textContent = 'Not logged in';
            document.getElementById('logout-btn').classList.add('hidden');
            showView('auth');
        }
    });
    setupEventListeners();
});

function setupEventListeners() {
    document.getElementById('publish-post').addEventListener('click', createPost);
    document.getElementById('cancel-create').addEventListener('click', () => showView('feed'));
    document.getElementById('save-profile').addEventListener('click', saveProfile);
    document.getElementById('cancel-edit').addEventListener('click', () => document.getElementById('edit-profile-modal').classList.add('hidden'));
}

// Show/hide views
function showView(view) {
    currentView = view;
    ['auth', 'feed', 'create', 'profile'].forEach(v => {
        document.getElementById(v + '-view').classList.toggle('hidden', v !== view);
    });
}

// Upload to Supabase Storage
async function uploadFile(file, bucket, path) {
    if (!file) return null;
    const { data, error } = await supabase.storage.from(bucket).upload(path, file, { upsert: true });
    if (error) { console.error(error); return null; }
    const { publicUrl } = supabase.storage.from(bucket).getPublicUrl(path);
    return publicUrl;
}

// Create post with optional image
async function createPost() {
    const content = document.getElementById('create-post-content').value;
    const fileInput = document.getElementById('post-image');
    let image_url = null;

    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const path = `${currentUser.id}/${Date.now()}_${file.name}`;
        image_url = await uploadFile(file, 'synq-media', path);
    }

    if (!content && !image_url) return;

    await supabase.from('posts').insert({ content, image_url, user_id: currentUser.id });
    document.getElementById('create-post-content').value = '';
    fileInput.value = '';
    showView('feed');
    fetchPosts();
}

// Save profile with optional image
async function saveProfile() {
    const username = document.getElementById('edit-username').value;
    const bio = document.getElementById('edit-bio').value;
    const fileInput = document.getElementById('profile-image');
    let avatar_url = null;

    if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const path = `${currentUser.id}/${Date.now()}_${file.name}`;
        avatar_url = await uploadFile(file, 'synq-profile', path);
    }

    await supabase.from('profiles').upsert({ id: currentUser.id, username, bio, avatar_url });
    document.getElementById('edit-profile-modal').classList.add('hidden');
    fetchProfile();
}

// Fetch profile
async function fetchProfile() {
    const { data, error } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
    if (error) return console.error(error);
    profile = data;
    document.getElementById('profile-username').textContent = profile.username || 'Unknown';
    document.getElementById('profile-bio').textContent = profile.bio || '';
}
</script>
</body>
</html>
