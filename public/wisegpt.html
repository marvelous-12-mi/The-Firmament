<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>WiseGPT - Hybrid Smart Chatbot</title>
<style>
  body {
    margin: 0; padding: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }
  #app {
    max-width: 720px;
    margin: auto;
    display: flex;
    flex-direction: column;
    height: 100vh;
    background: #1e1e1e;
    border-radius: 12px;
    overflow: hidden;
  }
  header {
    padding: 1rem;
    font-weight: 700;
    font-size: 1.5rem;
    text-align: center;
    background: #2563eb;
    color: white;
    user-select: none;
  }
  #chat {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    background: #121212;
  }
  .message {
    max-width: 75%;
    padding: 0.8rem 1rem;
    border-radius: 12px;
    white-space: pre-wrap;
    line-height: 1.4;
  }
  .user {
    background: #2563eb;
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 0;
  }
  .bot {
    background: #333;
    color: #ddd;
    align-self: flex-start;
    border-bottom-left-radius: 0;
  }
  form {
    display: flex;
    padding: 1rem;
    background: #222;
    gap: 0.5rem;
  }
  input[type=text] {
    flex: 1;
    padding: 0.8rem 1rem;
    font-size: 1rem;
    border: none;
    border-radius: 20px;
    outline: none;
    background: #333;
    color: white;
  }
  button {
    padding: 0 1.5rem;
    font-weight: 600;
    border-radius: 20px;
    border: none;
    background: #2563eb;
    color: white;
    cursor: pointer;
  }
  button:disabled {
    background: #555;
    cursor: default;
  }
  #typing {
    font-style: italic;
    color: #999;
    padding-left: 1rem;
    margin-bottom: 0.5rem;
  }
  a {
    color: #60a5fa;
  }
</style>
</head>
<body>
<div id="app" role="main" aria-label="WiseGPT chatbot">
  <header>WiseGPT - Hybrid Smart Chatbot</header>
  <div id="chat" aria-live="polite" aria-relevant="additions"></div>
  <div id="typing" style="display:none;">WiseGPT is typing...</div>
  <form id="chat-form">
    <input type="text" id="user-input" autocomplete="off" placeholder="Ask me anything or type 'lookup: your query'" required />
    <button type="submit">Send</button>
  </form>
</div>

<script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.0.0/dist/transformers.min.js"></script>
<script>
(async () => {
  const chat = document.getElementById('chat');
  const form = document.getElementById('chat-form');
  const userInput = document.getElementById('user-input');
  const typing = document.getElementById('typing');

  // Simple local knowledge base
  const localKnowledge = [
    { pattern: /hello|hi|hey/i, responses: ["Hello! How can I help?", "Hi there! Ask me anything.", "Hey! What's on your mind?"] },
    { pattern: /how are you/i, responses: ["I'm just code, but I'm doing great!", "Running smoothly, thanks!", "At your service!"] },
    { pattern: /your name/i, responses: ["I'm WiseGPT.", "WiseGPT at your service."] },
    { pattern: /time|date/i, responses: [() => `Current date and time: ${new Date().toLocaleString()}`] },
    { pattern: /bye|goodbye/i, responses: ["Goodbye!", "See you later!", "Take care!"] },
  ];

  function addMessage(text, sender) {
    const div = document.createElement('div');
    div.classList.add('message', sender);
    div.innerHTML = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function getLocalResponse(input) {
    input = input.toLowerCase();
    for (const item of localKnowledge) {
      if (item.pattern.test(input)) {
        const res = item.responses;
        const choice = res[Math.floor(Math.random() * res.length)];
        return typeof choice === 'function' ? choice() : choice;
      }
    }
    return null;
  }

  async function duckDuckGoLookup(query) {
    try {
      const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_redirect=1&skip_disambig=1`;
      const response = await fetch(url);
      const data = await response.json();
      if (data.AbstractText) {
        return data.AbstractText + (data.AbstractURL ? `<br><a href="${data.AbstractURL}" target="_blank">More info</a>` : '');
      } else if (data.RelatedTopics && data.RelatedTopics.length > 0) {
        const first = data.RelatedTopics[0];
        if (first.Text) return first.Text;
      }
      return null;
    } catch (e) {
      return null;
    }
  }

  // Load transformers.js small distilgpt2 model for text generation
  typing.style.display = 'block';
  addMessage('<em>Loading AI model, please wait...</em>', 'bot');

  const tokenizer = await window.transformers.AutoTokenizer.fromPretrained('Xenova/distilgpt2');
  const model = await window.transformers.AutoModelForCausalLM.fromPretrained('Xenova/distilgpt2');

  chat.innerHTML = '';
  typing.style.display = 'none';

  async function generateText(prompt) {
    // Encode
    const inputs = await tokenizer.encode(prompt, { addSpecialTokens: false });
    // Generate max 50 tokens
    const output = await model.generate(inputs.inputIds, {
      maxLength: inputs.inputIds.length + 50,
      doSample: true,
      topK: 50,
      topP: 0.9,
      temperature: 0.7
    });
    // Decode
    const text = await tokenizer.decode(output[0], { skipSpecialTokens: true });
    return text.slice(prompt.length).trim();
  }

  form.addEventListener('submit', async e => {
    e.preventDefault();
    const input = userInput.value.trim();
    if (!input) return;

    addMessage(input, 'user');
    userInput.value = '';
    userInput.disabled = true;
    typing.style.display = 'block';

    // Check local knowledge
    let reply = getLocalResponse(input);
    if (reply) {
      addMessage(reply, 'bot');
      userInput.disabled = false;
      typing.style.display = 'none';
      return;
    }

    // Check lookup
    if (input.toLowerCase().startsWith('lookup:')) {
      const query = input.substring(7).trim();
      const lookupResult = await duckDuckGoLookup(query);
      if (lookupResult) {
        addMessage(lookupResult, 'bot');
      } else {
        addMessage("Sorry, no info found.", 'bot');
      }
      userInput.disabled = false;
      typing.style.display = 'none';
      return;
    }

    // Use transformers model for generation
    try {
      const prompt = "User: " + input + "\nWiseGPT:";
      const generated = await generateText(prompt);
      let finalReply = generated || "Sorry, I don't know how to answer that yet.";
      addMessage(finalReply, 'bot');
    } catch (error) {
      addMessage("Sorry, I had trouble generating a response.", 'bot');
    }

    userInput.disabled = false;
    typing.style.display = 'none';
  });

  userInput.focus();
})();
</script>
</body>
</html>
