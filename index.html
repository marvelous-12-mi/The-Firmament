<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TrendTime AI âœ¨</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --purple:#7b5fff;
  --blue:#42d4ff;
  --white:#fff;
  --card:#fefefe;
  --shadow:0 6px 18px rgba(0,0,0,0.15);
  --bg-gradient: linear-gradient(135deg,var(--purple),var(--blue));
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:#f0f2f5;color:#333;}
header{background:var(--bg-gradient);color:white;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.2);}
header h1{font-size:1.6rem;}
header button{background:white;color:var(--purple);border:none;padding:0.5rem 1rem;border-radius:25px;font-weight:600;cursor:pointer;transition:0.3s;}
header button:hover{background:var(--blue);color:white;}
main{max-width:700px;margin:2rem auto;padding:0 1rem;}
#auth,#composer{background:var(--card);border-radius:15px;padding:1rem;margin-bottom:1.5rem;box-shadow:var(--shadow);}
#auth input,#composer input,#composer textarea{width:100%;margin:0.5rem 0;padding:0.7rem;border:1px solid #ddd;border-radius:8px;resize:none;}
#auth button,#composer button{background:var(--bg-gradient);color:white;border:none;padding:0.7rem 1.2rem;border-radius:8px;font-weight:600;cursor:pointer;margin-top:0.5rem;}
.feed .trend{background:var(--card);border-radius:15px;margin-bottom:1.2rem;padding:1rem;box-shadow:var(--shadow);}
.feed .trend img,.feed .trend video{max-width:100%;border-radius:10px;margin-top:0.5rem;}
.post-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:var(--card);padding:1rem 1.5rem;border-radius:15px;box-shadow:var(--shadow);display:flex;flex-direction:column;align-items:center;z-index:500;transition:transform 0.3s ease;}
.post-popup.show{transform:translate(-50%,-50%) scale(1);}
</style>
</head>
<body>

<header>
  <h1>TrendTime AI âœ¨</h1>
  <div>
    <button id="postBtn" style="display:none;">Post</button>
    <button id="signOutBtn" style="display:none;">Sign Out</button>
  </div>
</header>

<main>
  <section id="auth">
    <h2>Sign In / Sign Up</h2>
    <input type="text" id="username" placeholder="Choose a username"/>
    <input type="email" id="email" placeholder="Email"/>
    <button id="authBtn">Send Magic Link</button>
    <p style="font-size:0.85rem;color:#666;">Enter email to get a login link.</p>
  </section>

  <section id="composer" style="display:none;">
    <textarea id="captionInput" placeholder="What's trending?"></textarea>
    <input type="text" id="imagePrompt" placeholder="AI Image Prompt..."/>
    <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;">
      <button id="generateImageBtn">ðŸŽ¨ Generate Image</button>
      <button id="recordVideoBtn">ðŸŽ¥ Record 5s Video</button>
      <button id="suggestCaptionBtn">âœ¨ AI Caption</button>
    </div>
    <div id="preview" style="margin-top:1rem;"></div>
  </section>

  <section class="feed" id="feed"></section>
</main>

<div class="post-popup" id="postPopup">
  <h3>Confirm Post</h3>
  <p id="popupInfo"></p>
  <button id="confirmPostBtn">Post Now</button>
  <button onclick="closePopup()">Cancel</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl="https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl,supabaseKey);

let currentUser=null, generatedImage=null, recordedVideoBlob=null;

// AUTH
const authBtn=document.getElementById("authBtn");
const emailInput=document.getElementById("email");
const usernameInput=document.getElementById("username");
const authSection=document.getElementById("auth");
const composerSection=document.getElementById("composer");
const signOutBtn=document.getElementById("signOutBtn");
const postBtn=document.getElementById("postBtn");

authBtn.onclick=async()=>{
  const email=emailInput.value.trim();
  const username=usernameInput.value.trim();
  if(!email||!username){alert("Enter email & username"); return;}
  const { error } = await supabase.auth.signInWithOtp({email});
  if(error){alert(error.message); return;}
  alert("Magic link sent to your email!");
}

// Check session
async function checkSession(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(session){
    currentUser=session.user;
    authSection.style.display="none";
    composerSection.style.display="block";
    signOutBtn.style.display="inline-block";
    postBtn.style.display="inline-block";
    loadFeed();
  }
}
checkSession();

signOutBtn.onclick=async()=>{await supabase.auth.signOut(); location.reload();}

// AI IMAGE
document.getElementById("generateImageBtn").onclick=()=>{
  const prompt=document.getElementById("imagePrompt").value.trim();
  if(!prompt){alert("Enter prompt!"); return;}
  generatedImage=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  document.getElementById("preview").innerHTML=`<img src="${generatedImage}" style="width:100%;border-radius:10px;"/>`;
}

// AI CAPTION
document.getElementById("suggestCaptionBtn").onclick=()=>{document.getElementById("captionInput").value="ðŸ”¥ Viral caption suggested by AI!";}

// RECORD VIDEO
document.getElementById("recordVideoBtn").onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  const recorder=new MediaRecorder(stream);
  let chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{recordedVideoBlob=new Blob(chunks,{type:"video/webm"}); document.getElementById("preview").innerHTML=`<video controls src="${URL.createObjectURL(recordedVideoBlob)}"></video>`;}
  recorder.start();
  setTimeout(()=>recorder.stop(),5000);
}

// POST
const postPopup=document.getElementById("postPopup");
const popupInfo=document.getElementById("popupInfo");
const confirmPostBtn=document.getElementById("confirmPostBtn");

postBtn.onclick=()=>{
  const caption=document.getElementById("captionInput").value.trim();
  if(!caption && !generatedImage && !recordedVideoBlob){alert("Add caption or media!"); return;}
  let info="Caption: "+caption;
  if(generatedImage) info+="\nIncludes Image";
  if(recordedVideoBlob) info+="\nIncludes Video";
  popupInfo.textContent=info;
  postPopup.classList.add("show");
}
function closePopup(){postPopup.classList.remove("show");}

confirmPostBtn.onclick=async()=>{
  postPopup.classList.remove("show");
  const caption=document.getElementById("captionInput").value.trim();
  let url=null,type="text";

  if(generatedImage){
    const resp=await fetch(generatedImage);
    const blob=await resp.blob();
    const filePath=`image-${Date.now()}.png`;
    let { error } = await supabase.storage.from("trend-media").upload(filePath,blob,{upsert:true});
    if(error){alert(error.message); return;}
    url=supabase.storage.from("trend-media").getPublicUrl(filePath).data.publicUrl;
    type="image"; generatedImage=null;
  }

  if(recordedVideoBlob){
    const filePath=`video-${Date.now()}.webm`;
    let { error } = await supabase.storage.from("trend-media").upload(filePath,recordedVideoBlob,{upsert:true});
    if(error){alert(error.message); return;}
    url=supabase.storage.from("trend-media").getPublicUrl(filePath).data.publicUrl;
    type="video"; recordedVideoBlob=null;
  }

  const { error }=await supabase.from("trends").insert([{user_id:currentUser.id,caption,url,type}]);
  if(error){alert(error.message); return;}
  document.getElementById("captionInput").value="";
  document.getElementById("preview").innerHTML="";
  loadFeed();
}

// LOAD FEED
async function loadFeed(){
  const { data,error } = await supabase.from("trends").select("*").order("id",{ascending:false});
  if(error){console.error(error); return;}
  const feed=document.getElementById("feed");
  feed.innerHTML="";
  data.forEach(trend=>{
    const div=document.createElement("div");
    div.className="trend";
    div.innerHTML=`<strong>${trend.user_id}</strong><p>${trend.caption||""}</p>
      ${trend.type==="image"?`<img src="${trend.url}"/>`:''}
      ${trend.type==="video"?`<video controls src="${trend.url}"></video>`:''}`;
    feed.appendChild(div);
  });
}
</script>
</body>
</html>
