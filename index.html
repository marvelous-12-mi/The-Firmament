<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>TrendTime - Official Social Media</title>
<link rel="icon" href="https://placehold.co/32x32/ff6a00/ffffff?text=T" type="image/png" />
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
  :root {
    --orange:#ff6a00; --dark:#0f0f0f; --card:#1a1a1a;
    --text:#f5f5f5; --gray:#999; --border:#333;
  }
  body{margin:0;font-family:'Poppins',sans-serif;background:var(--dark);color:var(--text);}
  .navbar{background:var(--card);padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:1000;}
  .nav-logo{font-size:1.8rem;font-weight:700;color:var(--orange);}
  .nav-actions{display:flex;gap:1rem;align-items:center;}
  .nav-actions button{background:var(--orange);color:#fff;border:none;border-radius:6px;padding:0.5rem 1rem;font-weight:600;cursor:pointer;transition:0.3s;}
  .nav-actions button:hover{background:#e85c00;}
  .nav-actions img{width:36px;height:36px;border-radius:50%;border:2px solid var(--orange);object-fit:cover;}
  main{max-width:700px;margin:auto;padding:2rem 1rem;}
  .composer{margin-bottom:2rem;background:var(--card);padding:1rem;border-radius:12px;box-shadow:0 0 20px rgba(255,106,0,0.3);}
  form{display:flex;flex-direction:column;gap:1rem;}
  textarea,input{background:#222;border:none;border-radius:8px;padding:1rem;color:#fff;font-size:1rem;resize:none;}
  button[type="submit"]{background:var(--orange);color:#fff;border:none;border-radius:8px;padding:0.75rem;font-weight:600;cursor:pointer;transition:0.3s;}
  button[type="submit"]:hover{background:#e85c00;}
  .feed{display:flex;flex-direction:column;gap:2rem;}
  .trend-card{background:var(--card);border-radius:12px;padding:1rem;box-shadow:0 0 20px rgba(0,0,0,0.5);display:flex;flex-direction:column;gap:0.5rem;}
  .trend-header{display:flex;align-items:center;gap:0.75rem;}
  .trend-header img{width:50px;height:50px;border-radius:50%;object-fit:cover;border:2px solid var(--orange);}
  .trend-user{font-weight:700;font-size:1.1rem;}
  .trend-text{font-size:1rem;margin:0.25rem 0;}
  .trend-card video,.trend-card iframe{width:100%;max-height:400px;border-radius:8px;}
  .trend-footer{display:flex;justify-content:space-between;align-items:center;color:var(--gray);font-size:0.8rem;margin-top:0.5rem;}
  footer{text-align:center;padding:1rem;font-size:0.8rem;color:var(--gray);border-top:1px solid var(--border);margin-top:3rem;}
</style>
</head>
<body>
<nav class="navbar">
  <div class="nav-logo">TrendTime</div>
  <div class="nav-actions">
    <img id="avatar" src="" alt="Profile" style="display:none;" />
    <button id="loginBtn">Sign In with Email</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
</nav>

<main>
<section class="composer">
  <form id="trendForm">
    <textarea id="trendText" placeholder="What's trending?" required></textarea>
    <input type="url" id="videoUrl" placeholder="Video URL or YouTube link" />
    <button type="submit">Post Trend</button>
  </form>
</section>

<section id="trendFeed" class="feed"></section>
</main>

<footer>&copy; 2025 TrendTime. Built by MgnGodly.</footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

// ðŸ”‘ Replace YOUR_ANON_KEY with your key locally. DO NOT push public key.
const supabase = createClient('https://kpdgmbjdaynplyjacuxd.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ')

const loginBtn = document.getElementById("loginBtn")
const logoutBtn = document.getElementById("logoutBtn")
const avatar = document.getElementById("avatar")
const form = document.getElementById("trendForm")
const feed = document.getElementById("trendFeed")
const composer = document.querySelector(".composer")

loginBtn.onclick = async () => {
  const email = prompt("Enter your email")
  if (!email) return
  const { error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: location.href } })
  if(error) alert("Error: "+error.message)
  else alert("Check your email for login link!")
}

logoutBtn.onclick = async () => { await supabase.auth.signOut(); location.reload() }

async function handleMagicLink() {
  const { data } = await supabase.auth.getSessionFromUrl({ storeSession:true })
  const user = data.session?.user
  if(user) console.log("Logged in via magic link:", user.email)
}

async function ensureProfile(user) {
  const { data: existing } = await supabase.from("profiles").select().eq("id", user.id).single()
  if(!existing) {
    await supabase.from("profiles").insert([{id:user.id, username:user.user_metadata?.name || "Anonymous", avatar_url:user.user_metadata?.avatar_url || ""}])
  }
}

form.addEventListener("submit", async e => {
  e.preventDefault()
  const text = document.getElementById("trendText").value.trim()
  const video_url = document.getElementById("videoUrl").value.trim()
  const { data: { session } } = await supabase.auth.getSession()
  const user = session?.user
  if(!user) return alert("Sign in to post.")
  await ensureProfile(user)
  const { error } = await supabase.from("trends").insert([{text, video_url: video_url||null, user_id:user.id}])
  if(error) alert(error.message)
  else { form.reset(); loadTrends() }
})

async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession()
  const user = session?.user
  if(user){
    loginBtn.style.display="none"
    logoutBtn.style.display="inline-block"
    avatar.style.display="inline-block"
    avatar.src = user.user_metadata?.avatar_url || "https://placehold.co/36x36"
    composer.style.display="block"
    await ensureProfile(user)
  } else composer.style.display="none"
}

function isYouTube(url){ return url.includes("youtube.com") || url.includes("youtu.be") }

function renderTrend(trend, profile){
  const card = document.createElement("div"); card.className="trend-card"
  const header = document.createElement("div"); header.className="trend-header"
  const userAvatar = document.createElement("img"); userAvatar.src = profile?.avatar_url||"https://placehold.co/40x40"; header.appendChild(userAvatar)
  const info = document.createElement("div")
  const userTag = document.createElement("div"); userTag.className="trend-user"; userTag.textContent = profile?.username || "Anonymous"
  info.appendChild(userTag)
  header.appendChild(info)
  card.appendChild(header)

  const textEl = document.createElement("div"); textEl.className="trend-text"; textEl.textContent = trend.text; card.appendChild(textEl)

  if(trend.video_url){
    if(isYouTube(trend.video_url)){
      let id=""
      if(trend.video_url.includes("youtu.be")) id=trend.video_url.split("/").pop()
      else id=new URL(trend.video_url).searchParams.get("v")
      const iframe=document.createElement("iframe")
      iframe.src=`https://www.youtube.com/embed/${id}`
      iframe.allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
      iframe.allowFullscreen=true
      iframe.height=300
      card.appendChild(iframe)
    } else {
      const video=document.createElement("video"); video.src=trend.video_url; video.controls=true; card.appendChild(video)
    }
  }

  const footer = document.createElement("div"); footer.className="trend-footer"; footer.textContent=new Date().toLocaleString()
  card.appendChild(footer)

  feed.prepend(card)
}

async function loadTrends(){
  const { data: trends, error } = await supabase.from("trends").select("id,text,video_url,user_id").order("id",{ascending:false})
  if(error){console.error(error);return}
  feed.innerHTML=""
  for(const trend of trends){
    let profile={username:"Anonymous",avatar_url:"https://placehold.co/40x40"}
    const { data:profileData } = await supabase.from("profiles").select("username,avatar_url").eq("id",trend.user_id).single()
    if(profileData) profile=profileData
    renderTrend(trend,profile)
  }
}

supabase.channel("realtime-trends")
  .on("postgres_changes",{event:"INSERT",schema:"public",table:"trends"},async payload=>{
    const trend=payload.new
    let profile={username:"Anonymous",avatar_url:"https://placehold.co/40x40"}
    const {data:profileData}=await supabase.from("profiles").select("username,avatar_url").eq("id",trend.user_id).single()
    if(profileData) profile=profileData
    renderTrend(trend,profile)
  }).subscribe()

handleMagicLink().then(()=>{checkAuth();loadTrends()})
</script>
</body>
</html>
