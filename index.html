<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TrendTime ‚Äî AI Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.7.0/dist/tf.min.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<style>
:root{
  --bg:#f5f5f5; --card:#fff; --muted:#666;
  --accent1:#ff6a00; --accent2:#ff1f71; --glass: rgba(0,0,0,0.05);
}
[data-theme="dark"]{
  --bg:#111; --card:#222; --muted:#aaa;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background:var(--bg);color:#111;min-height:100vh;overflow-x:hidden;}
header{height:70px;display:flex;justify-content:space-between;align-items:center;padding:0 20px;background:var(--card);box-shadow:0 4px 20px rgba(0,0,0,0.1);position:sticky;top:0;z-index:50;}
header h1{font-size:1.6rem;font-weight:700;}
header .actions{display:flex;gap:12px;align-items:center;}
button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;transition:0.2s;}
button.btn:hover{opacity:0.85;}
.app{display:grid;grid-template-columns:1fr;gap:16px;padding:16px;}
.center{display:flex;flex-direction:column;gap:12px;}
.feed{display:flex;flex-direction:column;gap:18px;overflow-y:auto;}
.post-card{position:relative;background:var(--card);border-radius:14px;overflow:hidden;box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.post-media{width:100%;border-radius:12px;background:#000;}
.post-info{padding:12px;}
.caption{color:var(--muted);}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:90;}
.modal{background:var(--card);padding:18px;border-radius:14px;width:90%;max-width:520px;box-shadow:0 0 20px rgba(0,0,0,0.1);}
input,textarea,select{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc;margin-bottom:10px;}
canvas#audioVisualizer{width:100%;height:100px;border-radius:12px;background:rgba(0,0,0,0.05);}
.sticker{position:absolute;width:50px;height:50px;pointer-events:none;}
</style>
</head>
<body data-theme="light">

<header>
<h1>TrendTime</h1>
<div class="actions">
  <button id="openRecordModal" class="btn">üé• Record / Post</button>
  <button id="openImageModal" class="btn">üñºÔ∏è AI Image</button>
  <button id="settingsBtn" class="btn">‚öôÔ∏è Settings</button>
</div>
</header>

<div class="app">
<main class="center">
<div class="feed" id="feedWrap"></div>
</main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
  <div class="modal" id="modalContent"></div>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl = 'https://kpdgmbjdaynplyjacuxd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ';
const supabase = createClient(supabaseUrl, supabaseKey);

const feedWrap = document.getElementById('feedWrap');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalContent = document.getElementById('modalContent');

function showModal(html){ modalContent.innerHTML=html; modalBackdrop.style.display='flex'; }
function closeModal(){ modalBackdrop.style.display='none'; modalContent.innerHTML=''; }
modalBackdrop.addEventListener('click',e=>{ if(e.target===modalBackdrop) closeModal(); });

// ------------- VIDEO RECORDING + AI EFFECTS -------------
document.getElementById('openRecordModal').onclick = async () => {
  showModal(`
    <h2>Record Video</h2>
    <video id="videoPreview" autoplay muted playsinline style="width:100%;border-radius:12px;"></video>
    <input id="captionInput" placeholder="Caption..." style="margin-top:10px;">
    <canvas id="audioVisualizer"></canvas>
    <div style="display:flex;gap:10px;margin-top:10px;">
      <button id="startRec" class="btn">Start</button>
      <button id="stopRec" class="btn" disabled>Stop & Upload</button>
      <button id="closeModalBtn" class="btn">Close</button>
    </div>
    <button id="tfEffect" class="btn" style="margin-top:10px;">üß† Apply TF Grayscale</button>
    <button id="stickerBtn" class="btn" style="margin-top:10px;">‚ú® Add AI Sticker</button>
  `);

  const videoPreview = document.getElementById('videoPreview');
  const startRec = document.getElementById('startRec');
  const stopRec = document.getElementById('stopRec');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const tfEffect = document.getElementById('tfEffect');
  const stickerBtn = document.getElementById('stickerBtn');
  const captionInput = document.getElementById('captionInput');
  const audioCanvas = document.getElementById('audioVisualizer');
  const ctxAudio = audioCanvas.getContext('2d');

  let localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  videoPreview.srcObject = localStream;

  // Setup Audio FFT
  const audioCtx = new AudioContext();
  const source = audioCtx.createMediaStreamSource(localStream);
  const analyser = audioCtx.createAnalyser();
  source.connect(analyser);
  analyser.fftSize = 256;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  function drawAudio(){ 
    requestAnimationFrame(drawAudio);
    analyser.getByteFrequencyData(dataArray);
    ctxAudio.clearRect(0,0,audioCanvas.width,audioCanvas.height);
    ctxAudio.fillStyle='hsl(200,80%,50%)';
    const barWidth = audioCanvas.width / bufferLength;
    dataArray.forEach((v,i)=>{
      ctxAudio.fillRect(i*barWidth, audioCanvas.height-v, barWidth, v);
    });
  }
  drawAudio();

  let chunks = [];
  let recorder = new MediaRecorder(localStream);
  recorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); }
  recorder.onstop = async () => {
    const blob = new Blob(chunks,{type:'video/webm'});
    const fileName = `video_${Date.now()}.webm`;
    const { error } = await supabase.storage.from('videos').upload(fileName,blob,{upsert:true});
    if(error){ alert('Upload failed: '+error.message); return; }
    const { data } = supabase.storage.from('videos').getPublicUrl(fileName);
    await supabase.from('trends').insert([{url:data.publicUrl,caption:captionInput.value||'üî• Trend'}]);
    chunks=[];
    loadFeed();
    closeModal();
    localStream.getTracks().forEach(t=>t.stop());
  };

  startRec.onclick = ()=>{ recorder.start(); startRec.disabled=true; stopRec.disabled=false; }
  stopRec.onclick = ()=>{ recorder.stop(); stopRec.disabled=true; startRec.disabled=false; }
  closeModalBtn.onclick = ()=>{ closeModal(); localStream.getTracks().forEach(t=>t.stop()); }

  tfEffect.onclick = () => {
    const canvas = document.createElement('canvas');
    canvas.width = videoPreview.videoWidth; canvas.height = videoPreview.videoHeight;
    const ctx = canvas.getContext('2d');
    document.body.appendChild(canvas);
    canvas.style.position='fixed'; canvas.style.top='80px'; canvas.style.left='50%';
    canvas.style.transform='translateX(-50%)'; canvas.style.zIndex='100';
    const loop = ()=>{
      if(videoPreview.paused || videoPreview.ended) return;
      ctx.drawImage(videoPreview,0,0,canvas.width,canvas.height);
      let imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      let tfImg = tf.browser.fromPixels(imgData);
      let gray = tfImg.mean(2).expandDims(2).tile([1,1,3]);
      tf.browser.toPixels(gray,canvas);
      requestAnimationFrame(loop);
    };
    loop();
  }

  stickerBtn.onclick = ()=>{
    const sticker = document.createElement('div');
    sticker.className='sticker';
    sticker.style.left=Math.random()*videoPreview.clientWidth+'px';
    sticker.style.top=Math.random()*videoPreview.clientHeight+'px';
    sticker.innerHTML='üî•';
    videoPreview.parentElement.appendChild(sticker);
  }
};

// ------------- AI IMAGE FRONTEND -------------
document.getElementById('openImageModal').onclick = () => {
  showModal(`
    <h2>Generate AI Image</h2>
    <input id="imgPrompt" placeholder="Enter prompt..." style="margin-top:10px;">
    <button id="genImgBtn" class="btn" style="margin-top:10px;">üé® Generate</button>
    <div id="imgOutput" style="margin-top:10px;"></div>
    <button id="closeImgModal" class="btn" style="margin-top:10px;">Close</button>
  `);
  const genImgBtn = document.getElementById('genImgBtn');
  const imgOutput = document.getElementById('imgOutput');
  const imgPrompt = document.getElementById('imgPrompt');
  const closeImgModal = document.getElementById('closeImgModal');

  genImgBtn.onclick = ()=>{
    const prompt = imgPrompt.value || 'Cool AI art';
    imgOutput.innerHTML='';
    for(let i=0;i<3;i++){
      const canvas = document.createElement('canvas');
      canvas.width=300; canvas.height=300;
      const ctx = canvas.getContext('2d');
      for(let j=0;j<100;j++){
        ctx.fillStyle = `hsl(${Math.random()*360},${Math.random()*100}%,${Math.random()*60+20}%)`;
        ctx.beginPath();
        ctx.arc(Math.random()*300,Math.random()*300,Math.random()*50,0,Math.PI*2);
        ctx.fill();
      }
      imgOutput.appendChild(canvas);
    }
  };
  closeImgModal.onclick = ()=>{ closeModal(); }
};

// ---------------- SETTINGS ----------------
document.getElementById('settingsBtn').onclick = ()=>{
  showModal(`
    <h2>Settings</h2>
    <label>Theme:
      <select id="themeSelect">
        <option value="light">Light</option>
        <option value="dark">Dark</option>
      </select>
    </label>
    <label>FFT Sensitivity:
      <input type="range" id="fftRange" min="1" max="5" step="0.1" value="2">
    </label>
    <button id="closeSettings" class="btn">Close</button>
  `);
  const themeSelect = document.getElementById('themeSelect');
  themeSelect.value = document.body.getAttribute('data-theme');
  themeSelect.onchange = ()=>document.body.setAttribute('data-theme',themeSelect.value);
  document.getElementById('closeSettings').onclick = ()=>closeModal();
};

// ---------------- LOAD FEED ----------------
async function loadFeed(){
  feedWrap.innerHTML='';
  const { data,error } = await supabase.from('trends').select('*').order('created_at',{ascending:false}).limit(50);
  if(error){ console.log(error); return;}
  data.forEach(post=>{
    const card = document.createElement('div'); card.className='post-card';
    if(post.url.endsWith('.webm')){
      const video = document.createElement('video');
      video.src=post.url; video.controls=true; video.loop=true; video.muted=false; video.className='post-media';
      card.appendChild(video);
    } else {
      const img = document.createElement('img');
      img.src=post.url; img.className='post-media';
      card.appendChild(img);
    }
    const info = document.createElement('div'); info.className='post-info';
    info.innerHTML=`<div class="caption">${post.caption||''}</div>`;
    card.appendChild(info);
    feedWrap.appendChild(card);
  });
}

loadFeed();
</script>
</body>
</html>
