<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>TrendTime ‚Äî AI Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0a0a0f;
  --card:#1f1b2e;
  --muted:#9aa6b2;
  --accent1:#ff0080;
  --accent2:#00ffff;
  --glass: rgba(255,255,255,0.05);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background:linear-gradient(180deg,#0a0a0f,#05020a);color:#fff;overflow:hidden;min-height:100vh;}
header{height:70px;display:flex;justify-content:space-between;align-items:center;padding:0 20px;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 6px 30px rgba(255,0,128,0.4);position:sticky;top:0;z-index:50;}
header h1{font-size:1.6rem;text-shadow:0 0 15px var(--accent2);}
header .actions{display:flex;gap:12px;align-items:center;}
button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#000;border:none;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;transition:0.2s;}
button.btn:hover{filter:drop-shadow(0 0 15px var(--accent2));}
button.icon-btn{background:var(--glass);border:1px solid rgba(255,255,255,0.1);color:var(--muted);padding:8px;border-radius:12px;cursor:pointer;transition:0.2s;}
button.icon-btn:hover{background:rgba(255,255,255,0.1);}
.app{display:grid;grid-template-columns:300px 1fr 360px;gap:16px;padding:16px;height:calc(100vh - 70px);}
@media(max-width:1100px){.app{grid-template-columns:1fr}.right{display:none}}
.left, .right{background:var(--card);border-radius:14px;padding:16px;overflow:auto;box-shadow:0 8px 30px rgba(0,0,0,0.6);}
.center{overflow:hidden;border-radius:14px;padding:8px;display:flex;flex-direction:column;gap:12px;}
.feed{flex:1;overflow-y:auto;scroll-snap-type:y mandatory;padding:8px;}
.post-card{position:relative;background:var(--card);height:calc(100vh - 200px);margin-bottom:18px;border-radius:14px;overflow:hidden;scroll-snap-align:start;box-shadow:0 12px 40px rgba(0,0,0,0.6);}
.post-media{width:100%;height:100%;object-fit:cover;background:#000;}
.post-info{position:absolute;left:16px;bottom:16px;right:120px;padding:12px;background:linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.35));border-radius:12px;}
.meta{display:flex;gap:12px;align-items:center;}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06);}
.username{font-weight:700;color:#fff;}
.caption{color:var(--muted);margin-top:6px;}
.post-controls{position:absolute;right:16px;bottom:16px;display:flex;flex-direction:column;gap:12px;align-items:center;}
.round{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,var(--accent1),var(--accent2));box-shadow:0 4px 20px rgba(255,30,100,0.3);cursor:pointer;transition:0.2s;}
.round:hover{transform:scale(1.1);filter:drop-shadow(0 0 20px var(--accent2));}
.small{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);cursor:pointer;transition:0.2s;}
.small:hover{background:rgba(255,255,255,0.08);}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;}
input[type="text"], input[type="url"], textarea{background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:#fff;padding:10px;border-radius:12px;}
.search-list{max-height:220px;overflow:auto;border-radius:8px;background:rgba(255,255,255,0.01);padding:6px;}
.search-item{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center;}
.comments{margin-top:10px;background:rgba(0,0,0,0.35);padding:8px;border-radius:8px;max-height:140px;overflow:auto;}
.comment-item{padding:6px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;align-items:center;justify-content:center;z-index:90;}
.modal{background:var(--card);padding:18px;border-radius:14px;width:90%;max-width:520px;box-shadow:0 0 20px rgba(0,255,255,0.3);}
</style>
</head>
<body>
<header>
  <h1>TrendTime</h1>
  <div class="actions">
    <button id="shuffleFeedBtn" class="icon-btn">üîÄ</button>
    <button id="openPostModal" class="btn">Post / Record</button>
    <button id="openLoginBtn" class="btn">Sign In</button>
  </div>
</header>

<div class="app">
  <aside class="left">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <img id="leftAvatar" class="avatar" src="https://placehold.co/80x80?text=U">
      <div>
        <div id="leftUsername" class="username">Guest</div>
        <div class="muted" id="leftEmail">‚Äî</div>
      </div>
    </div>
    <div class="field">
      <button id="openRecordModal" class="btn">Record & Upload</button>
    </div>
    <div class="field">
      <label>Search Users</label>
      <input id="searchInput" type="text" placeholder="Search...">
      <div class="search-list" id="searchResults"></div>
    </div>
  </aside>

  <main class="center">
    <div style="display:flex;align-items:center;gap:12px;padding:8px">
      <h2>Feed</h2>
      <button id="refreshFeed" class="icon-btn" style="margin-left:auto">‚ü≥</button>
    </div>
    <div class="feed" id="feedWrap"></div>
  </main>

  <aside class="right">
    <div class="field">
      <label>Caption (AI)</label>
      <input id="composeCaption" type="text" placeholder="Write a caption or use AI">
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="aiCaptionBtn" class="btn">‚ú® AI Caption</button>
        <button id="aiHashtagsBtn" class="icon-btn"># Hashtags</button>
      </div>
    </div>
    <div class="field">
      <label>Cover Image Prompt</label>
      <input id="aiCoverPrompt" type="text" placeholder="Neon dancer, cyberpunk...">
      <button id="aiCoverBtn" class="btn">üñºÔ∏è Generate Cover</button>
      <div id="aiCoverPreview" style="margin-top:8px"></div>
    </div>
  </aside>
</div>

<div id="modalBackdrop" class="modal-backdrop"><div id="modalContainer" class="modal"></div></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl = 'https://kpdgmbjdaynplyjacuxd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ';
const supabase = createClient(supabaseUrl, supabaseKey);

// DOM
const feedWrap = document.getElementById('feedWrap');
const leftAvatar = document.getElementById('leftAvatar');
const leftUsername = document.getElementById('leftUsername');
const leftEmail = document.getElementById('leftEmail');
const openLoginBtn = document.getElementById('openLoginBtn');
const openPostModal = document.getElementById('openPostModal');
const openRecordModal = document.getElementById('openRecordModal');
const shuffleFeedBtn = document.getElementById('shuffleFeedBtn');
const refreshFeed = document.getElementById('refreshFeed');
const composeCaptionInput = document.getElementById('composeCaption');
const aiCaptionBtn = document.getElementById('aiCaptionBtn');
const aiHashtagsBtn = document.getElementById('aiHashtagsBtn');
const aiCoverPrompt = document.getElementById('aiCoverPrompt');
const aiCoverBtn = document.getElementById('aiCoverBtn');
const aiCoverPreview = document.getElementById('aiCoverPreview');
const modalBackdrop = document.getElementById('modalBackdrop');
const modalContainer = document.getElementById('modalContainer');

let currentUser = null;
let postsCache = [];
let observer = null;

// Helpers
function toast(msg){ alert(msg);}
function closeModal(){ modalBackdrop.style.display='none'; modalContainer.innerHTML=''; }
modalBackdrop.addEventListener('click', e=>{if(e.target===modalBackdrop)closeModal();});

// AUTH + PROFILE
async function refreshAuth(){
  const { data } = await supabase.auth.getSession();
  currentUser = data.session?.user ?? null;
  if(currentUser){
    leftEmail.textContent = currentUser.email||'';
    leftUsername.textContent = currentUser.email.split('@')[0];
    leftAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(leftUsername.textContent)}&background=101827&color=fff&size=128`;
    openLoginBtn.style.display='none';
  }else{
    leftEmail.textContent='‚Äî';
    leftUsername.textContent='Guest';
    leftAvatar.src='https://placehold.co/80x80?text=U';
    openLoginBtn.style.display='inline-block';
  }
}

// LOAD FEED
async function loadFeed(){
  const { data,error } = await supabase.from('trends').select('*').order('created_at',{ascending:false}).limit(100);
  if(error){ toast('Feed error'); return; }
  postsCache = data||[];
  renderFeed(postsCache);
}
function renderFeed(posts){
  feedWrap.innerHTML='';
  let collection = posts.slice();
  if(window.__shuffleOn) collection.sort(()=>Math.random()-0.5);
  collection.forEach(post=>{
    const card=document.createElement('div');card.className='post-card';
    let mediaEl;
    if(post.url.includes('youtube')){
      mediaEl=document.createElement('iframe');
      mediaEl.src=post.url.includes('embed')?post.url:post.url.replace('watch?v=','embed/');
      mediaEl.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture');
      mediaEl.className='post-media';
    }else{
      mediaEl=document.createElement('video');
      mediaEl.src=post.url;
      mediaEl.className='post-media';
      mediaEl.muted=true;
      mediaEl.loop=true;
    }
    card.appendChild(mediaEl);

    const info=document.createElement('div');info.className='post-info';
    info.innerHTML=`<div class="meta"><img class="avatar" src="${post.avatar||'https://placehold.co/80x80'}"><div><div class="username">${post.username}</div></div></div><div class="caption">${post.caption||''}</div>`;
    card.appendChild(info);

    feedWrap.appendChild(card);
  });

  // autoplay videos
  if(observer) observer.disconnect();
  const videos=feedWrap.querySelectorAll('video');
  observer=new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      const v=entry.target;
      entry.isIntersecting?v.play().catch(()=>{}):v.pause();
    });
  },{threshold:0.6});
  videos.forEach(v=>observer.observe(v));
}

// AI Caption
aiCaptionBtn.addEventListener('click', async ()=>{
  aiCaptionBtn.disabled=true;aiCaptionBtn.textContent='Thinking...';
  try{
    const res=await fetch(`https://text.pollinations.ai/Short viral caption for a trendy short video with emoji`);
    const txt=await res.text();
    composeCaptionInput.value=(txt||'üî• Trending!').replace(/\n/g,' ').slice(0,140);
  }catch(e){ toast('AI error'); }
  aiCaptionBtn.disabled=false;aiCaptionBtn.textContent='‚ú® AI Caption';
});

// AI Hashtags
aiHashtagsBtn.addEventListener('click', async ()=>{
  aiHashtagsBtn.disabled=true;
  try{
    const base=composeCaptionInput.value||'short dance video';
    const res=await fetch(`https://text.pollinations.ai/Give 5 trending hashtags for: ${base}`);
    const txt=await res.text();
    const tags=(txt||'').split(/[\n,]+/).map(s=>s.trim()).filter(Boolean).slice(0,6).map(t=>t.startsWith('#')?t:'#'+t.replace(/\s+/g,'')).join(' ');
    composeCaptionInput.value=(composeCaptionInput.value?'':tags)+' '+tags;
  }catch(e){ toast('AI error');}
  aiHashtagsBtn.disabled=false;
});

// Generate AI Cover
aiCoverBtn.addEventListener('click', ()=>{
  const prompt=aiCoverPrompt.value||'neon dancer, cyberpunk, vertical';
  const url=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  aiCoverPreview.innerHTML=`<img src="${url}" style="width:100%;border-radius:12px"/>`;
});

// Refresh / Shuffle
refreshFeed.addEventListener('click', loadFeed);
shuffleFeedBtn.addEventListener('click', ()=>{window.__shuffleOn=!window.__shuffleOn;toast('Shuffle '+(window.__shuffleOn?'ON':'OFF'));loadFeed();});

// INIT
(async function init(){await refreshAuth();await loadFeed();})();
</script>
</body>
</html>
