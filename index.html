<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TrendTime AI 🔥</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --primary:#1e90ff;
  --secondary:#ff1493;
  --dark:#0f0f0f;
  --card:#1a1a1a;
  --accent:#00ffea;
  --light:#fff;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--dark);color:white;overflow-x:hidden;}
header{position:sticky;top:0;width:100%;z-index:100;background:linear-gradient(90deg,var(--primary),var(--secondary));display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;box-shadow:0 4px 20px rgba(0,0,0,0.6);}
header h1{font-size:1.6rem;font-weight:700;letter-spacing:1px;text-shadow:0 0 10px rgba(0,0,0,0.5);}
header button{background:white;color:var(--dark);border:none;padding:0.5rem 1rem;border-radius:999px;cursor:pointer;font-weight:bold;transition:0.3s;}
header button:hover{background:var(--secondary);color:white;}

/* Side Panel */
.side-panel{position:fixed;top:0;left:-400px;width:380px;height:100vh;background:var(--card);box-shadow:5px 0 25px rgba(0,0,0,0.6);transition:left 0.3s ease;padding:2rem;z-index:200;overflow-y:auto;}
.side-panel.active{left:0;}
.side-panel h2,h3{margin-bottom:1rem;color:var(--accent);}
.side-panel input,.side-panel select,.side-panel button{margin:0.5rem 0;padding:0.7rem;width:100%;border-radius:10px;border:none;background:#222;color:white;}
.side-panel input::placeholder{color:#aaa;}
.side-panel button{cursor:pointer;background:linear-gradient(145deg,var(--primary),var(--secondary));color:white;font-weight:bold;transition:0.3s;}
.side-panel button:hover{opacity:0.9;}

/* Sections */
.settings-section{margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid rgba(255,255,255,0.2);}
.settings-section h3{margin-bottom:0.7rem;color:var(--accent);}
.settings-section video{width:100%;border-radius:10px;margin-bottom:0.5rem;}

/* Feed */
.feed{display:flex;flex-direction:column;gap:2rem;padding:1rem;max-width:900px;margin:auto;}
.trend-card{background:var(--card);border-radius:1.5rem;overflow:hidden;position:relative;box-shadow:0 0 25px rgba(30,144,255,0.2);transition:0.3s;}
.trend-card:hover{transform:scale(1.01);}
.trend-card video,.trend-card img{width:100%;height:60vh;object-fit:cover;border-radius:1.5rem;}
.trend-info{margin-top:0.5rem;padding:0 1rem;}
.trend-info h2{font-size:1.3rem;margin-bottom:0.3rem;color:var(--primary);}
.trend-info p{font-size:1rem;color:#ccc;margin-bottom:0.5rem;}
.trend-actions{display:flex;gap:1rem;padding:0 1rem;margin-bottom:0.5rem;}
.action-btn{background:linear-gradient(145deg,var(--primary),var(--secondary));width:45px;height:45px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.2rem;cursor:pointer;box-shadow:0 0 15px rgba(30,144,255,0.8);transition:transform 0.2s;}
.action-btn:hover{transform:scale(1.1);}

/* Post button */
.post-btn{position:fixed;bottom:2rem;right:2rem;background:linear-gradient(145deg,var(--secondary),var(--primary));color:white;font-size:1.6rem;width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;box-shadow:0 0 25px rgba(255,30,100,0.9);cursor:pointer;transition:all 0.3s ease;z-index:200;animation:pulse 2s infinite;}
@keyframes pulse{0%{box-shadow:0 0 15px rgba(30,144,255,0.6);}50%{box-shadow:0 0 35px rgba(255,30,100,1);}100%{box-shadow:0 0 15px rgba(30,144,255,0.6);}}
</style>
</head>
<body>

<header>
  <button id="menuBtn">☰</button>
  <h1>🔥 TrendTime AI</h1>
  <button id="authBtn">Login</button>
</header>

<div class="side-panel" id="sidePanel">
  <h2>Welcome</h2>
  <p id="userEmail">Not logged in</p>
  <input type="text" id="username" placeholder="Username"/>
  <input type="email" id="email" placeholder="Email"/>
  <input type="password" id="password" placeholder="Password (optional)"/>
  <button id="magicLinkBtn">Send Magic Link</button>
  <button id="signUpBtn">Sign Up / Login</button>

  <div class="settings-section">
    <h3>Record & Post a Trend</h3>
    <video id="preview" autoplay muted></video>
    <div style="display:flex;gap:0.5rem;margin-bottom:0.5rem;">
      <button id="recordBtn">Start Recording</button>
      <button id="stopBtn">Stop & Upload</button>
    </div>
    <input id="postCaption" type="text" placeholder="Caption">
  </div>

  <div class="settings-section">
    <h3>AI Tools</h3>
    <input type="text" id="aiPrompt" placeholder="Prompt for AI Image">
    <button id="aiImageBtn">Generate AI Image</button>
    <button id="aiCaptionBtn">Generate Caption</button>
  </div>
</div>

<main class="feed"></main>
<div class="post-btn" id="postBtn">➕</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl="https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase=createClient(supabaseUrl,supabaseKey);

const menuBtn=document.getElementById("menuBtn");
const sidePanel=document.getElementById("sidePanel");
const authBtn=document.getElementById("authBtn");
const magicLinkBtn=document.getElementById("magicLinkBtn");
const signUpBtn=document.getElementById("signUpBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userEmail=document.getElementById("userEmail");
const postBtn=document.getElementById("postBtn");

const recordBtn=document.getElementById("recordBtn");
const stopBtn=document.getElementById("stopBtn");
const preview=document.getElementById("preview");
const postCaption=document.getElementById("postCaption");

const aiImageBtn=document.getElementById("aiImageBtn");
const aiCaptionBtn=document.getElementById("aiCaptionBtn");
const aiPrompt=document.getElementById("aiPrompt");

const feed=document.querySelector(".feed");

let mediaRecorder, recordedBlobs=[];
let currentUser=null;

// Menu toggle
menuBtn.addEventListener("click",()=>{sidePanel.classList.toggle("active");});
document.addEventListener("click",e=>{if(sidePanel.classList.contains("active")&&!sidePanel.contains(e.target)&&e.target!==menuBtn){sidePanel.classList.remove("active");}});

// Magic link
magicLinkBtn.onclick=async()=>{
  const email=document.getElementById("email").value.trim();
  const username=document.getElementById("username").value.trim();
  if(!email || !username){alert("Enter email & username"); return;}
  const { error }=await supabase.auth.signInWithOtp({email, options:{data:{username}}});
  if(error) alert(error.message);
  else alert("Magic link sent!");
}

// Signup/Login
signUpBtn.onclick=async()=>{
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value.trim();
  const username=document.getElementById("username").value.trim();
  if(!email || !username){alert("Enter email & username"); return;}
  let { data, error }=await supabase.auth.signInWithPassword({email,password});
  if(error){
    let { error: signUpError }=await supabase.auth.signUp({email,password,options:{data:{username}}});
    if(signUpError){alert(signUpError.message); return;}
    await supabase.auth.signInWithPassword({email,password});
  }
  currentUser=(await supabase.auth.getUser()).data.user;
  userEmail.textContent=currentUser.user_metadata.username||currentUser.email;
  authBtn.style.display="none";
  postBtn.style.display="flex";
  loadFeed();
}

// Recording
recordBtn.onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  preview.srcObject=stream;
  recordedBlobs=[];
  mediaRecorder=new MediaRecorder(stream);
  mediaRecorder.ondataavailable=e=>{if(e.data.size>0) recordedBlobs.push(e.data);}
  mediaRecorder.start();
  alert("Recording started!");
}

stopBtn.onclick=async()=>{
  mediaRecorder.stop();
  const blob=new Blob(recordedBlobs,{type:"video/webm"});
  const file=new File([blob],`trend_${Date.now()}.webm`,{type:"video/webm"});
  if(!currentUser){alert("Login first"); return;}
  const { error }=await supabase.storage.from("trend-media").upload(file.name,file,{upsert:true});
  if(error){alert(error.message); return;}
  const url=supabase.storage.from("trend-media").getPublicUrl(file.name).data.publicUrl;
  await supabase.from("trends").insert([{url,caption:postCaption.value||"",type:"video",username:currentUser.user_metadata.username}]);
  alert("Trend posted!");
  postCaption.value="";
  preview.srcObject=null;
  loadFeed();
}

// AI Image
aiImageBtn.onclick=()=>{
  const prompt=aiPrompt.value.trim();
  if(!prompt){alert("Enter prompt"); return;}
  const url=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  window.open(url,"_blank");
}

// AI Caption
aiCaptionBtn.onclick=()=>{
  postCaption.value="🔥 AI suggested caption!";
}

// Load Feed
async function loadFeed(){
  const { data,error }=await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); return;}
  feed.innerHTML="";
  data.forEach(post=>{
    const card=document.createElement("div");
    card.className="trend-card";
    if(post.type==="video") card.innerHTML=`<video src="${post.url}" autoplay muted loop></video>`;
    if(post.type==="image") card.innerHTML=`<img src="${post.url}"/>`;
    const info=document.createElement("div");
    info.className="trend-info";
    info.innerHTML=`<h2>@${post.username||"anon"}</h2><p>${post.caption||""}</p>`;
    const actions=document.createElement("div");
    actions.className="trend-actions";
    actions.innerHTML=`<div class="action-btn">❤️</div><div class="action-btn">💬</div>`;
    card.appendChild(info);
    card.appendChild(actions);
    feed.appendChild(card);
  });
}

</script>
</body>
</html>
