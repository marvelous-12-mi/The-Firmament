<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TrendTime â€” AI Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.7.0/dist/tf.min.js"></script>
<style>
:root{
  --bg:#f5f5f5; --card:#fff; --muted:#666;
  --accent1:#ff6a00; --accent2:#ff1f71; --glass: rgba(0,0,0,0.05);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background:var(--bg);color:#111;min-height:100vh;overflow-x:hidden;}
header{height:70px;display:flex;justify-content:space-between;align-items:center;padding:0 20px;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.1);position:sticky;top:0;z-index:50;}
header h1{font-size:1.6rem;font-weight:700;}
header .actions{display:flex;gap:12px;align-items:center;}
button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;transition:0.2s;}
button.btn:hover{opacity:0.85;}
.app{display:grid;grid-template-columns:1fr;gap:16px;padding:16px;}
@media(min-width:900px){.app{grid-template-columns:280px 1fr 300px;}}
.center{display:flex;flex-direction:column;gap:12px;}
.feed{flex:1;overflow-y:auto;scroll-snap-type:y mandatory;padding:8px;}
.post-card{position:relative;background:var(--card);margin-bottom:18px;border-radius:14px;overflow:hidden;scroll-snap-align:start;box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.post-media{width:100%;height:300px;object-fit:cover;background:#000;border-radius:12px;}
.post-info{padding:12px;}
.caption{color:var(--muted);}
input,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid #ccc;margin-bottom:10px;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:90;}
.modal{background:var(--card);padding:18px;border-radius:14px;width:90%;max-width:520px;box-shadow:0 0 20px rgba(0,0,0,0.1);}
video#recordPreview{width:100%;border-radius:12px;background:#000;}
.post-controls{display:flex;gap:10px;margin-top:6px;}
.post-controls button{flex:1;padding:6px;border-radius:12px;border:none;cursor:pointer;transition:0.2s;}
.post-controls button:hover{opacity:0.8;}
img.ai-image{width:100%;border-radius:12px;margin-top:8px;}
</style>
</head>
<body>

<header>
<h1>TrendTime</h1>
<div class="actions">
<button id="loginBtn" class="btn">Sign In / Sign Up</button>
<button id="postBtn" class="btn">New Post</button>
</div>
</header>

<div class="app">
<main class="center">
<div class="feed" id="feedWrap"></div>
</main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
<div class="modal" id="modalContent"></div>
</div>

<script type="module">
// -------- Supabase setup --------
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl = 'https://kpdgmbjdaynplyjacuxd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ';
const supabase = createClient(supabaseUrl, supabaseKey);

// -------- Global variables --------
let currentUser=null;
const feedWrap=document.getElementById('feedWrap');
const modalBackdrop=document.getElementById('modalBackdrop');
const modalContent=document.getElementById('modalContent');
const loginBtn=document.getElementById('loginBtn');
const postBtn=document.getElementById('postBtn');

// -------- Helpers --------
function toast(msg){alert(msg);}
function showModal(html){modalContent.innerHTML=html; modalBackdrop.style.display='flex';}
function closeModal(){modalBackdrop.style.display='none'; modalContent.innerHTML='';}
modalBackdrop.addEventListener('click',e=>{if(e.target===modalBackdrop) closeModal();});

// -------- Load feed --------
async function loadFeed(){
  feedWrap.innerHTML='';
  const {data,error}=await supabase.from('trends').select('*').order('created_at',{ascending:false});
  if(error){console.log(error);return;}
  data.forEach(post=>{
    const card=document.createElement('div'); card.className='post-card';
    if(post.type==='video'){
      const video=document.createElement('video'); video.src=post.url; video.controls=true; video.loop=true; video.muted=false; video.className='post-media';
      card.appendChild(video);
    }else if(post.type==='image'){
      const img=document.createElement('img'); img.src=post.url; img.className='post-media ai-image';
      card.appendChild(img);
    }
    const info=document.createElement('div'); info.className='post-info';
    info.innerHTML=`<div class="caption">${post.caption||''}</div>`;
    card.appendChild(info);
    feedWrap.appendChild(card);
  });
}
loadFeed();

// -------- Auth modal --------
loginBtn.onclick=()=>{
  showModal(`
    <h3>Sign In / Sign Up</h3>
    <input type="email" id="emailInput" placeholder="Email">
    <input type="password" id="passInput" placeholder="Password">
    <div style="display:flex;gap:8px;">
      <button id="signInBtn" class="btn">Sign In</button>
      <button id="signUpBtn" class="btn">Sign Up</button>
    </div>
  `);
  document.getElementById('signInBtn').onclick=async()=>{
    const email=document.getElementById('emailInput').value;
    const password=document.getElementById('passInput').value;
    if(!email||!password){toast("Enter email & password");return;}
    const {data,error}=await supabase.auth.signInWithPassword({email,password});
    if(error){toast(error.message);return;}
    currentUser=data.user;
    toast("Signed in: "+email);
    closeModal();
  };
  document.getElementById('signUpBtn').onclick=async()=>{
    const email=document.getElementById('emailInput').value;
    const password=document.getElementById('passInput').value;
    if(!email||!password){toast("Enter email & password");return;}
    const {data,error}=await supabase.auth.signUp({email,password});
    if(error){toast(error.message);return;}
    currentUser=data.user;
    toast("Account created: "+email);
    closeModal();
  };
};

// -------- Post modal --------
postBtn.onclick=()=>{
  if(!currentUser){toast("Sign in first!");return;}
  showModal(`
    <h3>New Post</h3>
    <input type="text" id="postCaption" placeholder="Caption">
    <input type="file" id="postFile">
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="aiCaptionBtn" class="btn">âœ¨ AI Caption</button>
      <button id="aiImageBtn" class="btn">ðŸŽ¨ Generate AI Image</button>
      <button id="submitPostBtn" class="btn">Post</button>
    </div>
    <div id="aiImagePreview"></div>
  `);

  const postFile=document.getElementById('postFile');
  const postCaption=document.getElementById('postCaption');
  const aiCaptionBtn=document.getElementById('aiCaptionBtn');
  const aiImageBtn=document.getElementById('aiImageBtn');
  const submitPostBtn=document.getElementById('submitPostBtn');
  const aiImagePreview=document.getElementById('aiImagePreview');

  aiCaptionBtn.onclick=async()=>{
    aiCaptionBtn.disabled=true; aiCaptionBtn.textContent='Thinking...';
    try{
      const prompt="Short catchy caption with emojis for a trending post";
      const res=await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
      const text=await res.text();
      postCaption.value=text.slice(0,120)||"ðŸ”¥ Trending!";
    }catch(e){console.log(e);}
    aiCaptionBtn.disabled=false; aiCaptionBtn.textContent='âœ¨ AI Caption';
  };

  aiImageBtn.onclick=async()=>{
    if(!postFile.files[0]){toast("Select file first");return;}
    aiImageBtn.disabled=true; aiImageBtn.textContent='Generating...';
    try{
      const prompt="Create an AI image based on this file";
      const file=postFile.files[0];
      const formData=new FormData();
      formData.append("file",file);
      formData.append("prompt",prompt);
      const res=await fetch("https://image.pollinations.ai/prompt",{method:"POST",body:formData});
      const blob=await res.blob();
      const url=URL.createObjectURL(blob);
      aiImagePreview.innerHTML=`<img src="${url}" class="ai-image">`;
    }catch(e){console.log(e);}
    aiImageBtn.disabled=false; aiImageBtn.textContent='ðŸŽ¨ Generate AI Image';
  };

  submitPostBtn.onclick=async()=>{
    if(!postFile.files[0]){toast("Select file"); return;}
    const file=postFile.files[0];
    const type=file.type.startsWith("video")?"video":"image";
    const fileName=`${Date.now()}_${file.name}`;
    const {error}=await supabase.storage.from('media').upload(fileName,file,{upsert:true});
    if(error){toast(error.message);return;}
    const {data}=supabase.storage.from('media').getPublicUrl(fileName);
    await supabase.from('trends').insert([{url:data.publicUrl,caption:postCaption.value,type}]);
    toast("Posted!");
    closeModal();
    loadFeed();
  };
};
</script>
</body>
</html>
