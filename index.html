<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TrendTime AI üî•</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --primary:#1e90ff;
  --secondary:#ff1493;
  --dark:#0f0f0f;
  --card:#1a1a1a;
  --accent:#00ffea;
  --light:#fff;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--dark);color:white;overflow-x:hidden;}
header{position:sticky;top:0;width:100%;z-index:100;background:linear-gradient(90deg,var(--primary),var(--secondary));display:flex;justify-content:space-between;align-items:center;padding:1rem 1.5rem;box-shadow:0 4px 20px rgba(0,0,0,0.6);}
header h1{font-size:1.6rem;font-weight:700;letter-spacing:1px;text-shadow:0 0 10px rgba(0,0,0,0.5);}
header button{background:white;color:var(--dark);border:none;padding:0.5rem 1rem;border-radius:999px;cursor:pointer;font-weight:bold;transition:0.3s;}
header button:hover{background:var(--secondary);color:white;}

/* Popup */
.popup-bg{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:500;}
.popup{background:var(--card);padding:2rem;border-radius:15px;width:90%;max-width:500px;box-shadow:0 0 25px rgba(30,144,255,0.4);position:relative;}
.popup h2{color:var(--accent);margin-bottom:1rem;}
.popup input, .popup textarea, .popup button{width:100%;margin:0.5rem 0;padding:0.7rem;border-radius:10px;border:none;background:#222;color:white;}
.popup input::placeholder, .popup textarea::placeholder{color:#aaa;}
.popup button{cursor:pointer;background:linear-gradient(145deg,var(--primary),var(--secondary));color:white;font-weight:bold;transition:0.3s;}
.popup button:hover{opacity:0.9;}
.popup .close-btn{position:absolute;top:10px;right:10px;background:red;color:white;width:30px;height:30px;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;font-weight:bold;}

/* Feed */
.feed{display:flex;flex-direction:column;gap:2rem;padding:1rem;max-width:900px;margin:auto;}
.trend-card{background:var(--card);border-radius:1.5rem;overflow:hidden;position:relative;box-shadow:0 0 25px rgba(30,144,255,0.2);transition:0.3s;}
.trend-card:hover{transform:scale(1.01);}
.trend-card video,.trend-card img{width:100%;height:60vh;object-fit:cover;border-radius:1.5rem;}
.trend-info{margin-top:0.5rem;padding:0 1rem;}
.trend-info h2{font-size:1.3rem;margin-bottom:0.3rem;color:var(--primary);}
.trend-info p{font-size:1rem;color:#ccc;margin-bottom:0.5rem;}
.trend-actions{display:flex;gap:1rem;padding:0 1rem;margin-bottom:0.5rem;}
.action-btn{background:linear-gradient(145deg,var(--primary),var(--secondary));width:45px;height:45px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.2rem;cursor:pointer;box-shadow:0 0 15px rgba(30,144,255,0.8);transition:transform 0.2s;}
.action-btn:hover{transform:scale(1.1);}

/* Post button */
.post-btn{position:fixed;bottom:2rem;right:2rem;background:linear-gradient(145deg,var(--secondary),var(--primary));color:white;font-size:1.6rem;width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;box-shadow:0 0 25px rgba(255,30,100,0.9);cursor:pointer;transition:all 0.3s ease;z-index:200;animation:pulse 2s infinite;}
@keyframes pulse{0%{box-shadow:0 0 15px rgba(30,144,255,0.6);}50%{box-shadow:0 0 35px rgba(255,30,100,1);}100%{box-shadow:0 0 15px rgba(30,144,255,0.6);}}
</style>
</head>
<body>

<header>
  <h1>üî• TrendTime AI</h1>
  <button id="authBtn">Login</button>
</header>

<div class="popup-bg" id="popupBg">
  <div class="popup">
    <div class="close-btn" id="closePopup">√ó</div>
    <h2>Post a Trend</h2>
    <input type="text" id="popupUsername" placeholder="Username"/>
    <input type="email" id="popupEmail" placeholder="Email"/>
    <input type="password" id="popupPassword" placeholder="Password (optional)"/>
    <button id="popupMagicLink">Send Magic Link</button>
    <textarea id="popupCaption" placeholder="Caption..."></textarea>
    <input type="text" id="popupPrompt" placeholder="AI Image Prompt..."/>
    <button id="popupGenImage">Generate Image</button>
    <div id="popupPreview" style="margin-top:1rem;"></div>
    <button id="popupPost">Post Trend</button>
  </div>
</div>

<main class="feed"></main>
<div class="post-btn" id="postBtn">‚ûï</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabaseUrl="https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase=createClient(supabaseUrl,supabaseKey);

const postBtn=document.getElementById("postBtn");
const popupBg=document.getElementById("popupBg");
const closePopup=document.getElementById("closePopup");
const popupUsername=document.getElementById("popupUsername");
const popupEmail=document.getElementById("popupEmail");
const popupPassword=document.getElementById("popupPassword");
const popupMagicLink=document.getElementById("popupMagicLink");
const popupCaption=document.getElementById("popupCaption");
const popupPrompt=document.getElementById("popupPrompt");
const popupGenImage=document.getElementById("popupGenImage");
const popupPreview=document.getElementById("popupPreview");
const popupPost=document.getElementById("popupPost");
const authBtn=document.getElementById("authBtn");
const feed=document.querySelector(".feed");

let currentUser=null;
let generatedImage=null;

// Open popup
postBtn.onclick=()=>{popupBg.style.display="flex";}
closePopup.onclick=()=>{popupBg.style.display="none";popupPreview.innerHTML="";generatedImage=null;};

// Magic link
popupMagicLink.onclick=async()=>{
  const email=popupEmail.value.trim();
  const username=popupUsername.value.trim();
  if(!email||!username){alert("Enter email & username"); return;}
  const { error }=await supabase.auth.signInWithOtp({email,options:{data:{username}}});
  if(error){alert(error.message);} else{alert("Magic link sent! Check your email.");}
}

// Signup/Login
authBtn.onclick=async()=>{
  const email=popupEmail.value.trim();
  const password=popupPassword.value.trim();
  const username=popupUsername.value.trim();
  if(!email||!username){alert("Enter email & username"); return;}
  let { data,error }=await supabase.auth.signInWithPassword({email,password});
  if(error){
    let { error: signUpError }=await supabase.auth.signUp({email,password,options:{data:{username}}});
    if(signUpError){alert(signUpError.message); return;}
    await supabase.auth.signInWithPassword({email,password});
  }
  currentUser=(await supabase.auth.getUser()).data.user;
  alert("Logged in as "+currentUser.user_metadata.username);
}

// Generate AI image
popupGenImage.onclick=()=>{
  const prompt=popupPrompt.value.trim();
  if(!prompt){alert("Enter a prompt"); return;}
  generatedImage=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  popupPreview.innerHTML=`<img src="${generatedImage}" style="width:100%;border-radius:10px;">`;
}

// Post trend
popupPost.onclick=async()=>{
  if(!currentUser){alert("Login first"); return;}
  let url=generatedImage||null;
  if(url){
    const resp=await fetch(url);
    const blob=await resp.blob();
    const fileName=`image-${Date.now()}.png`;
    const { error }=await supabase.storage.from("trend-media").upload(fileName,blob,{upsert:true});
    if(error){alert(error.message); return;}
    url=supabase.storage.from("trend-media").getPublicUrl(fileName).data.publicUrl;
    generatedImage=null;
  }
  const caption=popupCaption.value.trim();
  await supabase.from("trends").insert([{username:currentUser.user_metadata.username,url,caption,type:"image"}]);
  popupCaption.value=""; popupPrompt.value=""; popupPreview.innerHTML=""; popupBg.style.display="none";
  alert("Trend posted!");
  loadFeed();
}

// Load feed
async function loadFeed(){
  const { data,error }=await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); return;}
  feed.innerHTML="";
  data.forEach(post=>{
    const card=document.createElement("div");
    card.className="trend-card";
    if(post.type==="image") card.innerHTML=`<img src="${post.url}">`;
    if(post.type==="video") card.innerHTML=`<video src="${post.url}" autoplay muted loop></video>`;
    const info=document.createElement("div");
    info.className="trend-info";
    info.innerHTML=`<h2>@${post.username||"anon"}</h2><p>${post.caption||""}</p>`;
    const actions=document.createElement("div");
    actions.className="trend-actions";
    actions.innerHTML=`<div class="action-btn">‚ù§Ô∏è</div><div class="action-btn">üí¨</div>`;
    card.appendChild(info); card.appendChild(actions);
    feed.appendChild(card);
  });
}

loadFeed();
</script>
</body>
</html>
