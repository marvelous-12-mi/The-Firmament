<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrendTime AI üî•</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
:root {
  --primary: #ff6a00;
  --secondary: #ff1f71;
  --dark: #0f0f0f;
  --card: #1a1a1a;
  --accent: #00ffea;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--dark);color:white;overflow-x:hidden;}
header{position:sticky;top:0;width:100%;z-index:100;background:linear-gradient(90deg,var(--primary),var(--secondary));display:flex;justify-content:space-between;align-items:center;padding:0.8rem 1rem;box-shadow:0 4px 20px rgba(0,0,0,0.6);}
header h1{font-size:1.5rem;font-weight:700;letter-spacing:1px;text-shadow:0 0 10px rgba(0,0,0,0.5);}
header button{background:white;color:var(--dark);border:none;padding:0.5rem 1rem;border-radius:999px;cursor:pointer;font-weight:bold;transition:0.3s;}
header button:hover{background:var(--secondary);color:white;}

.side-panel{position:fixed;top:0;left:-320px;width:300px;height:100vh;background:var(--card);box-shadow:5px 0 20px rgba(0,0,0,0.6);transition:left 0.3s ease;padding:2rem 1rem;z-index:200;overflow-y:auto;}
.side-panel.active{left:0;}
.side-panel h2,h3{margin-bottom:1rem;}
.side-panel input,.side-panel select,.side-panel button{margin:0.5rem 0;padding:0.5rem;width:100%;border-radius:6px;border:none;}

.feed{display:flex;flex-direction:column;gap:2rem;padding:1rem;max-width:800px;margin:auto;}
.trend-card{background:var(--card);border-radius:1.5rem;overflow:hidden;position:relative;box-shadow:0 0 30px rgba(255,106,0,0.2);transition:0.3s;}
.trend-card:hover{transform:scale(1.01);}
.trend-card video,.trend-card canvas{width:100%;height:60vh;object-fit:cover;border-radius:1.5rem;}
.trend-info{position:absolute;bottom:0;left:0;width:100%;padding:1rem;background:linear-gradient(to top,rgba(0,0,0,0.8),transparent);}
.trend-info h2{font-size:1.2rem;margin-bottom:0.3rem;}
.trend-info p{font-size:0.95rem;opacity:0.9;}
.trend-actions{position:absolute;right:1rem;bottom:20%;display:flex;flex-direction:column;gap:1rem;align-items:center;}
.action-btn{background:linear-gradient(145deg,var(--primary),var(--secondary));width:55px;height:55px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.3rem;cursor:pointer;box-shadow:0 0 15px rgba(255,106,0,0.8);transition:transform 0.2s;}
.action-btn:hover{transform:scale(1.1);}
.post-btn{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:linear-gradient(145deg,var(--secondary),var(--primary));color:white;font-size:1.5rem;width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;box-shadow:0 0 25px rgba(255,30,100,0.9);cursor:pointer;transition:all 0.3s ease;z-index:200;animation:pulse 2s infinite;}
@keyframes pulse{0%{box-shadow:0 0 15px rgba(255,106,0,0.6);}50%{box-shadow:0 0 35px rgba(255,30,100,1);}100%{box-shadow:0 0 15px rgba(255,106,0,0.6);}}
.settings-section{margin-top:2rem;padding-top:1rem;border-top:1px solid rgba(255,255,255,0.2);}
</style>
</head>
<body>

<header>
  <button id="menuBtn">‚ò∞</button>
  <h1>üî• TrendTime AI</h1>
  <button id="authBtn">Login</button>
</header>

<div class="side-panel" id="sidePanel">
  <h2>Welcome</h2>
  <p id="userEmail">Not logged in</p>
  <button id="logoutBtn">Logout</button>

  <div class="settings-section">
    <h3>Record & Post a Trend</h3>
    <video id="preview" autoplay muted style="width:100%;border-radius:10px;margin-bottom:0.5rem;"></video>
    <button id="recordBtn">Start Recording</button>
    <button id="stopBtn">Stop & Upload</button>
    <input id="postCaption" type="text" placeholder="Caption (optional)">
    <select id="videoFilter">
      <option value="none">No Filter</option>
      <option value="mosaic">Mosaic</option>
      <option value="edges">Edges</option>
    </select>
    <button id="postSubmit">Post</button>
  </div>

  <div class="settings-section">
    <h3>Profile Settings</h3>
    <input type="text" id="username" placeholder="Username">
    <input type="file" id="avatarUpload" accept="image/*">
    <button id="saveProfile">Save Profile</button>
  </div>

  <div class="settings-section">
    <h3>AI Tools</h3>
    <button id="aiCaptionBtn">Generate Caption for Last Video</button>
    <button id="aiImageBtn">Generate AI Image</button>
    <input type="text" id="aiPrompt" placeholder="Prompt for AI Image">
  </div>
</div>

<main class="feed"></main>
<div class="post-btn" id="postBtn">‚ûï</div>

<script type="module">
// === Supabase ===
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabaseUrl = "https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
const supabase = createClient(supabaseUrl,supabaseKey);

// === Elements ===
const menuBtn = document.getElementById("menuBtn");
const sidePanel = document.getElementById("sidePanel");
const authBtn = document.getElementById("authBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userEmail = document.getElementById("userEmail");
const postBtn = document.getElementById("postBtn");
const postSubmit = document.getElementById("postSubmit");
const postCaption = document.getElementById("postCaption");
const videoFilter = document.getElementById("videoFilter");
const preview = document.getElementById("preview");

// === Menu Toggle ===
menuBtn.addEventListener("click",()=>{sidePanel.classList.toggle("active");});
document.addEventListener("click",(e)=>{if(sidePanel.classList.contains("active")&&!sidePanel.contains(e.target)&&e.target!==menuBtn){sidePanel.classList.remove("active");}});

// === Auth ===
authBtn.addEventListener("click",async()=>{
  const { data, error } = await supabase.auth.signInWithOAuth({ provider:"google" });
  if(error) console.error(error);
});
logoutBtn.addEventListener("click",async()=>{await supabase.auth.signOut(); updateUserUI(null);});

async function updateUserUI(session){
  if(session?.user){userEmail.textContent=session.user.email;authBtn.style.display="none";logoutBtn.style.display="block";}
  else{userEmail.textContent="Not logged in";authBtn.style.display="block";logoutBtn.style.display="none";}
}
supabase.auth.onAuthStateChange((_event,session)=>{updateUserUI(session); loadFeed();});

// === Feed ===
const feed = document.querySelector(".feed");
async function loadFeed(){
  const { data,error } = await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); return;}
  feed.innerHTML="";
  data.forEach(post=>{
    const card=document.createElement("div"); card.className="trend-card";
    const media=document.createElement("video"); media.src=post.url; media.autoplay=true; media.loop=true; media.muted=true; media.className="trend-media";
    card.appendChild(media);
    const info=document.createElement("div"); info.className="trend-info";
    info.innerHTML=`<h2>@${post.username||"anon"}</h2><p>${post.caption||""}</p>`;
    card.appendChild(info);
    const actions=document.createElement("div"); actions.className="trend-actions";
    actions.innerHTML=`<div class="action-btn">‚ù§Ô∏è</div><div class="action-btn">üí¨</div><div class="action-btn">üóëÔ∏è</div>`;
    card.appendChild(actions);
    feed.appendChild(card);
  });
}

// === Recording ===
let mediaRecorder, recordedBlobs=[];
document.getElementById("recordBtn").onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  preview.srcObject=stream; preview.play();
  recordedBlobs=[]; mediaRecorder=new MediaRecorder(stream);
  mediaRecorder.ondataavailable=e=>{if(e.data && e.data.size>0) recordedBlobs.push(e.data);}
  mediaRecorder.start();
};
document.getElementById("stopBtn").onclick=async()=>{
  mediaRecorder.stop();
  const blob=new Blob(recordedBlobs,{type:"video/webm"});
  const file=new File([blob],"trend_"+Date.now()+".webm",{type:"video/webm"});
  const session = (await supabase.auth.getSession()).data.session;
  if(!session){alert("Login required"); return;}
  const { data, error } = await supabase.storage.from("videos").upload(file.name,file);
  if(error){console.error(error); return;}
  const url = supabase.storage.from("videos").getPublicUrl(file.name).data.publicUrl;
  await supabase.from("trends").insert([{url,caption:postCaption.value,type:"video",username:session.user.email.split("@")[0]}]);
  loadFeed();
};

// === Post Submit ===
postSubmit.addEventListener("click",async()=>{
  const session = (await supabase.auth.getSession()).data.session;
  if(!session){alert("Login required"); return;}
  const url = postCaption.value; // placeholder, real URL comes from recording
  alert("Use Record button to post videos!");
});

// === AI Caption (Pollinations) ===
document.getElementById("aiCaptionBtn").onclick=async()=>{
  const lastVideo = feed.querySelector("video");
  if(!lastVideo){alert("Record a video first"); return;}
  const prompt="Describe this video in a trendy caption";
  const res = await fetch(`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`);
  alert("AI caption generated! Paste it: " + prompt);
};

// === AI Image Generation (Pollinations) ===
document.getElementById("aiImageBtn").onclick=async()=>{
  const prompt=document.getElementById("aiPrompt").value;
  if(!prompt){alert("Enter a prompt"); return;}
  const url=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  window.open(url,"_blank");
};

// === Initialize ===
loadFeed();
</script>

</body>
</html>
