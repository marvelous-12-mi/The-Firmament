<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üî• TrendTime AI Swipe Feed</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
:root{--orange:#ff6a00;--pink:#ff1f71;--dark:#0f0f0f;--card:#1a1a1a;}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--dark);color:white;overflow-x:hidden;}
header{position:sticky;top:0;width:100%;z-index:100;background:linear-gradient(90deg,var(--orange),var(--pink));display:flex;justify-content:space-between;align-items:center;padding:.7rem 1rem;box-shadow:0 4px 20px rgba(0,0,0,.6);}
header h1{font-size:1.4rem;font-weight:700;letter-spacing:1px;}
header button{background:white;color:var(--dark);border:none;padding:.5rem 1rem;border-radius:999px;font-weight:bold;cursor:pointer;transition:.3s;}
header button:hover{background:var(--pink);color:white;}
.side-panel{position:fixed;top:0;left:-320px;width:300px;height:100vh;background:var(--card);box-shadow:5px 0 20px rgba(0,0,0,.6);transition:left .3s;padding:2rem 1rem;z-index:200;overflow-y:auto;}
.side-panel.active{left:0;}
.side-panel h2,h3{margin-bottom:.5rem;}
.side-panel input{width:100%;margin:.5rem 0;padding:.5rem;border-radius:8px;border:none;}
.side-panel button{margin-top:.5rem;width:100%;padding:.5rem;border:none;border-radius:8px;cursor:pointer;}
.feed{display:flex;flex-direction:column;gap:2rem;padding:1rem;scroll-snap-type:y mandatory;overflow-y:auto;height:calc(100vh - 60px);}
.trend-card{background:var(--card);border-radius:1.5rem;overflow:hidden;position:relative;box-shadow:0 0 30px rgba(255,106,0,.2);scroll-snap-align:start;}
.trend-card video,.trend-card iframe{width:100%;height:70vh;object-fit:cover;border-radius:12px;}
.trend-info{position:absolute;bottom:0;left:0;width:100%;padding:1rem;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);}
.trend-info h2{font-size:1.2rem;margin-bottom:.5rem;}
.trend-actions{position:absolute;right:1rem;bottom:25%;display:flex;flex-direction:column;gap:1rem;align-items:center;}
.action-btn{background:linear-gradient(145deg,var(--orange),var(--pink));width:50px;height:50px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.3rem;cursor:pointer;box-shadow:0 0 15px rgba(255,106,0,.8);transition:transform .2s;}
.action-btn:hover{transform:scale(1.1);}
.comment-section{background:rgba(0,0,0,.5);padding:.5rem;margin-top:.5rem;border-radius:8px;max-height:120px;overflow-y:auto;}
.comment{padding:.3rem 0;border-bottom:1px solid rgba(255,255,255,.1);}
.comment-input{display:flex;gap:.3rem;margin-top:.5rem;}
.comment-input input{flex:1;padding:.3rem;border-radius:8px;border:none;}
.comment-input button{padding:.3rem .6rem;border:none;border-radius:8px;background:var(--pink);color:white;cursor:pointer;}
.post-btn{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:linear-gradient(145deg,var(--pink),var(--orange));color:white;font-size:1.5rem;width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;box-shadow:0 0 25px rgba(255,30,100,.9);cursor:pointer;transition: all .3s ease;z-index:200;animation:pulse 2s infinite;}
@keyframes pulse{0%{box-shadow:0 0 15px rgba(255,106,0,.6);}50%{box-shadow:0 0 35px rgba(255,30,100,1);}100%{box-shadow:0 0 15px rgba(255,106,0,.6);}}
</style>
</head>
<body>

<header>
  <button id="menuBtn">‚ò∞</button>
  <h1>üî• TrendTime AI</h1>
  <button id="authBtn">Login</button>
</header>

<div class="side-panel" id="sidePanel">
  <h2>Welcome</h2>
  <p id="userEmail">Not logged in</p>
  <input id="usernameInput" placeholder="Username">
  <input id="avatarInput" placeholder="Profile picture URL">
  <button id="logoutBtn">Logout</button>

  <h3>Record & Post</h3>
  <video id="preview" autoplay muted style="width:100%;border-radius:12px;"></video>
  <div style="display:flex;gap:.5rem;margin:.5rem 0;">
    <button id="startRecord">Start</button>
    <button id="stopRecord">Stop & Upload</button>
  </div>

  <input id="postCaption" type="text" placeholder="Caption">
  <div style="display:flex;gap:.5rem;margin-bottom:.5rem;">
    <button id="aiCaptionBtn">üé® AI Caption</button>
    <button id="aiImageBtn">üñºÔ∏è AI Cover</button>
  </div>
  <button id="postSubmit">Post URL/YouTube</button>
</div>

<main class="feed"></main>
<div class="post-btn" id="postBtn">‚ûï</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl, supabaseKey);
const POLL_KEY="Rn_w_0CKwDcPACXL";

const menuBtn=document.getElementById("menuBtn");
const sidePanel=document.getElementById("sidePanel");
const authBtn=document.getElementById("authBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userEmail=document.getElementById("userEmail");
const feed=document.querySelector(".feed");
const postBtn=document.getElementById("postBtn");
const postCaption=document.getElementById("postCaption");
const usernameInput=document.getElementById("usernameInput");
const avatarInput=document.getElementById("avatarInput");
const aiCaptionBtn=document.getElementById("aiCaptionBtn");
const aiImageBtn=document.getElementById("aiImageBtn");
const startRecordBtn=document.getElementById("startRecord");
const stopRecordBtn=document.getElementById("stopRecord");
const preview=document.getElementById("preview");
const postSubmit=document.getElementById("postSubmit");

// Menu toggle
menuBtn.addEventListener("click",()=>sidePanel.classList.toggle("active"));
document.addEventListener("click",(e)=>{if(sidePanel.classList.contains("active")&&!sidePanel.contains(e.target)&&e.target!==menuBtn) sidePanel.classList.remove("active");});

// Auth
authBtn.addEventListener("click",async()=>{
  const email=prompt("Email:"); const password=prompt("Password:");
  if(!email||!password) return;
  const { error } = await supabase.auth.signInWithPassword({email,password});
  if(error) return alert("Login error: "+error.message);
  handleAuth();
});
logoutBtn.addEventListener("click",async()=>{await supabase.auth.signOut();handleAuth();});

async function handleAuth(){
  const { data } = await supabase.auth.getSession();
  const user=data.session?.user;
  if(user){
    userEmail.textContent=user.email;
    authBtn.style.display="none"; logoutBtn.style.display="block";
    await ensureProfile(user);
  }else{
    userEmail.textContent="Not logged in"; authBtn.style.display="block"; logoutBtn.style.display="none";
  }
}
async function ensureProfile(user){
  let { data } = await supabase.from("profiles").select("*").eq("id",user.id);
  if(!data.length) await supabase.from("profiles").insert([{id:user.id,username:"anon",avatar:""}]);
}

// Feed loader with shuffle
async function loadFeed(){
  let { data,error } = await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error) return console.error(error);
  data.sort(()=>Math.random()-0.5); // shuffle
  feed.innerHTML="";
  data.forEach(post=>{
    const card=document.createElement("div"); card.className="trend-card";
    let media;
    if(post.type==="youtube"){media=document.createElement("iframe");media.src=post.url;media.setAttribute("allowfullscreen",true);}
    else{media=document.createElement("video");media.src=post.url;media.autoplay=true;media.loop=true;media.muted=true;}
    card.appendChild(media);
    const info=document.createElement("div"); info.className="trend-info";
    info.innerHTML=`<h2>@${post.username}</h2><p>${post.caption}</p>`;
    card.appendChild(info);
    const actions=document.createElement("div"); actions.className="trend-actions";
    actions.innerHTML=`<div class="action-btn" onclick="deleteTrend('${post.id}')">üóëÔ∏è</div>
      <div class="action-btn" onclick="likeTrend('${post.id}')">‚ù§Ô∏è</div>`;
    card.appendChild(actions);

    // Comments
    const commentSection=document.createElement("div"); commentSection.className="comment-section";
    post.comments?.forEach(c=>{const div=document.createElement("div");div.className="comment";div.textContent=c;commentSection.appendChild(div);});
    const inputDiv=document.createElement("div"); inputDiv.className="comment-input";
    const input=document.createElement("input"); input.placeholder="Add comment...";
    const btn=document.createElement("button"); btn.textContent="Send";
    btn.onclick=async()=>{await supabase.from("trends").update({comments:[...(post.comments||[]),input.value]}).eq("id",post.id);loadFeed();};
    inputDiv.appendChild(input); inputDiv.appendChild(btn); commentSection.appendChild(inputDiv);
    card.appendChild(commentSection);

    feed.appendChild(card);
  });
  initVideoObserver();
}

// Video recording
let recorder, chunks=[], stream;
startRecordBtn.addEventListener("click", async ()=>{
  stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  preview.srcObject=stream;
  recorder = new MediaRecorder(stream);
  chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.start();
});
stopRecordBtn.addEventListener("click", async ()=>{
  recorder.stop();
  recorder.onstop=async()=>{
    const blob=new Blob(chunks,{type:'video/mp4'});
    const { data,error } = await supabase.storage.from("videos").upload(`video_${Date.now()}.mp4`,blob);
    if(error) return alert("Upload failed:"+error.message);
    await supabase.from("trends").insert([{url:supabase.storage.from("videos").getPublicUrl(data.path).publicURL,type:"video",caption:postCaption.value,username:usernameInput.value||"anon",avatar:avatarInput.value||""}]);
    alert("Video uploaded!");
    loadFeed();
  };
  stream.getTracks().forEach(t=>t.stop());
});

// AI Caption
aiCaptionBtn.addEventListener("click", async ()=>{
  const res=await fetch("https://api.pollinations.ai/caption",{method:"POST",headers:{"Authorization":"Bearer "+POLL_KEY,"Content-Type":"application/json"},body:JSON.stringify({prompt:"Write a catchy trending short video caption"})});
  const data=await res.json();
  postCaption.value=data?.caption||"üî• Trend!";
});
aiImageBtn.addEventListener("click",async()=>{alert("AI Cover generated! (preview not implemented)");});
postSubmit.addEventListener("click", async ()=>{
  const url = prompt("Enter video/YT URL:"); if(!url) return;
  await supabase.from("trends").insert([{url,type:url.includes("youtube")?"youtube":"video",caption:postCaption.value||"",username:usernameInput.value||"anon",avatar:avatarInput.value||""}]);
  loadFeed();
});
window.deleteTrend=async(id)=>{await supabase.from("trends").delete().eq("id",id);loadFeed();}
window.likeTrend=async(id)=>{const {data}=await supabase.from("trends").select("likes").eq("id",id).single();await supabase.from("trends").update({likes:(data.likes||0)+1}).eq("id",id);loadFeed();}

// Auto play observer
function initVideoObserver(){
  const videos=document.querySelectorAll(".trend-card video");
  const observer=new IntersectionObserver(entries=>{entries.forEach(e=>{if(e.isIntersecting)e.target.play().catch(()=>{});else e.target.pause();});},{threshold:0.6});
  videos.forEach(v=>observer.observe(v));
}

handleAuth(); loadFeed();
</script>
</body>
</html>
