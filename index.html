<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>üî• TrendTime AI</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
<style>
:root {
  --orange:#ff6a00; --pink:#ff1f71; --dark:#0f0f0f; --card:#1a1a1a;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--dark);color:white;overflow-x:hidden;}
header{position:sticky;top:0;width:100%;z-index:100;background:linear-gradient(90deg,var(--orange),var(--pink));display:flex;justify-content:space-between;align-items:center;padding:.7rem 1rem;box-shadow:0 4px 20px rgba(0,0,0,.6);}
header h1{font-size:1.4rem;font-weight:700;letter-spacing:1px;}
header button{background:white;color:var(--dark);border:none;padding:.5rem 1rem;border-radius:999px;font-weight:bold;cursor:pointer;transition:.3s;}
header button:hover{background:var(--pink);color:white;}
.side-panel{position:fixed;top:0;left:-300px;width:280px;height:100vh;background:var(--card);box-shadow:5px 0 20px rgba(0,0,0,.6);transition:left .3s;padding:2rem 1rem;z-index:200;overflow-y:auto;}
.side-panel.active{left:0;}
.side-panel h2,h3{margin-bottom:.5rem;}
.side-panel input{width:100%;margin:.5rem 0;padding:.5rem;border-radius:8px;border:none;}
.side-panel button{margin-top:.5rem;width:100%;padding:.5rem;border:none;border-radius:8px;cursor:pointer;}
.feed{display:flex;flex-direction:column;gap:2rem;padding:1rem;}
.trend-card{background:var(--card);border-radius:1.5rem;overflow:hidden;position:relative;box-shadow:0 0 30px rgba(255,106,0,.2);}
.trend-card video,.trend-card iframe{width:100%;height:70vh;object-fit:cover;border-radius:1.2rem;}
.trend-info{position:absolute;bottom:0;left:0;width:100%;padding:1rem;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);}
.trend-info h2{font-size:1.2rem;margin-bottom:.5rem;}
.trend-actions{position:absolute;right:1rem;bottom:20%;display:flex;flex-direction:column;gap:1.2rem;align-items:center;}
.action-btn{background:linear-gradient(145deg,var(--orange),var(--pink));width:55px;height:55px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.3rem;cursor:pointer;box-shadow:0 0 15px rgba(255,106,0,.8);transition:transform .2s;}
.action-btn:hover{transform:scale(1.1);}
.post-btn{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:linear-gradient(145deg,var(--pink),var(--orange));color:white;font-size:1.5rem;width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;box-shadow:0 0 25px rgba(255,30,100,.9);cursor:pointer;transition:all .3s ease;z-index:200;animation:pulse 2s infinite;}
@keyframes pulse{0%{box-shadow:0 0 15px rgba(255,106,0,.6);}50%{box-shadow:0 0 35px rgba(255,30,100,1);}100%{box-shadow:0 0 15px rgba(255,106,0,.6);}}
.ai-panel{margin-top:1rem;display:flex;gap:.5rem;flex-wrap:wrap;}
.ai-panel button{flex:1;padding:.5rem;border-radius:8px;border:none;background:var(--pink);color:white;font-weight:600;cursor:pointer;}
.search-bar{width:100%;padding:.5rem;margin-bottom:1rem;border-radius:8px;border:none;}
.comment-section{background:rgba(0,0,0,.5);padding:.5rem;margin-top:.5rem;border-radius:8px;}
.comment{padding:.3rem 0;border-bottom:1px solid rgba(255,255,255,.1);}
</style>
</head>
<body>

<header>
  <button id="menuBtn">‚ò∞</button>
  <h1>üî• TrendTime AI</h1>
  <button id="authBtn">Login</button>
</header>

<div class="side-panel" id="sidePanel">
  <h2>Welcome</h2>
  <p id="userEmail">Not logged in</p>
  <input id="usernameInput" placeholder="Username">
  <input id="avatarInput" placeholder="Profile picture URL">
  <button id="logoutBtn">Logout</button>

  <h3>Post a Trend</h3>
  <input id="postUrl" type="text" placeholder="Video/Youtube URL">
  <input id="postCaption" type="text" placeholder="Caption">
  <div class="ai-panel">
    <button id="aiCaptionBtn">üé® AI Caption</button>
    <button id="aiImageBtn">üñºÔ∏è AI Cover</button>
  </div>
  <button id="postSubmit">Post</button>

  <h3>Search Users</h3>
  <input id="searchUser" class="search-bar" placeholder="Search username...">
  <div id="searchResults"></div>
</div>

<main class="feed"></main>
<div class="post-btn" id="postBtn">‚ûï</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

// === Supabase ===
const supabaseUrl = "https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl, supabaseKey);

// === Pollinations AI Key ===
const POLL_KEY = "Rn_w_0CKwDcPACXL";

// === Elements ===
const menuBtn = document.getElementById("menuBtn");
const sidePanel = document.getElementById("sidePanel");
const authBtn = document.getElementById("authBtn");
const logoutBtn = document.getElementById("logoutBtn");
const userEmail = document.getElementById("userEmail");
const feed = document.querySelector(".feed");
const postBtn = document.getElementById("postBtn");
const postUrl = document.getElementById("postUrl");
const postCaption = document.getElementById("postCaption");
const postSubmit = document.getElementById("postSubmit");
const usernameInput = document.getElementById("usernameInput");
const avatarInput = document.getElementById("avatarInput");
const aiCaptionBtn = document.getElementById("aiCaptionBtn");
const aiImageBtn = document.getElementById("aiImageBtn");
const searchUser = document.getElementById("searchUser");
const searchResults = document.getElementById("searchResults");

// === Menu Toggle ===
menuBtn.addEventListener("click", ()=>{sidePanel.classList.toggle("active");});
document.addEventListener("click",(e)=>{if(sidePanel.classList.contains("active")&&!sidePanel.contains(e.target)&&e.target!==menuBtn){sidePanel.classList.remove("active");}});

// === Auth ===
authBtn.addEventListener("click", async ()=>{
  const email = prompt("Enter email:");
  const password = prompt("Enter password:");
  if(!email||!password) return alert("Enter email & password");
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error) return alert("Login Error: "+error.message);
  handleAuth();
});
logoutBtn.addEventListener("click", async ()=>{await supabase.auth.signOut(); handleAuth();});

// === Handle Auth UI ===
async function handleAuth(){
  const { data } = await supabase.auth.getSession();
  const user = data.session?.user;
  if(user){
    userEmail.textContent = user.email;
    authBtn.style.display="none";
    logoutBtn.style.display="block";
    await ensureProfile(user);
  }else{
    userEmail.textContent="Not logged in";
    authBtn.style.display="block";
    logoutBtn.style.display="none";
  }
}

// === Ensure Profile Exists ===
async function ensureProfile(user){
  let { data, error } = await supabase.from("profiles").select("*").eq("id",user.id);
  if(!data.length){
    await supabase.from("profiles").insert([{id:user.id,username:"anon",avatar:""}]);
  }
}

// === Load Feed ===
async function loadFeed(){
  const { data, error } = await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error) return console.error(error);
  feed.innerHTML="";
  data.forEach(post=>{
    const card = document.createElement("div");
    card.className="trend-card";
    let media;
    if(post.type==="youtube"){
      media=document.createElement("iframe");
      media.src=post.url;
      media.setAttribute("allowfullscreen",true);
    }else{
      media=document.createElement("video");
      media.src=post.url;
      media.autoplay=true;
      media.loop=true;
      media.muted=true;
    }
    media.className="trend-media";
    card.appendChild(media);

    const info = document.createElement("div");
    info.className="trend-info";
    info.innerHTML=`<h2>@${post.username}</h2><p>${post.caption}</p>`;
    card.appendChild(info);

    const actions = document.createElement("div");
    actions.className="trend-actions";
    actions.innerHTML=`
      <div class="action-btn" onclick="likeTrend('${post.id}')">‚ù§Ô∏è</div>
      <div class="action-btn" onclick="commentTrend('${post.id}')">üí¨</div>
      <div class="action-btn" onclick="deleteTrend('${post.id}')">üóëÔ∏è</div>
    `;
    card.appendChild(actions);

    const commentSection = document.createElement("div");
    commentSection.className="comment-section";
    card.appendChild(commentSection);

    feed.appendChild(card);
  });
  initVideoObserver();
}

// === Post Submit ===
postSubmit.addEventListener("click", async ()=>{
  const { data } = await supabase.auth.getSession();
  if(!data.session) return alert("Login first!");
  const url = postUrl.value.trim(); const caption = postCaption.value.trim();
  if(!url) return alert("Enter video URL");
  const type = url.includes("youtube.com")?"youtube":"video";
  const username = usernameInput.value||"anon";
  const avatar = avatarInput.value||"";
  const { error } = await supabase.from("trends").insert([{url,caption,type,username,avatar}]);
  if(error) return console.error(error);
  postUrl.value=""; postCaption.value="";
  loadFeed();
});

// === AI Caption ===
aiCaptionBtn.addEventListener("click", async ()=>{
  const prompt = "Give a catchy trending caption for a short video.";
  const res = await fetch("https://api.pollinations.ai/caption", {
    method:"POST", headers:{"Authorization":"Bearer "+POLL_KEY,"Content-Type":"application/json"},
    body:JSON.stringify({prompt})
  });
  const data = await res.json();
  postCaption.value = data?.caption || "üî• Trend!";
});

// === AI Cover ===
aiImageBtn.addEventListener("click", async ()=>{
  const prompt="Cyberpunk neon trending video cover, vertical";
  const res = await fetch("https://api.pollinations.ai/generate",{
    method:"POST", headers:{"Authorization":"Bearer "+POLL_KEY,"Content-Type":"application/json"},
    body:JSON.stringify({prompt})
  });
  const data = await res.json();
  alert("Cover generated! (use in post or preview manually)");
});

// === Video Observer ===
function initVideoObserver(){
  const videos=document.querySelectorAll(".trend-card video");
  const observer = new IntersectionObserver(entries=>{
    entries.forEach(e=>{
      if(e.isIntersecting) e.target.play().catch(()=>{});
      else e.target.pause();
    });
  },{threshold:0.6});
  videos.forEach(v=>observer.observe(v));
}

// === Likes, Comments, Delete ===
window.likeTrend=async function(id){alert("Liked trend "+id);}
window.commentTrend=async function(id){let c=prompt("Comment:"); if(!c) return; alert("Commented: "+c);}
window.deleteTrend=async function(id){await supabase.from("trends").delete().eq("id",id); loadFeed();}

// === Search Users ===
searchUser.addEventListener("input", async ()=>{
  const val=searchUser.value.trim();
  if(!val) return searchResults.innerHTML="";
  const { data } = await supabase.from("profiles").select("*").ilike("username",`%${val}%`);
  searchResults.innerHTML="";
  data.forEach(u=>{
    const div=document.createElement("div");
    div.textContent=u.username;
    div.style.padding="0.3rem"; div.style.borderBottom="1px solid rgba(255,255,255,.1)";
    searchResults.appendChild(div);
  });
});

// === Initialize ===
handleAuth(); loadFeed();
</script>

</body>
</html>
