<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TrendTime - AI Social</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.3.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm"></script>
  <style>
    :root{
      --orange:#ff6a00; --pink:#ff1f71; --dark:#0f0f0f; --card:#1a1a1a;
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
    body{background:var(--dark);color:white;overflow-x:hidden;}
    header{position:sticky;top:0;width:100%;display:flex;justify-content:space-between;align-items:center;padding:.7rem 1rem;background:linear-gradient(90deg,var(--orange),var(--pink));z-index:100;box-shadow:0 4px 20px rgba(0,0,0,.6);}
    header h1{font-size:1.4rem;font-weight:700;letter-spacing:1px;}
    header button{background:white;color:var(--dark);border:none;padding:.5rem 1rem;border-radius:999px;font-weight:bold;cursor:pointer;transition:.3s;}
    header button:hover{background:var(--pink);color:white;}
    .side-panel{position:fixed;top:0;left:-280px;width:260px;height:100vh;background:var(--card);box-shadow:5px 0 20px rgba(0,0,0,.6);transition:left .3s ease;padding:2rem 1rem;z-index:200;overflow-y:auto;}
    .side-panel.active{left:0;}
    .side-panel h2{margin-bottom:1rem;}
    .side-panel button{margin-top:1rem;width:100%;padding:.5rem;border:none;border-radius:8px;cursor:pointer;}
    .feed{display:flex;flex-direction:column;gap:2rem;padding:1rem;}
    .trend-card{background:var(--card);border-radius:1.5rem;overflow:hidden;position:relative;box-shadow:0 0 30px rgba(255,106,0,.2);}
    .trend-card video,.trend-card canvas{width:100%;height:70vh;object-fit:cover;}
    .trend-info{position:absolute;bottom:0;left:0;width:100%;padding:1rem;background:linear-gradient(to top,rgba(0,0,0,.8),transparent);}
    .trend-info h2{font-size:1.2rem;margin-bottom:.5rem;}
    .trend-actions{position:absolute;right:1rem;bottom:20%;display:flex;flex-direction:column;gap:1.2rem;align-items:center;}
    .action-btn{background:linear-gradient(145deg,var(--orange),var(--pink));width:55px;height:55px;border-radius:50%;display:flex;justify-content:center;align-items:center;font-size:1.3rem;cursor:pointer;box-shadow:0 0 15px rgba(255,106,0,.8);transition:transform .2s;}
    .action-btn:hover{transform:scale(1.1);}
    .post-btn{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%);background:linear-gradient(145deg,var(--pink),var(--orange));color:white;font-size:1.5rem;width:70px;height:70px;border-radius:50%;display:flex;justify-content:center;align-items:center;box-shadow:0 0 25px rgba(255,30,100,.9);cursor:pointer;transition:all .3s ease;z-index:200;animation:pulse 2s infinite;}
    @keyframes pulse{0%{box-shadow:0 0 15px rgba(255,106,0,.6);}50%{box-shadow:0 0 35px rgba(255,30,100,1);}100%{box-shadow:0 0 15px rgba(255,106,0,.6);}}
    input,textarea{width:100%;padding:.5rem;margin:.5rem 0;border-radius:6px;border:none;background:#222;color:white;}
    #webcamContainer{position:relative;}
  </style>
</head>
<body>
<header>
  <button id="menuBtn">‚ò∞</button>
  <h1>üî• TrendTime</h1>
  <button id="authBtn">Login</button>
</header>

<!-- Side Panel -->
<div class="side-panel" id="sidePanel">
  <h2>Welcome</h2>
  <p id="userEmail">Not logged in</p>
  <button id="logoutBtn">Logout</button>

  <h3>Post a Trend</h3>
  <input id="postUrl" type="text" placeholder="Video/Youtube URL">
  <input id="postCaption" type="text" placeholder="Caption">
  <button id="postSubmit">Post</button>

  <h3>Record AI Video</h3>
  <div id="webcamContainer">
    <video id="webcam" autoplay playsinline muted width="320" height="240"></video>
    <canvas id="canvas" width="320" height="240"></canvas>
  </div>
  <button id="startRecord">Start Recording</button>
  <button id="stopRecord">Stop & Upload</button>

  <h3>Profile</h3>
  <input id="avatarUrl" type="text" placeholder="Avatar Image URL">
  <button id="updateAvatar">Update Avatar</button>
</div>

<main class="feed"></main>
<div class="post-btn" id="postBtn">‚ûï</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl, supabaseKey);

const menuBtn=document.getElementById("menuBtn");
const sidePanel=document.getElementById("sidePanel");
const authBtn=document.getElementById("authBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userEmail=document.getElementById("userEmail");
const feed=document.querySelector(".feed");
const postBtn=document.getElementById("postBtn");
const postUrl=document.getElementById("postUrl");
const postCaption=document.getElementById("postCaption");
const postSubmit=document.getElementById("postSubmit");
const avatarUrl=document.getElementById("avatarUrl");
const updateAvatar=document.getElementById("updateAvatar");

const webcam=document.getElementById("webcam");
const canvas=document.getElementById("canvas");
const ctx=canvas.getContext("2d");
const startRecord=document.getElementById("startRecord");
const stopRecord=document.getElementById("stopRecord");

let recorder, recordedChunks=[], sessionUser=null;
let styleTransfer, poseNet;

// === Menu toggle
menuBtn.addEventListener("click",()=>{sidePanel.classList.toggle("active");});
document.addEventListener("click",e=>{if(sidePanel.classList.contains("active")&&!sidePanel.contains(e.target)&&e.target!==menuBtn){sidePanel.classList.remove("active");}});

// === Auth
authBtn.addEventListener("click",async()=>{
  const email=prompt("Enter email:");
  const password=prompt("Enter password:");
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){alert("Login failed");console.error(error);}
});
logoutBtn.addEventListener("click",async()=>{await supabase.auth.signOut(); updateUserUI(null);});

// === Update UI
async function updateUserUI(session){
  sessionUser=session?.user||null;
  if(sessionUser){
    userEmail.textContent=sessionUser.email;
    authBtn.style.display="none";
    logoutBtn.style.display="block";
  }else{
    userEmail.textContent="Not logged in";
    authBtn.style.display="block";
    logoutBtn.style.display="none";
  }
}
supabase.auth.onAuthStateChange((_e,session)=>updateUserUI(session));

// === Load feed
async function loadFeed(){
  const { data,error }=await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); return;}
  feed.innerHTML="";
  data.forEach(post=>{
    const card=document.createElement("div");
    card.className="trend-card";
    const media=document.createElement(post.type==="youtube"?"iframe":"video");
    media.src=post.url; media.autoplay=!post.type==="youtube"; media.loop=!post.type==="youtube"; media.muted=true;
    media.setAttribute("allowfullscreen",true);
    card.appendChild(media);

    const info=document.createElement("div"); info.className="trend-info";
    info.innerHTML=`<h2>@${post.username}</h2><p>${post.caption||""}</p>`;
    card.appendChild(info);

    const actions=document.createElement("div"); actions.className="trend-actions";
    actions.innerHTML=`<div class="action-btn">‚ù§Ô∏è</div><div class="action-btn">üí¨</div>`;
    if(sessionUser?.email==="sonofjean2@gmail.com"){actions.innerHTML+=`<div class="action-btn deleteBtn">üóëÔ∏è</div>`;}
    card.appendChild(actions);

    feed.appendChild(card);

    if(sessionUser?.email==="sonofjean2@gmail.com"){
      const delBtn=actions.querySelector(".deleteBtn");
      delBtn.addEventListener("click",async()=>{
        const { error }=await supabase.from("trends").delete().eq("id",post.id);
        if(error)console.error(error); else loadFeed();
      });
    }
  });
}

// === Post submit
postSubmit.addEventListener("click",async()=>{
  if(!sessionUser){alert("Login first"); return;}
  const url=postUrl.value.trim(); const caption=postCaption.value.trim();
  if(!url){alert("Enter URL"); return;}
  const type=url.includes("youtube")?"youtube":"video";
  const { error }=await supabase.from("trends").insert([{url,caption,type,username:sessionUser.email.split("@")[0]}]);
  if(error)console.error(error); else{postUrl.value=""; postCaption.value=""; loadFeed();}
});

// === Avatar
updateAvatar.addEventListener("click",async()=>{
  if(!sessionUser){alert("Login first"); return;}
  const { error }=await supabase.from("profiles").upsert({id:sessionUser.id, avatar:avatarUrl.value});
  if(error)console.error(error); else alert("Avatar updated");
});

// === Webcam + AI Effects
navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream=>{webcam.srcObject=stream;});

styleTransfer=ml5.styleTransfer('https://storage.googleapis.com/ml5-models/style-transfer/mosaic/', webcam, ()=>console.log("Style loaded"));
poseNet=ml5.poseNet(webcam, ()=>console.log("PoseNet ready"));

function draw(){
  ctx.drawImage(webcam,0,0,canvas.width,canvas.height);
  poseNet.on('pose',poses=>{
    poses.forEach(p=>{
      p.keypoints.forEach(k=>{
        if(k.score>0.5){ctx.fillStyle='red'; ctx.beginPath(); ctx.arc(k.position.x,k.position.y,5,0,2*Math.PI); ctx.fill();}
      });
    });
  });
  requestAnimationFrame(draw);
}
draw();

// === Record
startRecord.addEventListener("click",()=>{
  recordedChunks=[]; recorder=new MediaRecorder(canvas.captureStream(30),{mimeType:'video/webm'});
  recorder.ondataavailable=e=>recordedChunks.push(e.data);
  recorder.start();
  alert("Recording started");
});
stopRecord.addEventListener("click",async()=>{
  recorder.stop();
  recorder.onstop=async()=>{
    const blob=new Blob(recordedChunks,{type:'video/webm'});
    const name=`ai-${Date.now()}.webm`;
    const { data,error }=await supabase.storage.from('videos').upload(name,blob);
    if(error)console.error(error); else alert("Uploaded "+name);
  };
});

// === Post Button toggle side panel
postBtn.addEventListener("click",()=>sidePanel.classList.toggle("active"));

// === Init
loadFeed();
</script>
</body>
</html>
