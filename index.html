<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>TrendTime â€” AI Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f5f5f5; --card:#fff; --muted:#666;
  --accent1:#ff6a00; --accent2:#ff1f71; --glass: rgba(0,0,0,0.05);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:"Poppins",sans-serif;}
body{background:var(--bg);color:#111;min-height:100vh;overflow-x:hidden;}
header{height:70px;display:flex;justify-content:space-between;align-items:center;padding:0 20px;background:#fff;box-shadow:0 4px 20px rgba(0,0,0,0.1);position:sticky;top:0;z-index:50;}
header h1{font-size:1.6rem;font-weight:700;}
header .actions{display:flex;gap:12px;align-items:center;}
button.btn{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff;border:none;padding:10px 16px;border-radius:999px;font-weight:600;cursor:pointer;transition:0.2s;}
button.btn:hover{opacity:0.85;}
.app{display:grid;grid-template-columns:1fr;gap:16px;padding:16px;}
@media(min-width:900px){.app{grid-template-columns:280px 1fr 300px;}}
.left,.right,.center{background:var(--card);border-radius:14px;padding:16px;overflow:auto;box-shadow:0 8px 20px rgba(0,0,0,0.05);}
.center{display:flex;flex-direction:column;gap:12px;}
.feed{flex:1;overflow-y:auto;scroll-snap-type:y mandatory;padding:8px;}
.post-card{position:relative;background:var(--card);margin-bottom:18px;border-radius:14px;overflow:hidden;scroll-snap-align:start;box-shadow:0 8px 20px rgba(0,0,0,0.1);}
.post-media{width:100%;height:100%;object-fit:cover;background:#000;border-radius:12px;}
.post-info{padding:12px;}
.meta{display:flex;gap:12px;align-items:center;margin-bottom:6px;}
.avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(0,0,0,0.05);}
.username{font-weight:700;}
.caption{color:var(--muted);}
.field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;}
input[type="text"],input[type="url"],textarea{background:var(--glass);border:1px solid rgba(0,0,0,0.1);color:#111;padding:10px;border-radius:12px;}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;z-index:90;}
.modal{background:var(--card);padding:18px;border-radius:14px;width:90%;max-width:520px;box-shadow:0 0 20px rgba(0,0,0,0.1);}
video#recordPreview{width:100%;border-radius:12px;background:#000;}
.post-controls{display:flex;gap:10px;margin-top:6px;}
.post-controls button{flex:1;padding:6px;border-radius:12px;border:none;cursor:pointer;transition:0.2s;}
.post-controls button:hover{opacity:0.8;}
</style>
</head>
<body>

<header>
<h1>TrendTime</h1>
<div class="actions">
<button id="openRecordModal" class="btn">ðŸŽ¥ Record / Post</button>
</div>
</header>

<div class="app">
<main class="center">
<div class="feed" id="feedWrap"></div>
</main>
</div>

<div id="modalBackdrop" class="modal-backdrop">
<div class="modal">
<h2>Record & Upload</h2>
<video id="recordPreview" autoplay muted playsinline></video>
<div style="display:flex;gap:10px;margin-top:10px">
<button id="startRec" class="btn">Start</button>
<button id="stopRec" class="btn" disabled>Stop & Upload</button>
<button id="closeModal" class="btn">Close</button>
</div>
<input id="postCaption" placeholder="Caption (optional)" style="margin-top:10px;padding:10px;border-radius:12px;width:100%;"/>
<div style="display:flex;gap:10px;margin-top:10px;">
<button id="aiCaptionBtn" class="btn">âœ¨ AI Caption</button>
<button id="applyTfBtn" class="btn">ðŸ§  TF Effect</button>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.7.0/dist/tf.min.js"></script>
<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// Supabase
const supabaseUrl = 'https://kpdgmbjdaynplyjacuxd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ';
const supabase = createClient(supabaseUrl, supabaseKey);

const openRecordModal = document.getElementById('openRecordModal');
const modalBackdrop = document.getElementById('modalBackdrop');
const startRec = document.getElementById('startRec');
const stopRec = document.getElementById('stopRec');
const closeModal = document.getElementById('closeModal');
const recordPreview = document.getElementById('recordPreview');
const postCaption = document.getElementById('postCaption');
const feedWrap = document.getElementById('feedWrap');
const aiCaptionBtn = document.getElementById('aiCaptionBtn');
const applyTfBtn = document.getElementById('applyTfBtn');

let mediaRecorder, recordedChunks = [], localStream=null;

// Modal & recording
openRecordModal.onclick = async ()=>{
  modalBackdrop.style.display='flex';
  localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  recordPreview.srcObject = localStream;
  mediaRecorder = new MediaRecorder(localStream,{mimeType:'video/webm;codecs=vp9'});
  mediaRecorder.ondataavailable = e => {if(e.data.size>0) recordedChunks.push(e.data);}
  mediaRecorder.onstop = async ()=>{
    const blob = new Blob(recordedChunks,{type:'video/webm'});
    const fileName = `video_${Date.now()}.webm`;
    const { error } = await supabase.storage.from('videos').upload(fileName, blob, {upsert:true});
    if(error){alert('Upload failed: '+error.message); return;}
    const { data } = supabase.storage.from('videos').getPublicUrl(fileName);
    const url = data.publicUrl;
    await supabase.from('trends').insert([{url, caption: postCaption.value || 'ðŸ”¥ New Trend'}]);
    recordedChunks=[];
    loadFeed();
    modalBackdrop.style.display='none';
    localStream.getTracks().forEach(t=>t.stop());
  };
};

startRec.onclick = ()=>{
  mediaRecorder.start();
  startRec.disabled=true;
  stopRec.disabled=false;
};

stopRec.onclick = ()=>{
  mediaRecorder.stop();
  stopRec.disabled=true;
  startRec.disabled=false;
};

closeModal.onclick = ()=>{
  modalBackdrop.style.display='none';
  if(localStream) localStream.getTracks().forEach(t=>t.stop());
};

// AI Caption
aiCaptionBtn.onclick = async ()=>{
  aiCaptionBtn.disabled=true;
  aiCaptionBtn.textContent='Thinking...';
  try{
    const prompt = 'Short catchy caption for a trending short video, include emojis';
    const res = await fetch(`https://text.pollinations.ai/${encodeURIComponent(prompt)}`);
    const text = await res.text();
    postCaption.value = text.slice(0,120) || 'ðŸ”¥ Trending!';
  }catch(e){console.log(e);}
  aiCaptionBtn.disabled=false;
  aiCaptionBtn.textContent='âœ¨ AI Caption';
};

// TensorFlow.js simple video effect
applyTfBtn.onclick = async ()=>{
  applyTfBtn.disabled=true;
  applyTfBtn.textContent='Applying...';
  // simple gray-scale effect on video frame using tf.js
  const video = recordPreview;
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext('2d');
  document.body.appendChild(canvas);
  canvas.style.position='fixed';
  canvas.style.top='50px';
  canvas.style.left='50%';
  canvas.style.transform='translateX(-50%)';
  canvas.style.zIndex='100';
  const loop = ()=>{
    if(video.paused || video.ended) return;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
    const tfImg = tf.browser.fromPixels(imgData);
    const gray = tfImg.mean(2).expandDims(2).tile([1,1,3]);
    tf.browser.toPixels(gray,canvas);
    requestAnimationFrame(loop);
  };
  loop();
  applyTfBtn.textContent='ðŸ§  TF Effect';
  applyTfBtn.disabled=false;
};

// Load feed
async function loadFeed(){
  feedWrap.innerHTML='';
  const { data, error } = await supabase.from('trends').select('*').order('created_at',{ascending:false}).limit(50);
  if(error){console.log(error); return;}
  data.forEach(post=>{
    const card = document.createElement('div'); card.className='post-card';
    const video = document.createElement('video'); video.src=post.url; video.controls=true; video.loop=true; video.muted=false; video.className='post-media';
    card.appendChild(video);
    const info = document.createElement('div'); info.className='post-info';
    info.innerHTML=`<div class="caption">${post.caption||''}</div>`;
    card.appendChild(info);
    feedWrap.appendChild(card);
  });
}

// Initial load
loadFeed();

</script>
</body>
</html>
