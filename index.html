<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>TrendTime ‚Äî AI Social</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071017; --card:#0f1720; --muted:#9aa6b2; --accent1:#ff6a00; --accent2:#ff1f71;
    --glass: rgba(255,255,255,0.04);
  }
  *{box-sizing:border-box;font-family:"Poppins",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  body{margin:0;background:linear-gradient(180deg,#071017,#05060a);color:#fff;min-height:100vh;overflow:hidden}
  header{height:68px;display:flex;align-items:center;justify-content:space-between;padding:0 18px;background:linear-gradient(90deg,var(--accent1),var(--accent2));box-shadow:0 6px 30px rgba(0,0,0,0.6);position:sticky;top:0;z-index:40}
  header h1{font-size:1.1rem;margin:0;letter-spacing:0.6px}
  header .actions{display:flex;gap:10px;align-items:center}
  button.btn{background:#fff;color:#08121a;border:none;padding:8px 12px;border-radius:999px;font-weight:600;cursor:pointer}
  button.icon-btn{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:10px;cursor:pointer}
  /* layout */
  .app{display:grid;grid-template-columns:320px 1fr 360px;gap:18px;padding:18px;height:calc(100vh - 68px)}
  @media (max-width:1100px){ .app{grid-template-columns:1fr} .right-col{display:none} }
  .left, .right {background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:16px;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,0.6)}
  .center{overflow:hidden;border-radius:14px;padding:6px;display:flex;flex-direction:column;gap:12px}
  /* feed */
  .feed{flex:1;overflow-y:auto;scroll-snap-type:y mandatory;padding:8px}
  .post-card{position:relative;background:var(--card);height:calc(100vh - 200px);margin-bottom:18px;border-radius:12px;overflow:hidden;scroll-snap-align:start;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .post-media{width:100%;height:100%;object-fit:cover;background:#000}
  .post-info{position:absolute;left:18px;bottom:18px;right:120px;padding:12px;background:linear-gradient(180deg, rgba(0,0,0,0.05), rgba(0,0,0,0.35));border-radius:10px}
  .meta{display:flex;gap:12px;align-items:center}
  .avatar{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
  .username{font-weight:700}
  .caption{color:var(--muted);margin-top:6px}
  .post-controls{position:absolute;right:18px;bottom:18px;display:flex;flex-direction:column;gap:12px;align-items:center}
  .round{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:linear-gradient(145deg,var(--accent1),var(--accent2));box-shadow:0 4px 20px rgba(255,30,100,0.12);cursor:pointer}
  .small{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);cursor:pointer}
  /* right column controls */
  .panel-title{font-weight:700;margin-bottom:8px}
  .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
  input[type="text"], input[type="url"], input[type="email"], input[type="password"], textarea{
    background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:#fff;padding:10px;border-radius:10px
  }
  .search-list{max-height:220px;overflow:auto;border-radius:8px;background:rgba(255,255,255,0.01);padding:6px}
  .search-item{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.02);display:flex;gap:8px;align-items:center}
  .muted{color:var(--muted);font-size:0.9rem}
  .footer{font-size:12px;color:var(--muted);text-align:center;margin-top:12px}
  /* modals */
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.7);display:none;align-items:center;justify-content:center;z-index:80}
  .modal{background:var(--card);padding:18px;border-radius:12px;width:90%;max-width:520px}
  .row{display:flex;gap:8px}
  .small-muted{font-size:12px;color:var(--muted)}
  /* comments */
  .comments{margin-top:10px;background:rgba(0,0,0,0.35);padding:8px;border-radius:8px;max-height:140px;overflow:auto}
  .comment-item{padding:6px;border-bottom:1px solid rgba(255,255,255,0.02);font-size:14px}
  .comment-box{display:flex;gap:8px;margin-top:8px}
  /* nice spacing for mobile controls */
  @media (max-width:700px){ .post-info{right:18px} .post-controls{right:12px;bottom:12px} }
</style>
</head>
<body>

<header>
  <h1>TrendTime</h1>
  <div class="actions">
    <button id="openFeedShuffle" class="icon-btn" title="Shuffle feed">üîÄ</button>
    <button id="openPostModal" class="btn">Post</button>
    <button id="openLogin" class="btn">Sign In / Sign Up</button>
  </div>
</header>

<div class="app" style="padding-top:10px">
  <!-- left - profile / quick controls -->
  <aside class="left">
    <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
      <img id="leftAvatar" class="avatar" src="https://placehold.co/80x80?text=U" alt="avatar">
      <div>
        <div id="leftUsername" style="font-weight:700">Not signed in</div>
        <div class="small-muted" id="leftEmail">‚Äî</div>
      </div>
    </div>

    <div class="panel-title">Quick Actions</div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:12px">
      <button id="openRecordModal" class="btn">Record & Upload</button>
      <button id="openSettings" class="icon-btn">Settings</button>
    </div>

    <div class="panel-title">Search people</div>
    <input id="searchInput" type="text" placeholder="Search username..." style="width:100%;margin-bottom:8px">
    <div class="search-list" id="searchResults"></div>

    <div style="height:18px"></div>
    <div class="panel-title">About</div>
    <div class="small-muted">TrendTime ‚Äî AI helpers, record, upload, and swipe the hottest short videos.</div>
    <div class="footer">¬© 2025 TrendTime</div>
  </aside>

  <!-- center - feed -->
  <main class="center">
    <div style="display:flex;gap:12px;align-items:center;padding:8px">
      <h2 style="margin:0">Feed</h2>
      <div class="muted" style="margin-left:8px">Swipe / scroll to explore</div>
      <div style="margin-left:auto"><button id="refreshFeed" class="icon-btn">‚ü≥ Refresh</button></div>
    </div>

    <div class="feed" id="feedWrap" aria-live="polite">
      <!-- posts will inject here -->
    </div>
  </main>

  <!-- right - compose + ai panel -->
  <aside class="right">
    <div class="panel-title">Compose (AI helpers)</div>

    <div class="field">
      <label class="small-muted">Caption</label>
      <input id="composeCaption" type="text" placeholder="Write a caption or use AI">
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="aiCaptionBtn" class="btn">‚ú® Suggest Caption</button>
        <button id="aiHashtagsBtn" class="icon-btn"># tags</button>
      </div>
    </div>

    <div class="field">
      <label class="small-muted">Cover image (AI)</label>
      <input id="aiCoverPrompt" type="text" placeholder="Neon dancer, cyberpunk, vertical">
      <div style="display:flex;gap:8px;margin-top:6px">
        <button id="aiCoverBtn" class="btn">üñºÔ∏è Generate Cover</button>
      </div>
      <div id="aiCoverPreview" style="margin-top:8px"></div>
    </div>

    <div class="panel-title">Manual Post (URL)</div>
    <div class="field">
      <label class="small-muted">Video / YouTube URL</label>
      <input id="manualUrl" type="url" placeholder="https://...">
      <label class="small-muted">Username (will show)</label>
      <input id="manualUsername" type="text" placeholder="your display name">
      <button id="manualPostBtn" class="btn">Post URL</button>
    </div>

    <div style="height:18px"></div>
    <div class="panel-title">Live Tips</div>
    <div class="small-muted">Use AI caption or try "neon dancer vertical" for great covers. Recording uploads to your `videos` bucket.</div>
  </aside>
</div>

<!-- MODALS -->
<div id="modalBackdrop" class="modal-backdrop">
  <div id="modalContainer" class="modal"></div>
</div>

<!-- SCRIPT -->
<script type="module">
/*
  Single-file TrendTime app
  - Uses Supabase JS client (public anon key).
  - Uses Pollinations public endpoints (no API key required) for AI captions & images.
  - Assumes you have created in Supabase:
      TABLE profiles: id (uuid PK), username (text), avatar_url (text), created_at (timestamp)
      TABLE trends: id (bigint PK), user_id (uuid), url (text), caption (text), type (text), username (text), avatar (text), likes (int default 0), created_at (timestamp)
      TABLE comments: id (bigint PK), trend_id (bigint), user_id (uuid), content (text), created_at (timestamp)
      STORAGE bucket: videos (for uploads), avatars (for profile pictures)
    If RLS is enabled, set policies to allow authenticated users to insert/select/update accordingly.
*/

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ---------- CONFIG ----------
const supabaseUrl = 'https://kpdgmbjdaynplyjacuxd.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ';
const supabase = createClient(supabaseUrl, supabaseKey);

// Pollinations endpoints (public)
const POLL_IMAGE = (prompt) => `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
const POLL_TEXT = (prompt) => `https://text.pollinations.ai/${encodeURIComponent(prompt)}`;

// ---------- DOM ----------
const feedWrap = document.getElementById('feedWrap');
const openLoginBtn = document.getElementById('openLogin');
const openPostModal = document.getElementById('openPostModal');
const openRecordModal = document.getElementById('openRecordModal');
const openSettingsBtn = document.getElementById('openSettings');
const leftAvatar = document.getElementById('leftAvatar');
const leftUsername = document.getElementById('leftUsername');
const leftEmail = document.getElementById('leftEmail');
const refreshFeedBtn = document.getElementById('refreshFeed');
const shuffleFeedBtn = document.getElementById('openFeedShuffle');

const manualUrlInput = document.getElementById('manualUrl');
const manualUsernameInput = document.getElementById('manualUsername');
const manualPostBtn = document.getElementById('manualPostBtn');

const aiCaptionBtn = document.getElementById('aiCaptionBtn');
const aiHashtagsBtn = document.getElementById('aiHashtagsBtn');
const composeCaptionInput = document.getElementById('composeCaption');
const aiCoverPrompt = document.getElementById('aiCoverPrompt');
const aiCoverBtn = document.getElementById('aiCoverBtn');
const aiCoverPreview = document.getElementById('aiCoverPreview');

const modalBackdrop = document.getElementById('modalBackdrop');
const modalContainer = document.getElementById('modalContainer');
const postBtn = document.getElementById('openPostModal');

// ---------- STATE ----------
let currentUser = null;
let postsCache = [];
let observer = null;

// ---------- HELPERS ----------
function showModal(html){
  modalContainer.innerHTML = html;
  modalBackdrop.style.display = 'flex';
}
function closeModal(){ modalBackdrop.style.display = 'none'; modalContainer.innerHTML = ''; }
modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

// show a toast-like alert
function toast(msg){ try{ alert(msg); }catch(e){ console.log(msg); } }

// format time
function ago(ts){ const d=new Date(ts); const diff=(Date.now()-d.getTime())/1000; if(diff<60) return Math.floor(diff)+'s'; if(diff<3600) return Math.floor(diff/60)+'m'; if(diff<86400) return Math.floor(diff/3600)+'h'; return d.toLocaleDateString(); }

// ---------- AUTH & PROFILE ----------
async function refreshAuth(){
  const { data } = await supabase.auth.getSession();
  currentUser = data.session?.user ?? null;
  if(currentUser){
    leftEmail.textContent = currentUser.email || '';
    openLoginBtn.style.display = 'none';
    // load profile -> username + avatar
    const { data:profile } = await supabase.from('profiles').select('username,avatar_url').eq('id', currentUser.id).maybeSingle();
    leftUsername.textContent = (profile?.username) || (currentUser.email?.split('@')[0]) || 'You';
    leftAvatar.src = profile?.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(leftUsername.textContent)}&background=101827&color=fff&size=128`;
    document.getElementById('manualUsername').value = leftUsername.textContent;
  } else {
    leftEmail.textContent = 'Not signed in';
    leftUsername.textContent = 'Guest';
    leftAvatar.src = 'https://placehold.co/80x80?text=U';
    openLoginBtn.style.display = 'inline-block';
  }
}

// login/signup modal
openLoginBtn.addEventListener('click', ()=> {
  showModal(`
    <h3 style="margin-bottom:12px">Sign In or Sign Up</h3>
    <input id="modalEmail" placeholder="Email" type="email" style="width:100%;padding:10px;border-radius:8px;margin-bottom:8px" />
    <input id="modalPassword" placeholder="Password" type="password" style="width:100%;padding:10px;border-radius:8px;margin-bottom:12px" />
    <div style="display:flex;gap:8px">
      <button id="modalLoginBtn" style="flex:1;background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:10px;border-radius:8px;color:#fff">Login</button>
      <button id="modalSignupBtn" style="flex:1;background:rgba(255,255,255,0.06);border:none;padding:10px;border-radius:8px">Sign up</button>
    </div>
  `);
  document.getElementById('modalLoginBtn').onclick = async ()=>{
    const email = document.getElementById('modalEmail').value;
    const pw = document.getElementById('modalPassword').value;
    if(!email||!pw){ toast('Enter email + password'); return; }
    const { error } = await supabase.auth.signInWithPassword({ email, password: pw });
    if(error) toast('Login error: '+error.message); else { closeModal(); refreshAuth(); loadFeed(); }
  };
  document.getElementById('modalSignupBtn').onclick = async ()=>{
    const email = document.getElementById('modalEmail').value;
    const pw = document.getElementById('modalPassword').value;
    if(!email||!pw){ toast('Enter email + password'); return; }
    const { error } = await supabase.auth.signUp({ email, password: pw });
    if(error) toast('Signup error: '+error.message); else { toast('Sign up ok ‚Äî check email'); closeModal(); }
  };
});

// settings modal
openSettingsBtn.addEventListener('click', async ()=>{
  if(!currentUser){ toast('Sign in first'); return; }
  const { data:profile } = await supabase.from('profiles').select('username,avatar_url').eq('id', currentUser.id).maybeSingle();
  showModal(`
    <h3>Settings</h3>
    <label class="small-muted">Username</label>
    <input id="settingsUsername" value="${(profile?.username)||''}" />
    <label class="small-muted">Avatar image URL (or upload below)</label>
    <input id="settingsAvatarUrl" value="${(profile?.avatar_url)||''}" />
    <label class="small-muted">Or upload avatar file</label>
    <input id="settingsAvatarFile" type="file" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="saveSettingsBtn" style="flex:1;background:linear-gradient(90deg,var(--accent1),var(--accent2));border:none;padding:10px;border-radius:8px;color:#fff">Save</button>
      <button id="closeSettings" style="flex:1;background:rgba(255,255,255,0.06);border:none;padding:10px;border-radius:8px">Close</button>
    </div>
  `);
  document.getElementById('closeSettings').onclick = closeModal;
  document.getElementById('saveSettingsBtn').onclick = async ()=>{
    const newName = document.getElementById('settingsUsername').value;
    const newAvatarUrl = document.getElementById('settingsAvatarUrl').value;
    const fileInput = document.getElementById('settingsAvatarFile');
    let avatarPublic = newAvatarUrl || null;

    if(fileInput.files && fileInput.files[0]){
      const file = fileInput.files[0];
      const filename = `avatar_${currentUser.id}_${Date.now()}_${file.name}`;
      const { error: upErr } = await supabase.storage.from('avatars').upload(filename, file, { upsert: true });
      if(upErr){ toast('Avatar upload failed: '+upErr.message); return; }
      const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(filename);
      avatarPublic = urlData.publicUrl;
    }

    // upsert profile
    const { error: pErr } = await supabase.from('profiles').upsert({
      id: currentUser.id,
      username: newName || currentUser.email.split('@')[0],
      avatar_url: avatarPublic
    }, { onConflict: 'id' });
    if(pErr) toast('Save error: '+pErr.message); else { toast('Saved'); closeModal(); refreshAuth(); }
  };
});

// ---------- POST / RECORD MODAL ----------
openRecordModal?.addEventListener('click', ()=>openRecordDialog());
openPostModal.addEventListener('click', ()=>openRecordDialog());

function openRecordDialog(){
  if(!currentUser){ toast('Sign in to post / record'); return; }
  showModal(`
    <h3>Record & Upload</h3>
    <video id="recPreview" autoplay muted playsinline style="width:100%;border-radius:8px;background:#000"></video>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="recStart" style="flex:1;padding:10px;border-radius:8px">Start</button>
      <button id="recStop" style="flex:1;padding:10px;border-radius:8px">Stop & Upload</button>
    </div>
    <input id="postCaptionInput" placeholder="Caption (optional)" style="width:100%;margin-top:8px;padding:8px;border-radius:8px" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button id="postWithAI" style="flex:1;padding:10px;border-radius:8px;background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#fff">AI Caption</button>
      <button id="closeRec" style="flex:1;padding:10px;border-radius:8px">Close</button>
    </div>
  `);

  const recPreview = document.getElementById('recPreview');
  const recStart = document.getElementById('recStart');
  const recStop = document.getElementById('recStop');
  const closeRec = document.getElementById('closeRec');
  const postWithAI = document.getElementById('postWithAI');
  const postCaptionInput = document.getElementById('postCaptionInput');

  let localRecorder, localStream, localChunks = [];

  recStart.onclick = async ()=>{
    try{
      localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: true });
      recPreview.srcObject = localStream;
      localRecorder = new MediaRecorder(localStream, { mimeType: 'video/webm; codecs=vp9' });
      localChunks = [];
      localRecorder.ondataavailable = e => { if(e.data && e.data.size) localChunks.push(e.data); };
      localRecorder.start();
      recStart.disabled = true;
    } catch(err){ toast('Camera error: '+err.message); }
  };

  recStop.onclick = async ()=>{
    if(!localRecorder) return;
    localRecorder.stop();
    localRecorder.onstop = async () => {
      const blob = new Blob(localChunks, { type: 'video/webm' });
      const fileName = `video_${currentUser.id}_${Date.now()}.webm`;
      // upload to videos bucket
      const { error: upErr, data: upData } = await supabase.storage.from('videos').upload(fileName, blob, { upsert: true });
      if(upErr){ toast('Upload failed: '+upErr.message); return; }
      const { data: urlData } = supabase.storage.from('videos').getPublicUrl(fileName);
      const publicUrl = urlData.publicUrl;
      // create trend row
      const caption = postCaptionInput.value || '';
      const profile = await supabase.from('profiles').select('username,avatar_url').eq('id', currentUser.id).maybeSingle();
      const { error: insertErr } = await supabase.from('trends').insert([{
        user_id: currentUser.id,
        url: publicUrl,
        caption,
        type: 'video',
        username: profile?.data?.username || (currentUser.email.split('@')[0]),
        avatar: profile?.data?.avatar_url || null,
        likes: 0
      }]);
      if(insertErr){ toast('DB insert failed: '+insertErr.message); return; }
      toast('Uploaded & posted!');
      closeModal();
      await loadFeed(); // refresh
    };
    // stop tracks
    localStream.getTracks().forEach(t=>t.stop());
  };

  postWithAI.onclick = async ()=>{
    postWithAI.disabled = true;
    postWithAI.textContent = 'Thinking...';
    try{
      const prompt = 'Short viral caption for a short dance video with energy and emoji';
      const txt = await fetch(POLL_TEXT(prompt)).then(r=>r.text());
      postCaptionInput.value = (txt && txt.length>0) ? txt.replaceAll('\n',' ').slice(0,220) : 'üî• Viral!';
    } catch(e){ toast('AI caption error'); }
    postWithAI.disabled = false; postWithAI.textContent = 'AI Caption';
  };

  closeRec.onclick = closeModal;
}

// ---------- Manual URL posting ----------
manualPostBtn.addEventListener('click', async ()=>{
  if(!currentUser){ toast('Sign in to post'); return; }
  const url = manualUrlInput.value.trim();
  if(!url){ toast('Enter a URL'); return; }
  const prof = await supabase.from('profiles').select('username,avatar_url').eq('id', currentUser.id).maybeSingle();
  const username = manualUsernameInput.value.trim() || prof?.data?.username || currentUser.email.split('@')[0];
  const type = url.includes('youtube') ? 'youtube' : 'video';
  const { error } = await supabase.from('trends').insert([{
    user_id: currentUser.id,
    url, caption: composeCaptionInput.value || '', type, username, avatar: prof?.data?.avatar_url || null, likes: 0
  }]);
  if(error) toast('Post failed: '+error.message); else { toast('Posted'); manualUrlInput.value=''; composeCaptionInput.value=''; loadFeed(); }
});

// ---------- AI Buttons (right panel) ----------
aiCaptionBtn.addEventListener('click', async ()=>{
  aiCaptionBtn.disabled = true; aiCaptionBtn.textContent = 'Thinking...';
  try{
    const prompt = 'Write a short catchy caption for a trending short video, include emojis, max 100 chars';
    const res = await fetch(POLL_TEXT(prompt));
    const text = await res.text();
    const clean = (text||'').replace(/\n/g,' ').trim().slice(0,140);
    composeCaptionInput.value = clean || 'üî• Trending!';
  } catch(e){ toast('AI error'); }
  aiCaptionBtn.disabled = false; aiCaptionBtn.textContent = '‚ú® Suggest Caption';
});

aiHashtagsBtn.addEventListener('click', async ()=>{
  aiHashtagsBtn.disabled = true;
  try{
    const base = composeCaptionInput.value || 'short dance video';
    const prompt = `Give 5 trending hashtags for: ${base}`;
    const res = await fetch(POLL_TEXT(prompt));
    const text = await res.text();
    const tags = (text||'').split(/[\n,]+/).map(s=>s.trim()).filter(Boolean).slice(0,6).map(t=> t.startsWith('#')?t:'#'+t.replace(/\s+/g,'')).join(' ');
    composeCaptionInput.value = (composeCaptionInput.value ? composeCaptionInput.value + ' ' : '') + tags;
  } catch(e){ toast('AI error'); }
  aiHashtagsBtn.disabled = false;
});

aiCoverBtn.addEventListener('click', async ()=>{
  aiCoverBtn.disabled = true; aiCoverBtn.textContent = 'Generating...';
  try{
    const prompt = aiCoverPrompt.value || 'neon dancer, cyberpunk, vertical, cinematic';
    const url = POLL_IMAGE(prompt);
    aiCoverPreview.innerHTML = `<img src="${url}" style="width:100%;border-radius:8px" alt="${prompt}" />`;
  } catch(e){ toast('Cover error'); }
  aiCoverBtn.disabled = false; aiCoverBtn.textContent = 'üñºÔ∏è Generate Cover';
});

// ---------- SEARCH ----------
document.getElementById('searchInput').addEventListener('input', async (e)=>{
  const q = e.target.value.trim();
  const target = document.getElementById('searchResults');
  target.innerHTML = '';
  if(!q) return;
  const { data, error } = await supabase.from('profiles').select('id,username,avatar_url').ilike('username', `%${q}%`).limit(8);
  if(error) { target.textContent = 'Search error'; return; }
  (data||[]).forEach(p=>{
    const div = document.createElement('div'); div.className='search-item';
    div.innerHTML = `<img src="${p.avatar_url||'https://placehold.co/48x48'}" style="width:36px;height:36px;border-radius:50%"><div><div style="font-weight:600">${p.username}</div><div class="small-muted">${p.id}</div></div>`;
    target.appendChild(div);
  });
});

// ---------- LOAD FEED ----------
async function loadFeed(){
  const { data, error } = await supabase.from('trends').select('*').order('created_at',{ascending:false}).limit(100);
  if(error){ console.error(error); toast('Feed load error'); return; }
  postsCache = data || [];
  renderFeed(postsCache);
}
function renderFeed(posts){
  feedWrap.innerHTML = '';
  // shuffle for variety
  const collection = posts.slice();
  // Keep "shuffle" optional:
  if(window.__shuffleOn) collection.sort(()=>Math.random()-0.5);
  collection.forEach(post => {
    const card = document.createElement('div'); card.className='post-card post-card';
    // media element
    let mediaEl;
    if(post.type === 'youtube' || post.url.includes('youtube.com') || post.url.includes('youtu.be')){
      mediaEl = document.createElement('iframe'); mediaEl.src = post.url.includes('embed') ? post.url : post.url.replace('watch?v=','embed/');
      mediaEl.setAttribute('allow','accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture'); mediaEl.className='post-media';
    } else {
      mediaEl = document.createElement('video'); mediaEl.src = post.url; mediaEl.className='post-media'; mediaEl.setAttribute('playsinline',''); mediaEl.setAttribute('webkit-playsinline','');
      mediaEl.muted = true; mediaEl.loop = true;
    }
    card.appendChild(mediaEl);
    // info
    const info = document.createElement('div'); info.className='post-info';
    info.innerHTML = `<div class="meta"><img class="avatar" src="${post.avatar||'https://placehold.co/80x80?text=U'}" alt=""><div><div class="username">${post.username||'anon'}</div><div class="small-muted">${ago(post.created_at||new Date())}</div></div></div><div class="caption">${(post.caption||'')}</div>`;
    card.appendChild(info);
    // actions
    const actions = document.createElement('div'); actions.className='post-controls';
    actions.innerHTML = `
      <div class="round" data-id="${post.id}" title="Like">‚ù§Ô∏è<div style="font-size:12px;margin-top:4px">${post.likes||0}</div></div>
      <div class="small" data-id="${post.id}" title="Comments">üí¨</div>
      <div class="small" data-id="${post.id}" title="Delete">üóëÔ∏è</div>
    `;
    card.appendChild(actions);

    // comment area (loads comments)
    const commentsWrap = document.createElement('div'); commentsWrap.className='comments';
    card.appendChild(commentsWrap);

    // attach events delegated
    actions.querySelectorAll('.round,.small').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = btn.getAttribute('data-id');
        const txt = btn.textContent.trim();
        if(txt === 'üí¨'){
          // show prompt to comment
          const c = prompt('Add comment');
          if(!c) return;
          const { error } = await supabase.from('comments').insert([{ trend_id: id, user_id: currentUser?.id || null, content: c }]);
          if(error) return toast('Comment error:'+error.message);
          loadFeed();
        } else if(txt === 'üóëÔ∏è'){
          // delete only if owner
          if(!currentUser){ toast('Sign in'); return; }
          // check ownership
          if(currentUser.id !== post.user_id){ toast('Only owner can delete'); return; }
          const { error } = await supabase.from('trends').delete().eq('id', id);
          if(error) toast('Delete error:'+error.message); else { toast('Deleted'); loadFeed(); }
        } else if(txt.includes('‚ù§Ô∏è')){
          // increment likes
          const { data:cur } = await supabase.from('trends').select('likes').eq('id', id).maybeSingle();
          const newLikes = (cur?.likes||0)+1;
          await supabase.from('trends').update({ likes: newLikes }).eq('id', id);
          loadFeed();
        }
      });
    });

    // fetch comments for this post (async)
    (async ()=>{
      const { data: comments } = await supabase.from('comments').select('id,content,created_at').eq('trend_id', post.id).order('created_at',{ascending:true});
      comments?.forEach(c=>{ const div = document.createElement('div'); div.className='comment-item'; div.textContent = c.content; commentsWrap.appendChild(div);});
    })();

    feedWrap.appendChild(card);
  });

  // set up autoplay observer for videos
  if(observer) observer.disconnect();
  const videos = feedWrap.querySelectorAll('video');
  observer = new IntersectionObserver(entries=>{
    entries.forEach(entry=>{
      const v = entry.target;
      if(entry.isIntersecting) v.play().catch(()=>{});
      else v.pause();
    });
  }, { threshold: 0.6 });
  videos.forEach(v => observer.observe(v));
}

// ---------- Real-time subscribe for new trends (optional) ----------
(function subscribeRealtime(){
  try{
    supabase.channel('realtime-trends')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'trends' }, payload => {
        // optional: show toast or reload
        loadFeed();
      })
      .subscribe();
  }catch(err){ console.warn('Realtime not enabled or SDK mismatch', err); }
})();

// ---------- refresh / shuffle ----------
refreshFeedBtn.addEventListener('click', ()=>loadFeed());
shuffleFeedBtn.addEventListener('click', ()=>{ window.__shuffleOn = !window.__shuffleOn; toast('Shuffle ' + (window.__shuffleOn ? 'ON' : 'OFF')); loadFeed(); });

// ---------- init ----------
(async function init(){
  await refreshAuth();
  await loadFeed();
})();

</script>
</body>
</html>
