<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrendTime AI ðŸ”¥</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --white:#ffffff;
  --black:#111111;
  --orange:#ff6a3d;
  --soft-gray:#f5f5f5;
  --muted:#666666;
  --card-bg:#ffffff;
  --card-shadow:rgba(0,0,0,0.1);
  --radius:12px;
}
* {margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body {background: var(--soft-gray); color: var(--black);}
header {
  position: sticky; top:0; width:100%; background: var(--white);
  padding:1rem 2rem; display:flex; justify-content:space-between; align-items:center;
  box-shadow:0 4px 20px var(--card-shadow); z-index:100;
}
header h1 {font-size:1.6rem;font-weight:700;color: var(--black);}
header button {
  background: var(--orange); color: var(--white); border:none;
  padding:0.5rem 1rem; border-radius:999px; cursor:pointer; font-weight:600; transition:0.3s;
}
header button:hover {background:#ff4500;}
main {max-width:900px;margin:2rem auto;padding:0 1rem;}
.feed {display:flex; flex-direction:column; gap:2rem;}
.trend-card {
  background: var(--card-bg); border-radius: var(--radius); padding:1rem;
  box-shadow:0 4px 20px var(--card-shadow); transition: transform 0.3s, box-shadow 0.3s;
}
.trend-card:hover {transform: translateY(-3px); box-shadow:0 10px 25px var(--card-shadow);}
.trend-card img, .trend-card video, .trend-card iframe {width:100%; border-radius: var(--radius); margin-top:0.5rem;}
.trend-info {margin-top:0.5rem;}
.trend-info h3 {color: var(--orange); font-weight:600;}
.trend-info p {color: var(--black);}
.post-btn {
  position:fixed; bottom:2rem; right:2rem; width:70px; height:70px;
  border-radius:50%; background: var(--orange); color: var(--white);
  display:flex; justify-content:center; align-items:center; font-size:2rem;
  cursor:pointer; box-shadow:0 0 25px rgba(255,106,0,0.6); transition:0.3s;
}
.post-btn:hover {transform: scale(1.1);}
.modal-bg {
  position:fixed; top:0; left:0; width:100%; height:100%;
  background: rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; z-index:300;
}
.modal {
  background: var(--white); padding:2rem; border-radius: var(--radius); width:90%; max-width:500px;
  max-height:80vh; overflow-y:auto; position:relative; box-shadow:0 8px 30px rgba(0,0,0,0.15);
}
.modal h2 {margin-bottom:1rem; color: var(--orange);}
.modal input, .modal textarea, .modal button {
  width:100%; margin:0.5rem 0; padding:0.7rem; border-radius:10px; border:1px solid var(--muted);
}
.modal textarea {resize:none;}
.modal button {
  background: var(--orange); color: var(--white); cursor:pointer; font-weight:600; border:none;
  transition: all 0.3s;
}
.modal button:hover {background:#ff4500;}
.close-btn {
  position:absolute; top:1rem; right:1rem; background: var(--orange); color: var(--white);
  width:30px; height:30px; border-radius:50%; display:flex; justify-content:center; align-items:center;
  cursor:pointer; font-weight:bold;
}
#preview video,#preview img {max-height:250px; object-fit:cover;}
</style>
</head>
<body>

<header>
  <h1>TrendTime AI ðŸ”¥</h1>
  <button id="authBtn">Sign In / Sign Up</button>
</header>

<main>
  <div class="feed" id="feed"></div>
</main>

<div class="post-btn" id="postBtn">+</div>

<!-- Login / SignUp Modal -->
<div class="modal-bg" id="loginModalBg">
  <div class="modal">
    <div class="close-btn" id="closeLoginModal">Ã—</div>
    <h2>Sign In / Sign Up</h2>
    <input type="text" id="emailInput" placeholder="Enter your email">
    <button id="magicLinkBtn">Send Magic Link</button>
  </div>
</div>

<!-- Post Modal -->
<div class="modal-bg" id="postModalBg">
  <div class="modal">
    <div class="close-btn" id="closePostModal">Ã—</div>
    <h2>Post a Trend</h2>
    <textarea id="captionInput" placeholder="Caption..."></textarea>
    <input type="text" id="imagePrompt" placeholder="AI Image Prompt (optional)">
    <input type="text" id="videoUrl" placeholder="Video or YouTube link (optional)">
    <div style="display:flex;gap:0.5rem;margin:0.5rem 0;">
      <button id="generateImageBtn" style="flex:1;">ðŸŽ¨ Generate Image</button>
      <button id="recordVideoBtn" style="flex:1;">ðŸŽ¥ Record 5s Video</button>
    </div>
    <div id="preview"></div>
    <button id="postTrendBtn">Post</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl, supabaseKey);

const authBtn = document.getElementById("authBtn");
const loginModalBg = document.getElementById("loginModalBg");
const closeLoginModal = document.getElementById("closeLoginModal");
const postBtn = document.getElementById("postBtn");
const postModalBg = document.getElementById("postModalBg");
const closePostModal = document.getElementById("closePostModal");

const emailInput = document.getElementById("emailInput");
const magicLinkBtn = document.getElementById("magicLinkBtn");
const captionInput = document.getElementById("captionInput");
const imagePrompt = document.getElementById("imagePrompt");
const videoUrl = document.getElementById("videoUrl");
const generateImageBtn = document.getElementById("generateImageBtn");
const recordVideoBtn = document.getElementById("recordVideoBtn");
const postTrendBtn = document.getElementById("postTrendBtn");
const preview = document.getElementById("preview");
const feed = document.getElementById("feed");

let currentUser=null, generatedImage=null, recordedVideoBlob=null, mediaRecorder, recordedBlobs=[];

// Open login modal
authBtn.addEventListener("click",()=>{loginModalBg.style.display="flex";});
closeLoginModal.addEventListener("click",()=>{loginModalBg.style.display="none";});

// Open post modal only if logged in
postBtn.addEventListener("click",()=>{
  if(!currentUser){ alert("Please sign in first."); loginModalBg.style.display="flex"; return;}
  postModalBg.style.display="flex";
});
closePostModal.addEventListener("click",()=>{postModalBg.style.display="none";});

// Magic link
magicLinkBtn.addEventListener("click", async ()=>{
  const email = emailInput.value;
  if(!email) return alert("Enter your email!");
  const {error} = await supabase.auth.signInWithOtp({email, options:{emailRedirectTo:window.location.href}});
  if(error) alert(error.message); else alert("Magic link sent!");
});

// Detect session
async function checkSession(){
  const {data:{session}} = await supabase.auth.getSession();
  if(session){ currentUser=session.user; authBtn.style.display="none";}
}
checkSession();
supabase.auth.onAuthStateChange((_event, session)=>{
  currentUser=session?.user||null;
  authBtn.style.display=currentUser?"none":"inline-block";
});

// Generate AI Image
generateImageBtn.addEventListener("click",()=>{
  const prompt=imagePrompt.value.trim();
  if(!prompt)return alert("Enter a prompt!");
  generatedImage=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  preview.innerHTML=`<img src="${generatedImage}">`;
});

// Record 5s video
recordVideoBtn.addEventListener("click", async ()=>{
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    preview.innerHTML='<video autoplay muted></video>';
    const videoEl = preview.querySelector("video");
    videoEl.srcObject = stream;
    recordedBlobs=[];
    mediaRecorder=new MediaRecorder(stream);
    mediaRecorder.ondataavailable=e=>{if(e.data.size>0)recordedBlobs.push(e.data);}
    mediaRecorder.start();
    setTimeout(()=>mediaRecorder.stop(),5000);
    mediaRecorder.onstop=()=>{
      recordedVideoBlob=new Blob(recordedBlobs,{type:"video/webm"});
      videoEl.srcObject=null;
      videoEl.src=URL.createObjectURL(recordedVideoBlob);
      videoEl.controls=true;
    };
  }catch(e){alert("Camera/mic access denied or unavailable.");}
});

// Post trend
postTrendBtn.addEventListener("click",async ()=>{
  if(!currentUser) return alert("Sign in first!");
  const caption=captionInput.value.trim();
  let url=null, video_url=null, type="text";

  if(generatedImage){
    const resp=await fetch(generatedImage);
    const blob=await resp.blob();
    const filePath=`image-${Date.now()}.png`;
    const {error}=await supabase.storage.from("videos").upload(filePath, blob, {upsert:true});
    if(error) return alert(error.message);
    url=supabase.storage.from("videos").getPublicUrl(filePath).data.publicUrl;
    type="image";
    generatedImage=null;
  }

  if(recordedVideoBlob){
    const filePath=`video-${Date.now()}.webm`;
    const {error}=await supabase.storage.from("videos").upload(filePath, recordedVideoBlob, {upsert:true});
    if(error) return alert(error.message);
    video_url=supabase.storage.from("videos").getPublicUrl(filePath).data.publicUrl;
    type="video";
    recordedVideoBlob=null;
  }

  const ytLink=videoUrl.value.trim();
  if(ytLink) video_url=ytLink;

  const {error}=await supabase.from("trends").insert([{
    user_id:currentUser.id,
    caption,
    url,
    video_url,
    type,
    username:currentUser.email.split("@")[0]
  }]);
  if(error) return alert(error.message);

  captionInput.value=""; imagePrompt.value=""; videoUrl.value=""; preview.innerHTML=""; postModalBg.style.display="none";
  loadFeed();
});

// Load feed
async function loadFeed(){
  const {data,error}=await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); return;}
  feed.innerHTML="";
  data.forEach(trend=>{
    const card=document.createElement("div");
    card.className="trend-card";
    let media='';
    if(trend.type==="image" && trend.url) media=`<img src="${trend.url}">`;
    else if(trend.type==="video" && trend.video_url){
      if(trend.video_url.includes("youtube.com") || trend.video_url.includes("youtu.be")){
        let id=trend.video_url.split("v=")[1]||trend.video_url.split("/").pop();
        media=`<iframe width="100%" height="250" src="https://www.youtube.com/embed/${id}" frameborder="0" allowfullscreen></iframe>`;
      }else{
        media=`<video src="${trend.video_url}" controls></video>`;
      }
    }
    card.innerHTML=media;
    const info=document.createElement("div");
    info.className="trend-info";
    info.innerHTML=`<h3>@${trend.username||"anon"}</h3><p>${trend.caption||""}</p>`;
    card.appendChild(info);
    feed.appendChild(card);
  });
}
loadFeed();
</script>

</body>
</html>
