<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>TrendTime AI âœ¨</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet"/>
<style>
:root {
  --pink:#ff4d8d;
  --orange:#ff914d;
  --white:#fff;
  --bg-gradient: linear-gradient(135deg,var(--pink),var(--orange));
  --card:#fff;
  --shadow:0 4px 12px rgba(0,0,0,0.1);
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:#fefefe;color:#333;}
header{background:var(--bg-gradient);color:white;padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;box-shadow:0 4px 15px rgba(0,0,0,0.2);}
header h1{font-size:1.6rem;}
header button{background:white;color:var(--pink);border:none;padding:0.5rem 1rem;border-radius:25px;font-weight:600;cursor:pointer;transition:0.3s;}
header button:hover{background:var(--orange);color:white;}

main{max-width:700px;margin:2rem auto;padding:0 1rem;}
#auth,#composer,#settings{background:var(--card);border-radius:15px;padding:1rem;margin-bottom:1.5rem;box-shadow:var(--shadow);}
#auth input,#composer input,#composer textarea,#settings input{width:100%;margin:0.5rem 0;padding:0.7rem;border:1px solid #ddd;border-radius:8px;resize:none;}
#auth button,#composer button,#settings button{background:var(--bg-gradient);color:white;border:none;padding:0.7rem 1.2rem;border-radius:8px;font-weight:600;cursor:pointer;margin-top:0.5rem;}
#auth button:hover,#composer button:hover,#settings button:hover{opacity:0.9;}
.feed .trend{background:var(--card);border-radius:15px;margin-bottom:1.2rem;padding:1rem;box-shadow:var(--shadow);}
.feed .trend img,.feed .trend video{max-width:100%;border-radius:10px;margin-top:0.5rem;}
.post-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--card);padding:1rem 1.5rem;border-radius:15px;box-shadow:var(--shadow);display:none;z-index:500;}
.post-popup button{margin-top:0.5rem;}

</style>
</head>
<body>

<header>
  <h1>TrendTime AI âœ¨</h1>
  <div>
    <button id="postBtn">Post</button>
    <button id="signOutBtn" style="display:none;">Sign Out</button>
  </div>
</header>

<main>
  <section id="auth">
    <h2>Sign In / Sign Up</h2>
    <input type="email" id="email" placeholder="Enter your email"/>
    <button id="authBtn">Send Magic Link</button>
    <p style="font-size:0.85rem;color:#666;">We'll send a magic link to your email for authentication.</p>
  </section>

  <section id="composer" style="display:none;">
    <textarea id="captionInput" placeholder="What's trending?"></textarea>
    <input type="text" id="imagePrompt" placeholder="AI Image Prompt..."/>
    <div style="display:flex;gap:0.5rem;margin-top:0.5rem;flex-wrap:wrap;">
      <button id="generateImageBtn">ðŸŽ¨ Generate Image</button>
      <button id="recordVideoBtn">ðŸŽ¥ Record 5s Video</button>
      <button id="suggestCaptionBtn">âœ¨ AI Caption</button>
    </div>
    <div id="preview" style="margin-top:1rem;"></div>
  </section>

  <section class="feed" id="feed"></section>
</main>

<div class="post-popup" id="postPopup">
  <h3>Confirm Post</h3>
  <p id="popupInfo"></p>
  <button id="confirmPostBtn">Post Now</button>
  <button onclick="closePopup()">Cancel</button>
</div>

<!-- Supabase -->
<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl="https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl,supabaseKey);

let currentUser = null;
let generatedImage = null;
let recordedVideoBlob = null;

// AUTH
const authBtn=document.getElementById("authBtn");
const emailInput=document.getElementById("email");
const authSection=document.getElementById("auth");
const composerSection=document.getElementById("composer");
const signOutBtn=document.getElementById("signOutBtn");

authBtn.onclick = async () => {
  const email = emailInput.value.trim();
  if(!email){ alert("Enter your email!"); return; }
  const { data, error } = await supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: window.location.href } });
  if(error){ alert(error.message); return; }
  alert("Magic link sent! Check your email ðŸ“§");
}

// Auto detect session
async function checkSession() {
  const { data:{ session } } = await supabase.auth.getSession();
  if(session){
    currentUser = session.user;
    showComposer();
    loadFeed();
  }
}
supabase.auth.onAuthStateChange((event, session) => {
  if(session){ currentUser=session.user; showComposer(); loadFeed(); }
});
checkSession();

function showComposer(){
  authSection.style.display="none";
  composerSection.style.display="block";
  signOutBtn.style.display="inline-block";
}

// SIGN OUT
signOutBtn.onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
}

// AI Image
const generateImageBtn=document.getElementById("generateImageBtn");
const imagePrompt=document.getElementById("imagePrompt");
const preview=document.getElementById("preview");
generateImageBtn.onclick=()=>{
  const prompt=imagePrompt.value.trim();
  if(!prompt){alert("Enter a prompt!"); return;}
  generatedImage=`https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  preview.innerHTML=`<img src="${generatedImage}" style="width:100%;border-radius:10px;"/>`;
}

// AI Caption
document.getElementById("suggestCaptionBtn").onclick=()=>{
  document.getElementById("captionInput").value="ðŸ”¥ Viral caption suggested by AI!";
}

// Record video
document.getElementById("recordVideoBtn").onclick=async()=>{
  const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  const recorder=new MediaRecorder(stream);
  let chunks=[];
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    recordedVideoBlob=new Blob(chunks,{type:"video/webm"});
    preview.innerHTML=`<video controls src="${URL.createObjectURL(recordedVideoBlob)}"></video>`;
  };
  recorder.start();
  setTimeout(()=>recorder.stop(),5000);
}

// POST POPUP
const postBtn=document.getElementById("postBtn");
const postPopup=document.getElementById("postPopup");
const popupInfo=document.getElementById("popupInfo");
const confirmPostBtn=document.getElementById("confirmPostBtn");

postBtn.onclick = () => {
  const caption=document.getElementById("captionInput").value.trim();
  if(!caption && !generatedImage && !recordedVideoBlob){ alert("Add caption or media!"); return;}
  let info="Caption: "+caption;
  if(generatedImage) info+="\nIncludes Image";
  if(recordedVideoBlob) info+="\nIncludes Video";
  popupInfo.textContent=info;
  postPopup.style.display="block";
}

function closePopup(){ postPopup.style.display="none"; }

confirmPostBtn.onclick = async () => {
  postPopup.style.display="none";
  const caption=document.getElementById("captionInput").value.trim();
  let url=null,type="text";

  if(generatedImage){
    const resp=await fetch(generatedImage);
    const blob=await resp.blob();
    const filePath=`image-${Date.now()}.png`;
    let { error } = await supabase.storage.from("trend-media").upload(filePath,blob,{upsert:true});
    if(error){alert(error.message); return;}
    url=supabase.storage.from("trend-media").getPublicUrl(filePath).data.publicUrl;
    type="image";
    generatedImage=null;
  }

  if(recordedVideoBlob){
    const filePath=`video-${Date.now()}.webm`;
    let { error } = await supabase.storage.from("trend-media").upload(filePath,recordedVideoBlob,{upsert:true});
    if(error){alert(error.message); return;}
    url=supabase.storage.from("trend-media").getPublicUrl(filePath).data.publicUrl;
    type="video";
    recordedVideoBlob=null;
  }

  const { error }=await supabase.from("trends").insert([{user_id:currentUser.id,caption,url,type}]);
  if(error){alert(error.message); return;}
  document.getElementById("captionInput").value="";
  preview.innerHTML="";
  loadFeed();
}

// Load Feed
async function loadFeed(){
  const { data,error }=await supabase.from("trends").select("*").order("id",{ascending:false});
  if(error){console.error(error); return;}
  const feed=document.getElementById("feed");
  feed.innerHTML="";
  data.forEach(trend=>{
    const div=document.createElement("div");
    div.className="trend";
    div.innerHTML=`<strong>${trend.user_id}</strong><p>${trend.caption||""}</p>
      ${trend.type==="image"?`<img src="${trend.url}"/>`:''}
      ${trend.type==="video"?`<video controls src="${trend.url}"></video>`:''}`;
    feed.appendChild(div);
  });
}
</script>
</body>
</html>
