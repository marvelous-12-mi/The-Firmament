<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrendTime AI ðŸ”¥</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --dark: #121212;
  --primary: #ff6a3d;
  --secondary: #ffcc00;
  --accent: #00d4ff;
  --card: #1e1e1e;
  --text: #ffffff;
  --text-muted: #bbbbbb;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{background:var(--dark);color:var(--text);}
header{position:sticky;top:0;width:100%;background:linear-gradient(90deg,var(--primary),var(--secondary));padding:1rem 2rem;display:flex;justify-content:space-between;align-items:center;z-index:100;}
header h1{font-size:1.6rem;font-weight:700;}
header button{background:var(--text);color:var(--dark);border:none;padding:0.5rem 1rem;border-radius:999px;cursor:pointer;font-weight:600;transition:0.3s;}
header button:hover{background:var(--accent);color:var(--dark);}
main{max-width:800px;margin:2rem auto;padding:0 1rem;}
.feed{display:flex;flex-direction:column;gap:2rem;}
.trend-card{background:var(--card);border-radius:15px;padding:1rem;box-shadow:0 4px 20px rgba(0,0,0,0.6);transition:0.3s;}
.trend-card:hover{transform:scale(1.02);}
.trend-card img,.trend-card video{width:100%;border-radius:12px;margin-top:0.5rem;}
.trend-info{margin-top:0.5rem;}
.trend-info h3{color:var(--primary);}
.trend-info p{color:var(--text-muted);}
.post-btn{position:fixed;bottom:2rem;right:2rem;width:70px;height:70px;border-radius:50%;background:linear-gradient(145deg,var(--secondary),var(--primary));color:var(--dark);display:flex;justify-content:center;align-items:center;font-size:2rem;cursor:pointer;box-shadow:0 0 25px rgba(255,255,0,0.8);z-index:200;transition:0.3s;}
.post-btn:hover{transform:scale(1.1);}
.modal-bg{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:300;}
.modal{background:var(--card);padding:2rem;border-radius:15px;width:90%;max-width:500px;max-height:80vh;overflow-y:auto;position:relative;}
.modal h2{margin-bottom:1rem;color:var(--accent);}
.modal input, .modal textarea, .modal button{width:100%;margin:0.5rem 0;padding:0.7rem;border-radius:10px;border:none;}
.modal textarea{resize:none;}
.modal button{background:linear-gradient(145deg,var(--primary),var(--secondary));color:var(--dark);cursor:pointer;font-weight:600;}
.close-btn{position:absolute;top:1rem;right:1rem;background:var(--accent);color:var(--dark);width:30px;height:30px;border-radius:50%;display:flex;justify-content:center;align-items:center;cursor:pointer;font-weight:bold;}
</style>
</head>
<body>

<header>
  <h1>TrendTime AI ðŸ”¥</h1>
  <button id="authBtn">Sign In / Sign Up</button>
</header>

<main>
  <div class="feed" id="feed"></div>
</main>

<div class="post-btn" id="postBtn">+</div>

<div class="modal-bg" id="modalBg">
  <div class="modal">
    <div class="close-btn" id="closeModal">Ã—</div>
    <h2>Post a Trend</h2>
    <input type="text" id="emailInput" placeholder="Email">
    <input type="password" id="passwordInput" placeholder="Password (optional for magic link)">
    <textarea id="captionInput" placeholder="Caption..."></textarea>
    <input type="text" id="imagePrompt" placeholder="AI Image Prompt (optional)">
    <button id="magicLinkBtn">Send Magic Link / Sign In</button>
    <button id="generateImageBtn">ðŸŽ¨ Generate Image</button>
    <button id="recordVideoBtn">ðŸŽ¥ Record 5s Video</button>
    <div id="preview"></div>
    <button id="postTrendBtn">Post</button>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabaseUrl = "https://kpdgmbjdaynplyjacuxd.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ";
const supabase = createClient(supabaseUrl, supabaseKey);

const authBtn = document.getElementById("authBtn");
const modalBg = document.getElementById("modalBg");
const closeModal = document.getElementById("closeModal");
const postBtn = document.getElementById("postBtn");
const magicLinkBtn = document.getElementById("magicLinkBtn");
const emailInput = document.getElementById("emailInput");
const passwordInput = document.getElementById("passwordInput");
const captionInput = document.getElementById("captionInput");
const imagePrompt = document.getElementById("imagePrompt");
const preview = document.getElementById("preview");
const generateImageBtn = document.getElementById("generateImageBtn");
const recordVideoBtn = document.getElementById("recordVideoBtn");
const postTrendBtn = document.getElementById("postTrendBtn");
const feed = document.getElementById("feed");

let currentUser = null;
let generatedImage = null;
let recordedVideoBlob = null;
let mediaRecorder, recordedBlobs = [];

// Modal toggle
postBtn.addEventListener("click", ()=>{ modalBg.style.display = "flex"; });
closeModal.addEventListener("click", ()=>{ modalBg.style.display = "none"; });

// Magic link sign-in/up
magicLinkBtn.addEventListener("click", async ()=>{
  const email = emailInput.value;
  if(!email) return alert("Enter your email!");
  const { error } = await supabase.auth.signInWithOtp({ email, options:{emailRedirectTo:window.location.href} });
  if(error) alert(error.message);
  else alert("Magic link sent! Check your email.");
});

// Detect session
async function checkSession(){
  const { data:{ session } } = await supabase.auth.getSession();
  if(session){
    currentUser = session.user;
    authBtn.style.display="none";
  }
}
checkSession();
supabase.auth.onAuthStateChange((_event, session)=>{
  currentUser = session?.user || null;
  if(currentUser) authBtn.style.display="none";
});

// Generate AI Image in-page
generateImageBtn.addEventListener("click", ()=>{
  const prompt = imagePrompt.value.trim();
  if(!prompt) return alert("Enter a prompt!");
  generatedImage = `https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}`;
  preview.innerHTML = `<img src="${generatedImage}" style="width:100%;border-radius:12px;">`;
});

// Record 5s video
recordVideoBtn.addEventListener("click", async ()=>{
  const stream = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
  preview.innerHTML = `<video autoplay muted></video>`;
  const videoEl = preview.querySelector("video");
  videoEl.srcObject = stream;
  recordedBlobs = [];
  mediaRecorder = new MediaRecorder(stream);
  mediaRecorder.ondataavailable = e => { if(e.data.size>0) recordedBlobs.push(e.data); };
  mediaRecorder.start();
  setTimeout(()=>mediaRecorder.stop(),5000);
  mediaRecorder.onstop = ()=>{
    recordedVideoBlob = new Blob(recordedBlobs,{type:"video/webm"});
    videoEl.srcObject = null;
    videoEl.src = URL.createObjectURL(recordedVideoBlob);
    videoEl.controls = true;
  };
});

// Post trend
postTrendBtn.addEventListener("click", async ()=>{
  if(!currentUser) return alert("Sign in first!");
  const caption = captionInput.value.trim();
  let url=null, video_url=null, type="text";

  // Upload image
  if(generatedImage){
    const resp = await fetch(generatedImage);
    const blob = await resp.blob();
    const filePath = `image-${Date.now()}.png`;
    const { error } = await supabase.storage.from("videos").upload(filePath, blob, {upsert:true});
    if(error) return alert(error.message);
    url = supabase.storage.from("videos").getPublicUrl(filePath).data.publicUrl;
    type="image";
    generatedImage=null;
  }

  // Upload video
  if(recordedVideoBlob){
    const filePath = `video-${Date.now()}.webm`;
    const { error } = await supabase.storage.from("videos").upload(filePath, recordedVideoBlob, {upsert:true});
    if(error) return alert(error.message);
    video_url = supabase.storage.from("videos").getPublicUrl(filePath).data.publicUrl;
    type="video";
    recordedVideoBlob=null;
  }

  const { error } = await supabase.from("trends").insert([{
    user_id: currentUser.id,
    caption,
    url,
    video_url,
    type,
    username: currentUser.email.split("@")[0]
  }]);
  if(error) return alert(error.message);
  captionInput.value=""; imagePrompt.value=""; preview.innerHTML="";
  modalBg.style.display="none";
  loadFeed();
});

// Load feed
async function loadFeed(){
  const { data, error } = await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error){console.error(error); return;}
  feed.innerHTML="";
  data.forEach(trend=>{
    const card = document.createElement("div");
    card.className="trend-card";
    if(trend.type==="image" && trend.url) card.innerHTML = `<img src="${trend.url}">`;
    if(trend.type==="video" && trend.video_url) card.innerHTML = `<video src="${trend.video_url}" controls></video>`;
    const info = document.createElement("div");
    info.className="trend-info";
    info.innerHTML = `<h3>@${trend.username||"anon"}</h3><p>${trend.caption||""}</p>`;
    card.appendChild(info);
    feed.appendChild(card);
  });
}
loadFeed();
</script>

</body>
</html>
