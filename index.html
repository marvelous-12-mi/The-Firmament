<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TrendTime üî•</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --pink: #ff1f71;
  --orange: #ff6a00;
  --purple: #8a2be2;
  --dark: #0f0f0f;
  --card: #1b1b1b;
  --text: #fff;
  --gray: #aaa;
}

* { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
body { background:var(--dark); color:var(--text); overflow-x:hidden; }

header {
  position: sticky; top:0; width:100%; display:flex; justify-content:space-between; align-items:center;
  padding:1rem 1.2rem; background:linear-gradient(90deg,var(--pink),var(--orange)); box-shadow:0 4px 20px rgba(0,0,0,0.6); z-index:100;
}
header h1 { font-size:1.6rem; font-weight:700; }
header button { background:white; color:var(--dark); border:none; padding:0.5rem 1rem; border-radius:999px; font-weight:600; transition:0.3s; }
header button:hover { background:var(--pink); color:white; }

/* Side Panel */
.side-panel {
  position: fixed; top:0; left:-280px; width:260px; height:100vh; background:var(--card);
  box-shadow:5px 0 20px rgba(0,0,0,0.6); transition:left 0.3s ease; padding:2rem 1rem; z-index:200;
  overflow-y:auto;
}
.side-panel.active { left:0; }
.side-panel h2,h3 { margin-bottom:0.8rem; color:var(--pink); }
.side-panel p { margin-bottom:1rem; color:var(--gray); }
.side-panel input { width:100%; margin:0.5rem 0; padding:0.5rem; border-radius:8px; border:1px solid var(--gray); background: rgba(255,255,255,0.05); color:white; }
.side-panel button { margin-top:0.5rem; width:100%; padding:0.6rem; border:none; border-radius:10px; font-weight:600; background:linear-gradient(90deg,var(--orange),var(--pink)); color:white; transition:0.3s; }
.side-panel button:hover { box-shadow:0 0 15px var(--pink); }

/* Feed */
.feed { display:flex; flex-direction:column; gap:1.5rem; padding:1rem; scroll-snap-type:y mandatory; overflow-y: scroll; height:calc(100vh - 70px); }
.trend-card { background:var(--card); border-radius:16px; overflow:hidden; position:relative; scroll-snap-align:start; box-shadow:0 0 30px rgba(255,106,0,0.2); display:flex; flex-direction:column; }
.trend-card video,.trend-card iframe { width:100%; height:60vh; object-fit:cover; border-radius:16px; }
.trend-info { padding:0.8rem 1rem; }
.trend-info h2 { font-size:1.2rem; margin-bottom:0.3rem; }
.trend-info p { color:var(--gray); font-size:0.9rem; }
.trend-actions { display:flex; gap:0.8rem; padding:0.5rem 1rem; }
.action-btn { flex:1; padding:0.6rem; border-radius:12px; text-align:center; background:linear-gradient(145deg,var(--pink),var(--orange)); font-weight:700; cursor:pointer; transition:0.2s; }
.action-btn:hover { transform:scale(1.05); }

/* Floating Post Button */
.post-btn {
  position: fixed; bottom:2rem; left:50%; transform:translateX(-50%);
  background:linear-gradient(145deg,var(--pink),var(--orange)); color:white; font-size:1.6rem; width:70px; height:70px; border-radius:50%;
  display:flex; justify-content:center; align-items:center; box-shadow:0 0 25px rgba(255,30,100,0.9); cursor:pointer; animation:pulse 2s infinite; z-index:200;
}
@keyframes pulse {0% {box-shadow:0 0 15px rgba(255,106,0,0.6);}50% {box-shadow:0 0 35px rgba(255,30,100,1);}100% {box-shadow:0 0 15px rgba(255,106,0,0.6);}}

/* Recorder */
#recorderPreview { width:100%; border-radius:12px; margin-top:0.5rem; display:none; }

/* Auth Modal */
.auth-modal { position:fixed; inset:0; display:flex; justify-content:center; align-items:center; background:rgba(0,0,0,0.85); z-index:300; display:none; }
.auth-content { background:var(--card); padding:2rem; border-radius:16px; width:320px; display:flex; flex-direction:column; gap:1rem; }
.auth-content h3 { text-align:center; font-weight:700; color:var(--pink); font-size:1.3rem; }
.auth-content input { padding:0.8rem; border-radius:10px; border:1px solid var(--gray); background:rgba(255,255,255,0.05); color:white; }
.auth-content button { padding:0.8rem; border-radius:12px; border:none; font-weight:700; background:linear-gradient(90deg,var(--orange),var(--pink)); color:white; }
.auth-content button:hover { box-shadow:0 0 20px var(--pink); }

/* Footer */
footer { text-align:center; padding:1.5rem; font-size:0.85rem; color:var(--gray); }
</style>
</head>
<body>

<header>
  <button id="menuBtn">‚ò∞</button>
  <h1>üî• TrendTime</h1>
  <button id="authBtn">Sign In / Sign Up</button>
</header>

<div class="side-panel" id="sidePanel">
  <h2>Welcome</h2>
  <p id="userEmail">Not logged in</p>
  <button id="logoutBtn" style="display:none;">Logout</button>

  <h3>Post Trend</h3>
  <input id="postUrl" type="text" placeholder="Video/Youtube URL">
  <input id="postCaption" type="text" placeholder="Caption">
  <button id="postSubmit">Post</button>

  <h3>Record Video</h3>
  <video id="recorderPreview" controls muted></video>
  <button id="startRecordingBtn">üé• Start Recording</button>
  <button id="stopRecordingBtn" style="display:none;">‚èπÔ∏è Stop & Upload</button>
</div>

<main class="feed" id="feed"></main>
<div class="post-btn" id="postBtn">‚ûï</div>

<div class="auth-modal" id="authModal">
  <div class="auth-content">
    <h3>Sign In / Sign Up</h3>
    <input type="email" id="authEmail" placeholder="Email">
    <input type="password" id="authPassword" placeholder="Password">
    <button id="signUpBtn">Sign Up</button>
    <button id="signInBtn">Sign In</button>
    <button id="closeAuthBtn" style="background:#333;">Close</button>
  </div>
</div>

<footer>&copy; 2025 TrendTime ‚ö°</footer>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabaseUrl='https://kpdgmbjdaynplyjacuxd.supabase.co';
const supabaseKey='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwZGdtYmpkYXlucGx5amFjdXhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNjA3MjMsImV4cCI6MjA3NDczNjcyM30.ZJM2v_5VES_AlHAAV4lHaIID7v3IBEbFUgFEcs4yOYQ';
const supabase=createClient(supabaseUrl,supabaseKey);

// Elements
const menuBtn=document.getElementById("menuBtn");
const sidePanel=document.getElementById("sidePanel");
const authBtn=document.getElementById("authBtn");
const logoutBtn=document.getElementById("logoutBtn");
const userEmail=document.getElementById("userEmail");
const feed=document.getElementById("feed");
const postBtn=document.getElementById("postBtn");
const postUrl=document.getElementById("postUrl");
const postCaption=document.getElementById("postCaption");
const postSubmit=document.getElementById("postSubmit");
const authModal=document.getElementById("authModal");
const closeAuthBtn=document.getElementById("closeAuthBtn");
const signUpBtn=document.getElementById("signUpBtn");
const signInBtn=document.getElementById("signInBtn");
const authEmail=document.getElementById("authEmail");
const authPassword=document.getElementById("authPassword");
const startRecordingBtn=document.getElementById("startRecordingBtn");
const stopRecordingBtn=document.getElementById("stopRecordingBtn");
const recorderPreview=document.getElementById("recorderPreview");

let mediaRecorder, recordedChunks=[];

// Menu toggle
menuBtn.addEventListener("click",()=>sidePanel.classList.toggle("active"));
postBtn.addEventListener("click",()=>sidePanel.classList.toggle("active"));
document.addEventListener("click",(e)=>{
  if(sidePanel.classList.contains("active")&&!sidePanel.contains(e.target)&&e.target!==menuBtn&&e.target!==postBtn){
    sidePanel.classList.remove("active");
  }
});

// Auth Modal
authBtn.addEventListener("click",()=>authModal.style.display="flex");
closeAuthBtn.addEventListener("click",()=>authModal.style.display="none");

// Sign Up
signUpBtn.addEventListener("click",async()=>{
  const email=authEmail.value.trim(), password=authPassword.value.trim();
  if(!email||!password)return alert("Enter email & password");
  const { error }=await supabase.auth.signUp({ email,password });
  if(error)return alert("Sign Up error: "+error.message);
  alert("‚úÖ Sign Up successful! Check email."); authModal.style.display="none";
});

// Sign In
signInBtn.addEventListener("click",async()=>{
  const email=authEmail.value.trim(), password=authPassword.value.trim();
  if(!email||!password)return alert("Enter email & password");
  const { error }=await supabase.auth.signInWithPassword({ email,password });
  if(error)return alert("Sign In error: "+error.message);
  authModal.style.display="none";
});

// Logout
logoutBtn.addEventListener("click",async()=>{
  await supabase.auth.signOut(); updateUserUI(null);
});

// Update UI
async function updateUserUI(session){
  if(session?.user){ userEmail.textContent=session.user.email; authBtn.style.display="none"; logoutBtn.style.display="block"; }
  else{ userEmail.textContent="Not logged in"; authBtn.style.display="block"; logoutBtn.style.display="none"; }
}
supabase.auth.onAuthStateChange((_event,session)=>updateUserUI(session));
(async()=>{ const { data:{ session } }=await supabase.auth.getSession(); updateUserUI(session); })();

// Load Feed
async function loadFeed(){
  const { data,error }=await supabase.from("trends").select("*").order("created_at",{ascending:false});
  if(error)return console.error(error.message);
  feed.innerHTML="";
  data.forEach(post=>{
    const card=document.createElement("div"); card.className="trend-card";
    let media;
    if(post.type==="youtube"){ media=document.createElement("iframe"); media.src=post.url; media.allowFullscreen=true; }
    else{ media=document.createElement("video"); media.src=post.url; media.autoplay=true; media.loop=true; media.muted=true; }
    card.appendChild(media);
    const info=document.createElement("div"); info.className="trend-info";
    info.innerHTML=`<h2>@${post.username||"anon"}</h2><p>${post.caption||""}</p>`;
    card.appendChild(info);
    const actions=document.createElement("div"); actions.className="trend-actions";
    actions.innerHTML=`<div class="action-btn">‚ù§Ô∏è</div><div class="action-btn">üí¨</div><div class="action-btn">üîó</div>`;
    card.appendChild(actions);
    feed.appendChild(card);
  });
  const videos=document.querySelectorAll(".trend-card video");
  const observer=new IntersectionObserver(entries=>entries.forEach(e=>{if(e.isIntersecting)e.target.play().catch(()=>{}); else e.target.pause();}),{threshold:0.6});
  videos.forEach(v=>observer.observe(v));
}
loadFeed();

// Post submit
postSubmit.addEventListener("click",async()=>{
  const { data:{ session } }=await supabase.auth.getSession();
  if(!session)return alert("Login to post!");
  const url=postUrl.value.trim(), caption=postCaption.value.trim();
  if(!url)return alert("Enter URL");
  const type=url.includes("youtube.com")?"youtube":"video";
  const { error }=await supabase.from("trends").insert([{ url, caption, type, username: session.user.email.split("@")[0] }]);
  if(error)return alert(error.message);
  postUrl.value=""; postCaption.value=""; loadFeed();
});

// Recording
startRecordingBtn.addEventListener("click",async()=>{
  try{
    const stream=await navigator.mediaDevices.getUserMedia({ video:true,audio:true });
    recorderPreview.srcObject=stream; recorderPreview.style.display="block";
    recordedChunks=[]; mediaRecorder=new MediaRecorder(stream);
    mediaRecorder.ondataavailable=e=>{ if(e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.start();
    startRecordingBtn.style.display="none"; stopRecordingBtn.style.display="block";
  }catch(err){ alert("Camera/mic access denied: "+err.message); }
});

stopRecordingBtn.addEventListener("click",async()=>{
  mediaRecorder.stop(); stopRecordingBtn.style.display="none"; startRecordingBtn.style.display="block";
  mediaRecorder.onstop=async()=>{
    const blob=new Blob(recordedChunks,{ type:"video/mp4" });
    const fileName=`trend_${Date.now()}.mp4`;
    const file=new File([blob],fileName,{ type:"video/mp4" });
    const { data:{ session } }=await supabase.auth.getSession();
    if(!session?.user)return alert("Login first!");
    const { data, error:uploadError }=await supabase.storage.from("videos").upload(fileName,file);
    if(uploadError)return alert("Upload error: "+uploadError.message);
    const { data: urlData }=supabase.storage.from("videos").getPublicUrl(fileName);
    const { error: dbError }=await supabase.from("trends").insert([{ url: urlData.publicUrl, type:"video", username: session.user.email.split("@")[0], caption:"New recorded trend" }]);
    if(dbError)return alert(dbError.message);
    recorderPreview.srcObject=null; recorderPreview.style.display="none"; loadFeed();
    alert("‚úÖ Video uploaded!");
  };
});
</script>
</body>
</html>
